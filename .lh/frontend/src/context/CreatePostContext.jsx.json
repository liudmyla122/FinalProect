{
    "sourceFile": "frontend/src/context/CreatePostContext.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1769703025091,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1770725360207,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,77 +22,8 @@\n   const [createError, setCreateError] = useState('')\n   const [createLoading, setCreateLoading] = useState(false)\n   const MAX_IMAGES = 5\n \n-  const loadUserWithAvatar = async () => {\n-    try {\n-      console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞–≤–∞—Ç–∞—Ä–æ–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞...')\n-      \n-      const serverUserResponse = await authAPI.getCurrentUser()\n-      if (serverUserResponse?.user) {\n-        const serverUser = serverUserResponse.user\n-        \n-        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å\n-        const activeId = localStorage.getItem('activeProfileId')\n-        if (activeId && serverUser.profiles?.length > 0) {\n-          const activeProfile = serverUser.profiles.find(p => String(p.id) === String(activeId))\n-          if (activeProfile) {\n-            console.log('‚úÖ –ù–∞–π–¥–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:', activeProfile.username)\n-            \n-            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä –ø—Ä–æ—Ñ–∏–ª—è\n-            const avatarFromStorage = localStorage.getItem(`profile_avatar_${activeId}`)\n-            const avatar = avatarFromStorage || activeProfile.avatar || ''\n-            const avatarType = activeProfile.avatarType || (avatar?.startsWith?.('data:video/') ? 'video' : 'image')\n-            \n-            setUser({\n-              ...activeProfile,\n-              avatar,\n-              avatarType,\n-              dbId: serverUser.id,\n-              activeProfileId: activeId,\n-              isActiveProfile: true\n-            })\n-            return\n-          }\n-        }\n-        \n-        // Fallback –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n-        let avatar = serverUser.avatar && typeof serverUser.avatar === 'string' && serverUser.avatar.trim().length > 0 ? serverUser.avatar : null\n-        let avatarType = serverUser.avatarType || (avatar?.startsWith?.('data:video/') ? 'video' : 'image')\n-        \n-        setUser({\n-          ...serverUser,\n-          avatar: avatar || serverUser.avatar || '',\n-          avatarType,\n-        })\n-        return\n-      }\n-    } catch (error) {\n-      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', error)\n-    }\n-    \n-    // Fallback –Ω–∞ localStorage\n-    try {\n-      const stored = localStorage.getItem('user')\n-      if (stored) {\n-        const parsedUser = JSON.parse(stored)\n-        const activeId = parsedUser.activeProfileId || localStorage.getItem('activeProfileId')\n-        \n-        if (activeId) {\n-          const avatarFromStorage = localStorage.getItem(`profile_avatar_${activeId}`)\n-          if (avatarFromStorage) {\n-            parsedUser.avatar = avatarFromStorage\n-            parsedUser.avatarType = parsedUser.avatarType || (avatarFromStorage.startsWith('data:video/') ? 'video' : 'image')\n-          }\n-        }\n-        \n-        setUser(parsedUser)\n-      }\n-    } catch (error) {\n-      console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage:', error)\n-    }\n-  }\n-\n   const getActiveProfileForModal = () => {\n     try {\n       const activeId = localStorage.getItem('activeProfileId')\n       if (!activeId) {\n@@ -157,8 +88,95 @@\n       return null\n     }\n   }\n \n+  const loadUserWithAvatar = async () => {\n+    try {\n+      console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞–≤–∞—Ç–∞—Ä–æ–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞...')\n+      \n+      const serverUserResponse = await authAPI.getCurrentUser()\n+      if (serverUserResponse?.user) {\n+        const serverUser = serverUserResponse.user\n+        \n+        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å\n+        const activeId = localStorage.getItem('activeProfileId')\n+        if (activeId) {\n+          // 1. –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø—Ä–æ—Ñ–∏–ª—å –≤ –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞\n+          if (serverUser.profiles?.length > 0) {\n+            const activeProfile = serverUser.profiles.find(p => String(p.id) === String(activeId))\n+            if (activeProfile) {\n+              console.log('‚úÖ –ù–∞–π–¥–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:', activeProfile.username)\n+              \n+              // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä –ø—Ä–æ—Ñ–∏–ª—è\n+              const avatarFromStorage = localStorage.getItem(`profile_avatar_${activeId}`)\n+              const avatar = avatarFromStorage || activeProfile.avatar || ''\n+              const avatarType = activeProfile.avatarType || (avatar?.startsWith?.('data:video/') ? 'video' : 'image')\n+              \n+              setUser({\n+                ...activeProfile,\n+                avatar,\n+                avatarType,\n+                dbId: serverUser.id,\n+                activeProfileId: activeId,\n+                isActiveProfile: true\n+              })\n+              return\n+            }\n+          }\n+          \n+          // 2. –ï—Å–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω (—Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω), –∏—â–µ–º –ª–æ–∫–∞–ª—å–Ω–æ\n+          // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è\n+          const localProfile = getActiveProfileForModal()\n+          if (localProfile) {\n+             console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (–Ω–µ –Ω–∞–π–¥–µ–Ω –≤ serverUser.profiles)')\n+             setUser(localProfile)\n+             return\n+          }\n+        }\n+        \n+        // Fallback –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n+        let avatar = serverUser.avatar && typeof serverUser.avatar === 'string' && serverUser.avatar.trim().length > 0 ? serverUser.avatar : null\n+        let avatarType = serverUser.avatarType || (avatar?.startsWith?.('data:video/') ? 'video' : 'image')\n+        \n+        setUser({\n+          ...serverUser,\n+          avatar: avatar || serverUser.avatar || '',\n+          avatarType,\n+        })\n+        return\n+      }\n+    } catch (error) {\n+      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', error)\n+    }\n+    \n+    // Fallback –Ω–∞ localStorage\n+    try {\n+      const activeProfile = getActiveProfileForModal()\n+      if (activeProfile) {\n+        setUser(activeProfile)\n+        return\n+      }\n+\n+      const stored = localStorage.getItem('user')\n+      if (stored) {\n+        const parsedUser = JSON.parse(stored)\n+        const activeId = parsedUser.activeProfileId || localStorage.getItem('activeProfileId')\n+        \n+        if (activeId) {\n+          const avatarFromStorage = localStorage.getItem(`profile_avatar_${activeId}`)\n+          if (avatarFromStorage) {\n+            parsedUser.avatar = avatarFromStorage\n+            parsedUser.avatarType = parsedUser.avatarType || (avatarFromStorage.startsWith('data:video/') ? 'video' : 'image')\n+          }\n+        }\n+        \n+        setUser(parsedUser)\n+      }\n+    } catch (error) {\n+      console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage:', error)\n+    }\n+  }\n+\n   useEffect(() => {\n     loadUserWithAvatar()\n   }, [])\n \n"
                },
                {
                    "date": 1770725692060,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -37,13 +37,12 @@\n       let profile = null\n       const userRaw = localStorage.getItem('user')\n       if (userRaw) {\n         const parsed = JSON.parse(userRaw)\n-        if (\n-          parsed &&\n-          (String(parsed.id) === String(activeId) ||\n-            String(parsed.activeProfileId) === String(activeId))\n-        ) {\n+        // –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage.user –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∏—Ö ID —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å activeId.\n+        // –†–∞–Ω–µ–µ —É—Å–ª–æ–≤–∏–µ || String(parsed.activeProfileId) === String(activeId) –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —Ç–æ–º—É,\n+        // —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–ª—Å—è –æ–±—ä–µ–∫—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (parsed), –¥–∞–∂–µ –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–º –±—ã–ª –¥—Ä—É–≥–æ–π –ø—Ä–æ—Ñ–∏–ª—å.\n+        if (parsed && String(parsed.id) === String(activeId)) {\n           profile = parsed\n           console.log('‚úÖ –ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ñ–∏–ª—å –≤ user localStorage')\n         }\n       }\n"
                }
            ],
            "date": 1769703025091,
            "name": "Commit-0",
            "content": "import { createContext, useContext, useEffect, useState } from 'react';\nimport { postsAPI, authAPI } from '../services/api';\nimport { setUserToLocalStorage } from '../utils/storage';\nimport '../pages/Home/Home.css';\n\nconst CreatePostContext = createContext(null);\n\nconst defaultCreatePostValue = { open: () => {}, close: () => {} };\n\nexport const useCreatePost = () => useContext(CreatePostContext) ?? defaultCreatePostValue;\n\nexport const CreatePostProvider = ({ children }) => {\n  const [isOpen, setIsOpen] = useState(false);\n  const [user, setUser] = useState(null);\n  const [selectedFiles, setSelectedFiles] = useState([]); \n  const [previewUrls, setPreviewUrls] = useState([]); \n  const [currentImageIndex, setCurrentImageIndex] = useState(0); \n  const [title, setTitle] = useState('');\n  const [caption, setCaption] = useState('');\n  const [createError, setCreateError] = useState('');\n  const [createLoading, setCreateLoading] = useState(false);\n  const MAX_IMAGES = 5; \n\n  \n  const loadUserWithAvatar = async () => {\n    try {\n      const serverUserResponse = await authAPI.getCurrentUser();\n      if (serverUserResponse?.user) {\n        const serverUser = serverUserResponse.user;\n        let avatar = serverUser.avatar && typeof serverUser.avatar === 'string' && serverUser.avatar.trim().length > 0\n          ? serverUser.avatar\n          : null;\n        let avatarType = serverUser.avatarType || (avatar?.startsWith?.('data:video/') ? 'video' : 'image');\n        if (!avatar) {\n          const stored = localStorage.getItem('user');\n          const activeId = serverUser.id || localStorage.getItem('activeProfileId');\n          if (activeId) {\n            const fromStorage = localStorage.getItem(`profile_avatar_${activeId}`);\n            if (fromStorage) {\n              avatar = fromStorage;\n              avatarType = fromStorage.startsWith('data:video/') ? 'video' : 'image';\n            }\n          }\n          if (!avatar && stored) {\n            try {\n              const parsed = JSON.parse(stored);\n              if (parsed.avatar) {\n                avatar = parsed.avatar;\n                avatarType = parsed.avatarType || (avatar.startsWith('data:video/') ? 'video' : 'image');\n              }\n            } catch (e) {  }\n          }\n        }\n        setUser({\n          ...serverUser,\n          avatar: avatar || serverUser.avatar || '',\n          avatarType,\n        });\n        return;\n      }\n    } catch (error) {\n      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', error);\n    }\n    try {\n      const stored = localStorage.getItem('user');\n      if (stored) {\n        const parsedUser = JSON.parse(stored);\n        const activeId = parsedUser.id || localStorage.getItem('activeProfileId');\n        if (activeId) {\n          const avatarFromStorage = localStorage.getItem(`profile_avatar_${activeId}`);\n          if (avatarFromStorage) {\n            parsedUser.avatar = avatarFromStorage;\n            parsedUser.avatarType = parsedUser.avatarType || (avatarFromStorage.startsWith('data:video/') ? 'video' : 'image');\n          }\n        }\n        setUser(parsedUser);\n      }\n    } catch (error) {\n      console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage:', error);\n    }\n  };\n\n  useEffect(() => {\n    loadUserWithAvatar();\n  }, []);\n\n  const open = async () => {\n    \n    await loadUserWithAvatar();\n    setIsOpen(true);\n  };\n\n  const close = () => {\n    setIsOpen(false);\n    setSelectedFiles([]);\n    setPreviewUrls([]);\n    setCurrentImageIndex(0);\n    setTitle('');\n    setCaption('');\n    setCreateError('');\n    setCreateLoading(false);\n    \n    \n    previewUrls.forEach(url => {\n      if (url.startsWith('blob:')) {\n        URL.revokeObjectURL(url);\n      }\n    });\n  };\n\n  const handleFileChange = (e) => {\n    const files = Array.from(e.target.files || []);\n    if (files.length === 0) return;\n\n    const imageFiles = files.filter(file => file.type.startsWith('image/'));\n    const videoFiles = files.filter(file => file.type.startsWith('video/'));\n\n    \n    if (videoFiles.length > 0) {\n      const video = videoFiles[0];\n      const MAX_SIZE_MB = 1024 * 1024;\n      const maxBytes = MAX_SIZE_MB * 1024 * 1024;\n      if (video.size > maxBytes) {\n        setCreateError(`–í–∏–¥–µ–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å–∏–º—É–º 1 –¢–ë): ${video.name}`);\n        e.target.value = '';\n        return;\n      }\n      setSelectedFiles([video]);\n      setPreviewUrls([URL.createObjectURL(video)]);\n      setCurrentImageIndex(0);\n      setCreateError('');\n      e.target.value = '';\n      return;\n    }\n\n    \n    if (imageFiles.length === 0) {\n      setCreateError('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ (–¥–æ 5 —Ñ–æ—Ç–æ –∏–ª–∏ 1 –≤–∏–¥–µ–æ).');\n      e.target.value = '';\n      return;\n    }\n\n    const currentCount = selectedFiles.length;\n    const remainingSlots = MAX_IMAGES - currentCount;\n    if (imageFiles.length > remainingSlots) {\n      setCreateError(`–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞–∫—Å–∏–º—É–º ${MAX_IMAGES} —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π. –£ –≤–∞—Å —É–∂–µ ${currentCount}, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë ${remainingSlots}.`);\n      e.target.value = '';\n      return;\n    }\n\n    const MAX_SIZE_MB = 1024 * 1024;\n    const maxBytes = MAX_SIZE_MB * 1024 * 1024;\n    const validFiles = imageFiles.filter(file => file.size <= maxBytes);\n    const invalidFiles = imageFiles.filter(file => file.size > maxBytes);\n\n    if (invalidFiles.length > 0) {\n      setCreateError(`–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ (–º–∞–∫—Å–∏–º—É–º 1 –¢–ë): ${invalidFiles.map(f => f.name).join(', ')}`);\n    }\n    if (validFiles.length === 0) {\n      e.target.value = '';\n      return;\n    }\n\n    const newFiles = [...selectedFiles, ...validFiles].slice(0, MAX_IMAGES);\n    const newPreviewUrls = [...previewUrls, ...validFiles.map(f => URL.createObjectURL(f))].slice(0, MAX_IMAGES);\n    setSelectedFiles(newFiles);\n    setPreviewUrls(newPreviewUrls);\n    setCurrentImageIndex(newFiles.length - 1);\n    setCreateError('');\n    e.target.value = '';\n  };\n\n  const handleRemoveImage = (index) => {\n    const newFiles = selectedFiles.filter((_, i) => i !== index);\n    const newPreviewUrls = previewUrls.filter((_, i) => i !== index);\n    \n    \n    if (previewUrls[index] && previewUrls[index].startsWith('blob:')) {\n      URL.revokeObjectURL(previewUrls[index]);\n    }\n    \n    setSelectedFiles(newFiles);\n    setPreviewUrls(newPreviewUrls);\n    \n    \n    if (currentImageIndex >= newFiles.length) {\n      setCurrentImageIndex(Math.max(0, newFiles.length - 1));\n    }\n  };\n\n  const handleSharePost = async () => {\n    if (selectedFiles.length === 0 || createLoading) return;\n\n    setCreateLoading(true);\n    setCreateError('');\n\n    try {\n      \n      const totalFileSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);\n      const totalFileSizeMB = totalFileSize / 1024 / 1024;\n      \n      \n      const estimatedBase64SizeMB = totalFileSizeMB * 1.33;\n      const MONGODB_SAFE_LIMIT_MB = 12; \n      \n      if (estimatedBase64SizeMB > MONGODB_SAFE_LIMIT_MB) {\n        setCreateError(\n          `–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–ø—Ä–∏–º–µ—Ä–Ω–æ ${estimatedBase64SizeMB.toFixed(2)} MB –ø–æ—Å–ª–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏). ` +\n          `–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ä–∞–∑–º–µ—Ä: ${MONGODB_SAFE_LIMIT_MB} MB. ` +\n          `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–º–µ–Ω—å—à–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–µ–Ω—å—à–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π.`\n        );\n        setCreateLoading(false);\n        return;\n      }\n\n     \n      const convertFileToBase64 = (file) => {\n        return new Promise((resolve, reject) => {\n          const reader = new FileReader();\n          reader.onloadend = () => resolve(reader.result);\n          reader.onerror = reject;\n          reader.readAsDataURL(file);\n        });\n      };\n\n      const base64Images = await Promise.all(\n        selectedFiles.map(file => convertFileToBase64(file))\n      );\n      \n      \n      const totalBase64Size = base64Images.reduce((sum, img) => sum + img.length, 0);\n      const totalBase64SizeMB = (totalBase64Size * 3) / 4 / 1024 / 1024;\n      \n      if (totalBase64SizeMB > MONGODB_SAFE_LIMIT_MB) {\n        setCreateError(\n          `–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ (${totalBase64SizeMB.toFixed(2)} MB) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –¥–æ–ø—É—Å—Ç–∏–º—ã–π –ª–∏–º–∏—Ç (${MONGODB_SAFE_LIMIT_MB} MB). ` +\n          `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–º–µ–Ω—å—à–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.`\n        );\n        setCreateLoading(false);\n        return;\n      }\n\n      const profileId = (() => {\n        try {\n          const storedUser = localStorage.getItem('user');\n          const active = storedUser ? JSON.parse(storedUser) : user;\n          return active?.id || localStorage.getItem('activeProfileId');\n        } catch {\n          return localStorage.getItem('activeProfileId');\n        }\n      })();\n\n      const result = await postsAPI.createPost({\n        images: base64Images, \n        title: (title || '').trim(),\n        caption: (caption || '').trim(),\n        profileId: profileId || undefined, \n      });\n\n      \n      if (!result || !result.success || !result.post) {\n        const errorMessage = result?.message || result?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç';\n        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞:', {\n          result,\n          errorMessage,\n          hasImages: base64Images.length > 0,\n          imagesCount: base64Images.length\n        });\n        throw new Error(errorMessage);\n      }\n\n      console.log('‚úÖ –ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω:', result.post);\n\n      \n      try {\n        const createdPost = result.post;\n        const storedUser = localStorage.getItem('user');\n        const active = storedUser ? JSON.parse(storedUser) : user;\n        const profileId = active?.id || localStorage.getItem('activeProfileId');\n\n        if (createdPost?.id && profileId) {\n          let map = {};\n          try {\n            map = JSON.parse(localStorage.getItem('profilePostsMap') || '{}');\n          } catch {\n            map = {};\n          }\n          const listForProfile = map[profileId] || [];\n          if (!listForProfile.includes(createdPost.id)) {\n            map[profileId] = [...listForProfile, createdPost.id];\n            localStorage.setItem('profilePostsMap', JSON.stringify(map));\n          }\n        }\n      } catch (error) {\n        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–≤—è–∑–∏ –ø–æ—Å—Ç–∞ —Å –ø—Ä–æ—Ñ–∏–ª–µ–º:', error);\n      }\n\n      \n      try {\n        const stored = localStorage.getItem('user');\n        if (stored) {\n          const parsed = JSON.parse(stored);\n          const updated = {\n            ...parsed,\n            postsCount: (parsed.postsCount || 0) + 1,\n          };\n          setUserToLocalStorage(updated);\n          setUser(updated);\n\n          \n          const profilesRaw = localStorage.getItem('profiles');\n          if (profilesRaw) {\n            const list = JSON.parse(profilesRaw) || [];\n            const activeId = updated.id || localStorage.getItem('activeProfileId');\n            if (activeId) {\n              const newList = list.map((p) =>\n                p.id === activeId ? { ...p, postsCount: updated.postsCount } : p\n              );\n              localStorage.setItem('profiles', JSON.stringify(newList));\n            }\n          }\n        }\n      } catch (error) {\n        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á—ë—Ç—á–∏–∫–∞ –ø–æ—Å—Ç–æ–≤:', error);\n      }\n\n      \n      close();\n\n      \n      try {\n        if (typeof window !== 'undefined') {\n          const path = window.location.pathname;\n          \n          if (path.startsWith('/profile') || path === '/' || path === '/home') {\n            window.location.reload();\n          }\n        }\n      } catch {\n        \n      }\n    } catch (error) {\n      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Å—Ç–∞:', error);\n      \n      \n      let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç.';\n      \n      if (error?.response?.data) {\n        const serverError = error.response.data;\n        errorMessage = serverError.message || serverError.error || errorMessage;\n        \n        \n        if (serverError.totalSizeMB) {\n          errorMessage += ` –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: ${serverError.totalSizeMB} MB.`;\n        }\n        if (serverError.maxAllowedMB) {\n          errorMessage += ` –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ä–∞–∑–º–µ—Ä: ${serverError.maxAllowedMB} MB.`;\n        }\n      } else if (error?.message) {\n        errorMessage = error.message;\n      }\n      \n      setCreateError(errorMessage);\n      \n    } finally {\n      setCreateLoading(false);\n    }\n  };\n\n  return (\n    <CreatePostContext.Provider value={{ open, close }}>\n      {children}\n      {isOpen && (\n        <>\n          <div className=\"home-search-overlay\" onClick={close}></div>\n          <div className=\"home-create-modal\">\n            <div className=\"home-create-modal-header\">\n              <span className=\"home-create-modal-title\">Create new post</span>\n              <button\n                className=\"home-create-modal-share\"\n                type=\"button\"\n                onClick={handleSharePost}\n                disabled={selectedFiles.length === 0 || createLoading}\n              >\n                {createLoading ? 'Sharing...' : 'Share'}\n              </button>\n            </div>\n            <div className=\"home-create-modal-body\">\n              <div className=\"home-create-modal-left\">\n                {previewUrls.length === 0 ? (\n                  <label className=\"home-create-upload-area\">\n                    <div className=\"home-create-upload-icon\">\n                      <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <path d=\"M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2\" />\n                        <polyline points=\"7 9 12 4 17 9\" />\n                        <line x1=\"12\" y1=\"4\" x2=\"12\" y2=\"16\" />\n                      </svg>\n                    </div>\n                    <span className=\"home-create-upload-text\">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ (–¥–æ {MAX_IMAGES}) –∏–ª–∏ –æ–¥–Ω–æ –≤–∏–¥–µ–æ</span>\n                    <input\n                      type=\"file\"\n                      accept=\"image/*,video/*\"\n                      multiple\n                      className=\"home-create-file-input\"\n                      onChange={handleFileChange}\n                    />\n                  </label>\n                ) : (\n                  <div className=\"home-create-image-preview\">\n                    {}\n                    <div className=\"home-create-main-image\">\n                      {selectedFiles[currentImageIndex]?.type?.startsWith?.('video/') ? (\n                        <video\n                          src={previewUrls[currentImageIndex]}\n                          controls\n                          playsInline\n                          className=\"home-create-preview-video\"\n                        />\n                      ) : (\n                        <img src={previewUrls[currentImageIndex]} alt={`Preview ${currentImageIndex + 1}`} />\n                      )}\n                      \n                      {}\n                      {previewUrls.length > 0 && (\n                        <button\n                          type=\"button\"\n                          className=\"home-create-remove-image\"\n                          onClick={() => handleRemoveImage(currentImageIndex)}\n                          title={selectedFiles[currentImageIndex]?.type?.startsWith?.('video/') ? '–£–¥–∞–ª–∏—Ç—å –≤–∏–¥–µ–æ' : '–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ'}\n                        >\n                          √ó\n                        </button>\n                      )}\n                      \n                      {}\n                      {previewUrls.length > 1 && (\n                        <>\n                          <button\n                            type=\"button\"\n                            className=\"home-create-nav-arrow home-create-nav-arrow-left\"\n                            onClick={() => setCurrentImageIndex((prev) => (prev > 0 ? prev - 1 : previewUrls.length - 1))}\n                            title=\"–ü—Ä–µ–¥—ã–¥—É—â–µ–µ\"\n                          >\n                            ‚Äπ\n                          </button>\n                          <button\n                            type=\"button\"\n                            className=\"home-create-nav-arrow home-create-nav-arrow-right\"\n                            onClick={() => setCurrentImageIndex((prev) => (prev < previewUrls.length - 1 ? prev + 1 : 0))}\n                            title=\"–°–ª–µ–¥—É—é—â–µ–µ\"\n                          >\n                            ‚Ä∫\n                          </button>\n                        </>\n                      )}\n                      \n                      {}\n                      {previewUrls.length > 1 && (\n                        <div className=\"home-create-image-counter\">\n                          {currentImageIndex + 1} / {previewUrls.length}\n                        </div>\n                      )}\n                    </div>\n                    \n                    {}\n                    {previewUrls.length > 1 && (\n                      <div className=\"home-create-thumbnails\">\n                        {previewUrls.map((url, index) => (\n                          <div\n                            key={index}\n                            className={`home-create-thumbnail ${index === currentImageIndex ? 'active' : ''}`}\n                            onClick={() => setCurrentImageIndex(index)}\n                          >\n                            {selectedFiles[index]?.type?.startsWith?.('video/') ? (\n                              <video src={url} muted className=\"home-create-thumbnail-video\" />\n                            ) : (\n                              <img src={url} alt={`Thumbnail ${index + 1}`} />\n                            )}\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                    \n                    {}\n                    {previewUrls.length < MAX_IMAGES && !(previewUrls.length === 1 && selectedFiles[0]?.type?.startsWith?.('video/')) && (\n                      <label className=\"home-create-add-more\">\n                        <input\n                          type=\"file\"\n                          accept=\"image/*,video/*\"\n                          multiple\n                          className=\"home-create-file-input\"\n                          onChange={handleFileChange}\n                        />\n                        <span className=\"home-create-add-more-btn\">+ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ ({previewUrls.length}/{MAX_IMAGES})</span>\n                      </label>\n                    )}\n                  </div>\n                )}\n              </div>\n              <div className=\"home-create-modal-right\">\n                <div className=\"home-create-user-row\">\n                  <div className=\"home-create-user-avatar\">\n                    {user?.avatar || user?.profile_image ? (\n                      (user?.avatarType === 'video' || (user.avatar && user.avatar.startsWith('data:video/'))) ? (\n                        <video\n                          src={user.avatar || user.profile_image}\n                          className=\"home-post-avatar-image\"\n                          autoPlay\n                          loop\n                          muted\n                          playsInline\n                          onError={(e) => {\n                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–µ–æ-–∞–≤–∞—Ç–∞—Ä–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ:', e);\n                          }}\n                        />\n                      ) : (\n                        <img\n                          src={user.avatar || user.profile_image}\n                          alt={user?.username || 'avatar'}\n                          className=\"home-post-avatar-image\"\n                          onError={(e) => {\n                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è-–∞–≤–∞—Ç–∞—Ä–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ:', e);\n                          }}\n                        />\n                      )\n                    ) : (\n                      <div className=\"home-post-avatar-placeholder\">\n                        {(user?.username || 'U').charAt(0).toUpperCase()}\n                      </div>\n                    )}\n                  </div>\n                  <div className=\"home-create-username\">\n                    {(() => {\n                      const nick = (user?.username || '').trim() || 'you';\n                      const fullName = (user?.fullName || '').trim();\n                      const nickDisplay = nick.replace(/^@+/, '') || nick;\n                      return (\n                        <>\n                          <span className=\"home-create-username-handle\">{nickDisplay}</span>\n                          {fullName && fullName !== nickDisplay && (\n                            <span className=\"home-create-username-fullname\"> {fullName}</span>\n                          )}\n                        </>\n                      );\n                    })()}\n                  </div>\n                </div>\n                <label className=\"home-create-caption-label\">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞</label>\n                <input\n                  type=\"text\"\n                  className=\"home-create-title-input\"\n                  placeholder=\"–ö—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–æ —á—ë–º –ø–æ—Å—Ç)...\"\n                  maxLength={300}\n                  value={title}\n                  onChange={(e) => setTitle(e.target.value)}\n                />\n                <label className=\"home-create-caption-label\">–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞</label>\n                <textarea\n                  className=\"home-create-caption\"\n                  placeholder=\"–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞...\"\n                  maxLength={2200}\n                  value={caption}\n                  onChange={(e) => setCaption(e.target.value)}\n                />\n                <div className=\"home-create-caption-counter\">\n                  {caption.length}/2200\n                </div>\n                {createError && <div className=\"home-create-error\">{createError}</div>}\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n    </CreatePostContext.Provider>\n  );\n};\n\n"
        }
    ]
}