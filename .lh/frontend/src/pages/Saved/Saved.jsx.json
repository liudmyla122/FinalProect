{
    "sourceFile": "frontend/src/pages/Saved/Saved.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1770737376091,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1770896952996,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -317,9 +317,9 @@\n                       </button>\n                     </div>\n                     <div className=\"saved-modal-caption-block\">\n                       <div className=\"saved-modal-title-text\">\n-                        {savedPostModalData.title || 'Без названия'}\n+                        {savedPostModalData.title || 'Untitled'}\n                       </div>\n                       <div className=\"saved-modal-caption\">\n                         {savedPostModalData.caption || ''}\n                       </div>\n"
                }
            ],
            "date": 1770737376091,
            "name": "Commit-0",
            "content": "import { useEffect, useState } from 'react'\nimport { Link } from 'react-router-dom'\nimport { postsAPI } from '../../services/api'\nimport AppSidebar from '../../components/AppSidebar/AppSidebar'\nimport EmojiPicker from '../../components/EmojiPicker/EmojiPicker'\nimport './Saved.css'\n\nconst formatCount = (count) => {\n  if (count == null || count === 0) return '0'\n  if (count >= 1000) return `${(count / 1000).toFixed(1)}k`\n  return String(count)\n}\n\nconst Saved = () => {\n  const [posts, setPosts] = useState([])\n  const [loading, setLoading] = useState(true)\n  const [error, setError] = useState(false)\n  const [savedPostModalId, setSavedPostModalId] = useState(null)\n  const [savedPostModalData, setSavedPostModalData] = useState(null)\n  const [savedPostModalLoading, setSavedPostModalLoading] = useState(false)\n  const [likingPostId, setLikingPostId] = useState(null)\n  const [savingPostId, setSavingPostId] = useState(null)\n  const [savedModalComment, setSavedModalComment] = useState('')\n  const [savedModalSubmitting, setSavedModalSubmitting] = useState(false)\n\n  useEffect(() => {\n    let cancelled = false\n    const load = async () => {\n      setLoading(true)\n      setError(false)\n      try {\n        const res = await postsAPI.getSavedPosts()\n        if (!cancelled && res.success && res.posts) {\n          setPosts(res.posts)\n        }\n      } catch (e) {\n        if (!cancelled) setError(true)\n      } finally {\n        if (!cancelled) setLoading(false)\n      }\n    }\n    load()\n    return () => {\n      cancelled = true\n    }\n  }, [])\n\n  useEffect(() => {\n    if (!savedPostModalId) {\n      setSavedPostModalData(null)\n      setSavedModalComment('')\n      return\n    }\n    let cancelled = false\n    setSavedPostModalLoading(true)\n    setSavedModalComment('')\n    postsAPI\n      .getPostById(savedPostModalId)\n      .then((res) => {\n        if (!cancelled && res?.success && res?.post) {\n          setSavedPostModalData(res.post)\n        }\n        if (!cancelled) setSavedPostModalLoading(false)\n      })\n      .catch(() => {\n        if (!cancelled) setSavedPostModalLoading(false)\n      })\n    return () => {\n      cancelled = true\n    }\n  }, [savedPostModalId])\n\n  const handlePostClick = (postId) => {\n    setSavedPostModalId(postId)\n  }\n\n  const closeSavedModal = () => {\n    setSavedPostModalId(null)\n    setSavedPostModalData(null)\n  }\n\n  const handleLikeClick = async () => {\n    if (!savedPostModalData || likingPostId) return\n    setLikingPostId(savedPostModalData.id)\n    try {\n      const res = await postsAPI.toggleLike(savedPostModalData.id)\n      if (res.success) {\n        setSavedPostModalData((d) =>\n          d\n            ? {\n                ...d,\n                liked: res.liked,\n                likesCount: res.likesCount ?? d.likesCount,\n              }\n            : d,\n        )\n      }\n    } catch (e) {\n      console.error('Like error:', e)\n    } finally {\n      setLikingPostId(null)\n    }\n  }\n\n  const handleToggleSave = async () => {\n    if (!savedPostModalData || savingPostId) return\n    setSavingPostId(savedPostModalData.id)\n    try {\n      const res = await postsAPI.toggleSave(savedPostModalData.id)\n      if (res.success) {\n        setSavedPostModalData((d) =>\n          d\n            ? {\n                ...d,\n                saved: res.saved,\n                savesCount:\n                  res.savesCount ?? (d.savesCount || 0) + (res.saved ? 1 : -1),\n              }\n            : d,\n        )\n        if (!res.saved) {\n          setPosts((prev) => prev.filter((p) => p.id !== savedPostModalData.id))\n        }\n      }\n    } catch (e) {\n      console.error('Toggle save error:', e)\n    } finally {\n      setSavingPostId(null)\n    }\n  }\n\n  const handleShareClick = async () => {\n    if (!savedPostModalData) return\n    const url = `${window.location.origin}/?post=${savedPostModalData.id}`\n    try {\n      if (navigator.share) {\n        await navigator.share({\n          title: 'Post',\n          url,\n          text: savedPostModalData.caption || '',\n        })\n      } else {\n        await navigator.clipboard.writeText(url)\n        alert('Ссылка скопирована')\n      }\n    } catch (e) {\n      if (e.name !== 'AbortError') {\n        try {\n          await navigator.clipboard.writeText(url)\n          alert('Ссылка скопирована')\n        } catch {\n          console.error('Share error:', e)\n        }\n      }\n    }\n  }\n\n  const handleAddComment = async (e) => {\n    e.preventDefault()\n    if (\n      !savedPostModalData ||\n      !savedModalComment.trim() ||\n      savedModalSubmitting\n    )\n      return\n    setSavedModalSubmitting(true)\n    try {\n      const res = await postsAPI.addComment(\n        savedPostModalData.id,\n        savedModalComment.trim(),\n      )\n      if (res.success && res.comment) {\n        setSavedPostModalData((d) =>\n          d\n            ? {\n                ...d,\n                comments: [...(d.comments || []), res.comment],\n                commentsCount: (d.commentsCount || 0) + 1,\n              }\n            : d,\n        )\n        setSavedModalComment('')\n      }\n    } catch (e) {\n      console.error('Add comment error:', e)\n    } finally {\n      setSavedModalSubmitting(false)\n    }\n  }\n\n  return (\n    <div className=\"app-layout-with-sidebar\">\n      <AppSidebar activeItem=\"saved\" />\n      <main className=\"app-layout-main saved-main\">\n        <div className=\"saved-content\">\n          {loading ? (\n            <div className=\"saved-loading\">Загрузка...</div>\n          ) : error ? (\n            <div className=\"saved-error\">\n              Не удалось загрузить сохранённые посты.\n            </div>\n          ) : posts.length === 0 ? (\n            <div className=\"saved-empty-wrap\">\n              <div className=\"saved-empty\">\n                <p>Здесь пока нет сохранённых постов.</p>\n                <p>\n                  Нажимайте на иконку закладки у постов в ленте, чтобы сохранять\n                  их сюда.\n                </p>\n                <Link to=\"/\" className=\"saved-empty-link\">\n                  Перейти в ленту\n                </Link>\n              </div>\n            </div>\n          ) : (\n            <div className=\"saved-grid\">\n              {posts.map((post) => {\n                const img =\n                  post.images && post.images.length > 0\n                    ? post.images[0]\n                    : post.image\n                const isVideo =\n                  post.isVideo ||\n                  (typeof img === 'string' && img.startsWith('data:video'))\n                return (\n                  <button\n                    key={post.id}\n                    type=\"button\"\n                    className=\"saved-post-item\"\n                    onClick={() => handlePostClick(post.id)}\n                  >\n                    <div className=\"saved-post-media-wrap\">\n                      {isVideo ? (\n                        <video\n                          src={img}\n                          className=\"saved-post-media\"\n                          autoPlay\n                          loop\n                          muted\n                          playsInline\n                        />\n                      ) : (\n                        <img\n                          src={img}\n                          alt={post.caption || 'Post'}\n                          className=\"saved-post-media\"\n                        />\n                      )}\n                    </div>\n                    <div className=\"saved-post-title\">\n                      {post.title || 'Untitled'}\n                    </div>\n                  </button>\n                )\n              })}\n            </div>\n          )}\n        </div>\n        <footer className=\"saved-footer\">\n          <nav className=\"saved-footer-nav\">\n            <Link to=\"/\">Home</Link>\n            <Link to=\"/search\">Search</Link>\n            <Link to=\"/explore\">Explore</Link>\n            <Link to=\"/messages\">Messages</Link>\n            <Link to=\"/notifications\">Notifications</Link>\n            <Link to=\"/create\">Create</Link>\n          </nav>\n          <div className=\"saved-footer-copyright\">© 2026 ICHgram</div>\n        </footer>\n      </main>\n\n      {savedPostModalId && (\n        <>\n          <div\n            className=\"saved-modal-overlay\"\n            onClick={closeSavedModal}\n            aria-hidden=\"true\"\n          />\n          <div\n            className=\"saved-modal\"\n            role=\"dialog\"\n            aria-modal=\"true\"\n            onClick={(e) => e.stopPropagation()}\n          >\n            <button\n              type=\"button\"\n              className=\"saved-modal-close\"\n              onClick={closeSavedModal}\n              aria-label=\"Закрыть\"\n            >\n              ×\n            </button>\n            {savedPostModalLoading ? (\n              <div className=\"saved-modal-loading\">Загрузка...</div>\n            ) : savedPostModalData ? (\n              <div className=\"saved-modal-inner\">\n                <div className=\"saved-modal-media\">\n                  {(() => {\n                    const imgs =\n                      savedPostModalData.images?.length > 0\n                        ? savedPostModalData.images\n                        : savedPostModalData.image\n                          ? [savedPostModalData.image]\n                          : []\n                    const src = imgs[0]\n                    const isVideo =\n                      savedPostModalData.isVideo ||\n                      (typeof src === 'string' && src.startsWith('data:video'))\n                    if (!src) return null\n                    return isVideo ? (\n                      <video\n                        src={src}\n                        controls\n                        playsInline\n                        className=\"saved-modal-image\"\n                      />\n                    ) : (\n                      <img src={src} alt=\"\" className=\"saved-modal-image\" />\n                    )\n                  })()}\n                </div>\n                <div className=\"saved-modal-side\">\n                  <div className=\"saved-modal-actions\">\n                    <button\n                      type=\"button\"\n                      className={`saved-modal-action-btn saved-modal-action-btn--like${savedPostModalData.liked ? ' saved-modal-action-btn--liked' : ''}`}\n                      title=\"Нравится\"\n                      onClick={handleLikeClick}\n                      disabled={likingPostId === savedPostModalData.id}\n                    >\n                      <svg\n                        className=\"saved-modal-action-icon\"\n                        viewBox=\"0 0 24 24\"\n                        fill={\n                          savedPostModalData.liked ? 'currentColor' : 'none'\n                        }\n                        stroke=\"currentColor\"\n                        strokeWidth=\"2\"\n                      >\n                        <path d=\"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z\"></path>\n                      </svg>\n                      <span className=\"saved-modal-action-count\">\n                        {formatCount(savedPostModalData.likesCount)}\n                      </span>\n                    </button>\n                    <span className=\"saved-modal-comments-count\">\n                      {formatCount(savedPostModalData.commentsCount)}\n                    </span>\n                    <button\n                      type=\"button\"\n                      className=\"saved-modal-action-btn\"\n                      title=\"Поделиться\"\n                      onClick={handleShareClick}\n                    >\n                      <svg\n                        className=\"saved-modal-action-icon\"\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        strokeWidth=\"2\"\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                      >\n                        <line x1=\"22\" y1=\"2\" x2=\"11\" y2=\"13\"></line>\n                        <polygon points=\"22 2 15 22 11 13 2 9 22 2\"></polygon>\n                      </svg>\n                    </button>\n                    <button\n                      type=\"button\"\n                      className={`saved-modal-action-btn saved-modal-action-btn--save${savedPostModalData.saved ? ' saved-modal-action-btn--saved' : ''}`}\n                      title=\"Saved\"\n                      onClick={handleToggleSave}\n                      disabled={savingPostId === savedPostModalData.id}\n                    >\n                      <svg\n                        className=\"saved-modal-action-icon\"\n                        viewBox=\"0 0 24 24\"\n                        fill={\n                          savedPostModalData.saved ? 'currentColor' : 'none'\n                        }\n                        stroke=\"currentColor\"\n                        strokeWidth=\"2\"\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                      >\n                        <path d=\"M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z\"></path>\n                      </svg>\n                      <span className=\"saved-modal-action-count\">\n                        {formatCount(savedPostModalData.savesCount ?? 0)}\n                      </span>\n                    </button>\n                  </div>\n                  <div className=\"saved-modal-caption-block\">\n                    <div className=\"saved-modal-title-text\">\n                      {savedPostModalData.title || 'Без названия'}\n                    </div>\n                    <div className=\"saved-modal-caption\">\n                      {savedPostModalData.caption || ''}\n                    </div>\n                  </div>\n                  <div className=\"saved-modal-comments-list\">\n                    {(savedPostModalData.comments || []).map((c) => (\n                      <div key={c.id} className=\"saved-modal-comment\">\n                        <div className=\"saved-modal-comment-avatar\">\n                          {c.user?.avatar &&\n                          typeof c.user.avatar === 'string' ? (\n                            c.user.avatar.startsWith('data:video') ? (\n                              <video\n                                src={c.user.avatar}\n                                autoPlay\n                                loop\n                                muted\n                                playsInline\n                              />\n                            ) : (\n                              <img\n                                src={c.user.avatar}\n                                alt={c.user?.username || 'avatar'}\n                              />\n                            )\n                          ) : (\n                            <span className=\"saved-modal-comment-avatar-fallback\">\n                              {(c.user?.username || 'U')\n                                .charAt(0)\n                                .toUpperCase()}\n                            </span>\n                          )}\n                        </div>\n                        <div className=\"saved-modal-comment-body\">\n                          <span className=\"saved-modal-comment-username\">\n                            {c.user?.username || 'User'}\n                          </span>\n                          <span className=\"saved-modal-comment-text\">\n                            {c.text}\n                          </span>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                  <form\n                    className=\"saved-modal-add-comment\"\n                    onSubmit={handleAddComment}\n                  >\n                    <input\n                      type=\"text\"\n                      className=\"saved-modal-input\"\n                      placeholder=\"Добавить комментарий...\"\n                      value={savedModalComment}\n                      onChange={(e) => setSavedModalComment(e.target.value)}\n                      maxLength={500}\n                    />\n                    <EmojiPicker\n                      onSelect={(emoji) =>\n                        setSavedModalComment((prev) =>\n                          prev.length + emoji.length <= 500\n                            ? prev + emoji\n                            : prev,\n                        )\n                      }\n                      disabled={savedModalSubmitting}\n                    />\n                    <button\n                      type=\"submit\"\n                      className=\"saved-modal-submit\"\n                      disabled={\n                        !savedModalComment.trim() || savedModalSubmitting\n                      }\n                    >\n                      {savedModalSubmitting ? '...' : 'Send'}\n                    </button>\n                  </form>\n                </div>\n              </div>\n            ) : null}\n          </div>\n        </>\n      )}\n    </div>\n  )\n}\n\nexport default Saved\n"
        }
    ]
}