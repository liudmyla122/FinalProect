{
    "sourceFile": "frontend/src/pages/Profile/Profile.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1769705388833,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1769705502678,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1507,9 +1507,9 @@\n                   Create a new profile\n                 </button>\n               </div>\n \n-              {/}\n+              {}\n               <div className=\"profile-stats\">\n                 <div className=\"stat-item\">\n                   <span className=\"stat-number\">{postsCount}</span>\n                   <span className=\"stat-label\">posts</span>\n"
                },
                {
                    "date": 1770027435007,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -259,116 +259,75 @@\n \n           return 'image'\n         }\n \n+        // 1) –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è\n         try {\n+          const specificAvatar = localStorage.getItem(`profile_avatar_${activeId}`)\n+          if (\n+            specificAvatar &&\n+            typeof specificAvatar === 'string' &&\n+            specificAvatar.trim().length > 0\n+          ) {\n+            avatarToUse = specificAvatar\n+            avatarTypeToUse = detectAvatarType(specificAvatar)\n+            console.log('‚úÖ –ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ profile_avatar_{id}')\n+          }\n+        } catch (e) {\n+          console.warn('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è profile_avatar –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e)\n+        }\n+\n+        // 2) –ü—Ä–æ—Ñ–∏–ª–∏—Å—Ç (–ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫) –∫–∞–∫ —Å–ª–µ–¥—É—é—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫\n+        if (\n+          !avatarToUse &&\n+          (activeProfile.avatar || activeProfile.profile_image)\n+        ) {\n+          avatarToUse = activeProfile.avatar || activeProfile.profile_image\n+          avatarTypeToUse =\n+            detectAvatarType(avatarToUse) || activeProfile.avatarType || 'image'\n+          console.log('‚úÖ –ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è')\n+        }\n+\n+        // 3) –°–µ—Ä–≤–µ—Ä: –æ–±–Ω–æ–≤–ª—è–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –Ω–æ –ù–ï –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∞–≤–∞—Ç–∞—Ä\n+        try {\n           const serverUserResponse = await authAPI.getCurrentUser()\n-          console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ getCurrentUser:', {\n-            hasResponse: !!serverUserResponse,\n-            hasUser: !!serverUserResponse?.user,\n-            hasAvatar: !!serverUserResponse?.user?.avatar,\n-            avatarLength: serverUserResponse?.user?.avatar?.length || 0,\n-            avatarType: typeof serverUserResponse?.user?.avatar,\n-            avatarPreview:\n-              serverUserResponse?.user?.avatar?.substring(0, 50) || '–Ω–µ—Ç',\n-            fullResponse: serverUserResponse,\n-          })\n-\n           if (serverUserResponse && serverUserResponse.user) {\n             const serverAvatar = serverUserResponse.user.avatar\n-\n+            const serverAvatarType = serverUserResponse.user.avatarType\n             if (\n               serverAvatar &&\n               typeof serverAvatar === 'string' &&\n               serverAvatar.trim().length > 0 &&\n               serverAvatar !== 'null' &&\n               serverAvatar !== 'undefined'\n             ) {\n-              avatarToUse = serverAvatar\n-\n-              const serverAvatarType = serverUserResponse.user.avatarType\n-              if (\n-                serverAvatarType === 'video' ||\n-                serverAvatarType === 'image'\n-              ) {\n-                avatarTypeToUse = serverAvatarType\n-              } else {\n-                avatarTypeToUse = detectAvatarType(avatarToUse)\n+              if (!avatarToUse) {\n+                avatarToUse = serverAvatar\n+                avatarTypeToUse =\n+                  serverAvatarType === 'video' || serverAvatarType === 'image'\n+                    ? serverAvatarType\n+                    : detectAvatarType(serverAvatar)\n               }\n-\n-              console.log('‚úÖ –ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', {\n-                hasAvatar: !!avatarToUse,\n-                type: avatarTypeToUse,\n-                serverAvatarType: serverAvatarType,\n-                detectedType: detectAvatarType(avatarToUse),\n-                length: avatarToUse?.length || 0,\n-                startsWith: avatarToUse?.substring(0, 30) || '–Ω–µ—Ç',\n-                isVideo: avatarToUse?.startsWith('data:video/') || false,\n-              })\n-\n-              const userWithServerAvatar = {\n+              setProfileAvatarSafe(activeId, serverAvatar)\n+              const userWithServerMeta = {\n                 ...activeProfile,\n-                id: activeProfile.id,\n                 dbId: serverUserResponse.user.id,\n-                avatar: avatarToUse,\n-                avatarType: avatarTypeToUse,\n                 fullName:\n                   serverUserResponse.user.fullName ?? activeProfile.fullName,\n               }\n-              setUser(userWithServerAvatar)\n-\n+              setUser(userWithServerMeta)\n               try {\n-                setUserToLocalStorage(userWithServerAvatar)\n-              } catch (localError) {\n-                console.warn(\n-                  '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å user –≤ localStorage:',\n-                  localError\n-                )\n-              }\n-\n-              setProfileAvatarSafe(activeId, avatarToUse)\n-            } else {\n-              console.log('‚ö†Ô∏è –ê–≤–∞—Ç–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞:', {\n-                serverAvatar: serverAvatar,\n-                type: typeof serverAvatar,\n-                length: serverAvatar?.length || 0,\n-                isEmpty: !serverAvatar || serverAvatar.trim().length === 0,\n-              })\n-            }\n-\n-            if (\n-              serverUserResponse?.user?.fullName ||\n-              serverUserResponse?.user?.id\n-            ) {\n-              const userWithFullName = {\n-                ...activeProfile,\n-                fullName:\n-                  serverUserResponse.user.fullName ?? activeProfile.fullName,\n-                dbId: serverUserResponse.user.id,\n-              }\n-              setUser(userWithFullName)\n-              try {\n                 const stored = localStorage.getItem('user')\n                 const base = stored ? JSON.parse(stored) : {}\n                 setUserToLocalStorage({\n                   ...base,\n                   fullName: serverUserResponse.user.fullName,\n                 })\n-              } catch (e) {}\n+              } catch (_) {}\n             }\n-          } else {\n-            console.log('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', serverUserResponse)\n           }\n         } catch (serverError) {\n-          console.error(\n-            '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:',\n-            serverError\n-          )\n-          console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', {\n-            message: serverError.message,\n-            response: serverError.response?.data,\n-            status: serverError.response?.status,\n-          })\n+          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ getCurrentUser:', serverError)\n         }\n \n         if (!avatarToUse) {\n           try {\n@@ -388,36 +347,10 @@\n             console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ user –∏–∑ localStorage:', localError)\n           }\n         }\n \n-        if (!avatarToUse) {\n-          try {\n-            const avatarFromStorage = localStorage.getItem(\n-              `profile_avatar_${activeId}`\n-            )\n-            if (avatarFromStorage) {\n-              avatarToUse = avatarFromStorage\n-              avatarTypeToUse = detectAvatarType(avatarFromStorage)\n-              console.log('‚úÖ –ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞')\n-            }\n-          } catch (storageError) {\n-            console.warn(\n-              '–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞ –∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:',\n-              storageError\n-            )\n-          }\n-        }\n+        // –ò—Ç–æ–≥: avatarToUse –∏ avatarTypeToUse –≤—ã–±—Ä–∞–Ω—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É\n \n-        if (\n-          !avatarToUse &&\n-          (activeProfile.avatar || activeProfile.profile_image)\n-        ) {\n-          avatarToUse = activeProfile.avatar || activeProfile.profile_image\n-          avatarTypeToUse =\n-            detectAvatarType(avatarToUse) || activeProfile.avatarType || 'image'\n-          console.log('‚úÖ –ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è')\n-        }\n-\n         if (avatarToUse) {\n           console.log('‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä:', {\n             hasAvatar: true,\n             type: avatarTypeToUse,\n"
                },
                {
                    "date": 1770723649349,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -141,8 +141,14 @@\n             if (\n               currentUserId &&\n               String(profileUser.id) === String(currentUserId)\n             ) {\n+              // Viewing own profile - use loadPosts() which handles profile filtering\n+              setViewUser(profileUser)\n+              setUser(currentRes?.user || null)\n+              // Posts will be loaded by loadPosts() useEffect after activeProfileId is set\n+              setLoading(false)\n+              return\n             } else {\n               setViewUser(profileUser)\n               setUser(currentRes?.user || null)\n               const postsRes = await usersAPI.getUserPosts(profileUser.id)\n"
                }
            ],
            "date": 1769705388833,
            "name": "Commit-0",
            "content": "import { useState, useEffect, useRef } from 'react';\nimport { Link, useNavigate, useParams } from 'react-router-dom';\nimport { useCreatePost } from '../../context/CreatePostContext';\nimport { postsAPI, authAPI, searchAPI, usersAPI } from '../../services/api';\nimport { setUserToLocalStorage, setProfileAvatarSafe } from '../../utils/storage';\nimport EmojiPicker from '../../components/EmojiPicker/EmojiPicker';\nimport './Profile.css';\n\nconst Profile = () => {\n  const { username: usernameParam } = useParams();\n  const { open: openCreateModal } = useCreatePost();\n  const navigate = useNavigate();\n  const [user, setUser] = useState(null);\n  const [viewUser, setViewUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [profiles, setProfiles] = useState([]);\n  const [activeProfileId, setActiveProfileId] = useState(null);\n  const [avatar, setAvatar] = useState(null);\n  const [avatarFile, setAvatarFile] = useState(null);\n  const [avatarType, setAvatarType] = useState('image'); \n  const [isBioExpanded, setIsBioExpanded] = useState(false);\n  const [posts, setPosts] = useState([]);\n  const [postsLoading, setPostsLoading] = useState(true);\n  const [selectedPost, setSelectedPost] = useState(null);\n  const [postComments, setPostComments] = useState([]);\n  const [newCommentText, setNewCommentText] = useState('');\n  const [commentLoading, setCommentLoading] = useState(false);\n  const [replyingTo, setReplyingTo] = useState(null);\n  const [replyText, setReplyText] = useState('');\n  const [expandedReplies, setExpandedReplies] = useState(new Set());\n  const [miniChatPostId, setMiniChatPostId] = useState(null);\n  const [miniChatComments, setMiniChatComments] = useState([]);\n  const [miniChatNewText, setMiniChatNewText] = useState('');\n  const [miniChatLoading, setMiniChatLoading] = useState(false);\n  const [likingPostId, setLikingPostId] = useState(null);\n  const [postMenuPostId, setPostMenuPostId] = useState(null);\n  const [removeFromProfilePostId, setRemoveFromProfilePostId] = useState(null);\n  const [editingPostId, setEditingPostId] = useState(null);\n  const [editingTitle, setEditingTitle] = useState('');\n  const [editingCaption, setEditingCaption] = useState('');\n  const [editingMedia, setEditingMedia] = useState(null);\n  const [editingCaptionSaving, setEditingCaptionSaving] = useState(false);\n  const [focusCommentWhenOpen, setFocusCommentWhenOpen] = useState(false);\n  const [followLoading, setFollowLoading] = useState(false);\n  const [profileNotFound, setProfileNotFound] = useState(false);\n  const editMediaInputRef = useRef(null);\n  const commentInputRef = useRef(null);\n  const EDIT_MEDIA_INPUT_ID = 'profile-edit-media-input';\n\n  \n  const uniqueProfilesById = (arr) => {\n    if (!Array.isArray(arr)) return [];\n    const seen = new Set();\n    return arr.filter((p) => {\n      if (!p || !p.id) return false;\n      if (seen.has(p.id)) return false;\n      seen.add(p.id);\n      return true;\n    });\n  };\n\n  \n  const formatPostTime = (dateString) => {\n    if (!dateString) return 'Just now';\n    const date = new Date(dateString);\n    const now = new Date();\n    const diffMs = now - date;\n    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));\n    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));\n    \n    if (diffHours < 1) return 'Just now';\n    if (diffHours < 24) return `${diffHours}h`;\n    if (diffDays === 1) return '1 day';\n    if (diffDays < 7) return `${diffDays} days`;\n    const diffWeeks = Math.floor(diffDays / 7);\n    if (diffWeeks === 1) return '1 week';\n    return `${diffWeeks} weeks`;\n  };\n\n  \n  useEffect(() => {\n    if (!usernameParam || !usernameParam.trim()) {\n      setViewUser(null);\n    }\n  }, [usernameParam]);\n\n  useEffect(() => {\n    \n    document.title = 'Profile - ICHGRAM';\n    \n    let isMounted = true;\n    \n    const initializeProfile = async () => {\n      try {\n        const token = localStorage.getItem('token');\n        if (!token) {\n          setLoading(false);\n          navigate('/login');\n          return;\n        }\n\n        \n        if (usernameParam && usernameParam.trim()) {\n          try {\n            const profileRes = await usersAPI.getProfileByUsername(usernameParam.trim());\n            const currentRes = await authAPI.getCurrentUser();\n            const currentUserId = currentRes?.user?.id;\n            const profileUser = profileRes?.user;\n            if (!profileUser) {\n              setViewUser(null);\n              setLoading(false);\n              return;\n            }\n           \n            if (currentUserId && (String(profileUser.id) === String(currentUserId))) {\n              \n            } else {\n              setViewUser(profileUser);\n              setUser(currentRes?.user || null);\n              const postsRes = await usersAPI.getUserPosts(profileUser.id);\n              setPosts(postsRes?.posts || []);\n              setPostsLoading(false);\n              setLoading(false);\n              return;\n            }\n          } catch (err) {\n            if (err.response?.status === 404) {\n              setViewUser(null);\n              setProfileNotFound(true);\n              setLoading(false);\n              return;\n            }\n            console.warn('Profile by username error:', err);\n          }\n        }\n        setProfileNotFound(false);\n\n        const profilesRaw = localStorage.getItem('profiles');\n        const activeIdRaw = localStorage.getItem('activeProfileId');\n        const userRaw = localStorage.getItem('user');\n\n        let list = [];\n        let activeId = activeIdRaw || null;\n\n        if (profilesRaw) {\n          try {\n            list = uniqueProfilesById(JSON.parse(profilesRaw) || []);\n          } catch {\n            list = [];\n          }\n        }\n\n        \n        if (!list.length && userRaw) {\n          try {\n            const single = JSON.parse(userRaw);\n            const id = single.id || `profile-${Date.now()}`;\n            const profile = { ...single, id };\n            list = [profile];\n            activeId = id;\n          } catch {\n            list = [];\n          }\n        }\n\n        list = uniqueProfilesById(list);\n\n        if (!isMounted) return;\n\n        if (!list.length) {\n        \n          setLoading(false);\n          navigate('/profile/edit');\n          return;\n        }\n\n        if (!activeId) {\n          activeId = list[0].id;\n        }\n\n        const activeProfile = list.find((p) => p.id === activeId) || list[0];\n\n        if (!isMounted) return;\n\n        if (!activeProfile || !activeProfile.profileCompleted) {\n         \n          localStorage.setItem('profiles', JSON.stringify(list));\n          localStorage.setItem('activeProfileId', activeId);\n          setUserToLocalStorage(activeProfile);\n          setLoading(false);\n          navigate('/profile/edit');\n          return;\n        }\n\n        if (!isMounted) return;\n\n        setProfiles(uniqueProfilesById(list));\n        setActiveProfileId(activeId);\n        setUser(activeProfile);\n        \n        \n        let avatarToUse = null;\n        let avatarTypeToUse = activeProfile.avatarType || 'image';\n        \n        \n        const detectAvatarType = (avatarData) => {\n          if (!avatarData || typeof avatarData !== 'string') return 'image';\n          \n          \n          if (avatarData.startsWith('data:video/')) {\n            return 'video';\n          }\n          \n          \n          if (avatarData.includes('video') || avatarData.includes('mp4')) {\n            return 'video';\n          }\n          \n          \n          \n          return 'image';\n        };\n        \n        \n        try {\n          const serverUserResponse = await authAPI.getCurrentUser();\n          console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ getCurrentUser:', {\n            hasResponse: !!serverUserResponse,\n            hasUser: !!serverUserResponse?.user,\n            hasAvatar: !!serverUserResponse?.user?.avatar,\n            avatarLength: serverUserResponse?.user?.avatar?.length || 0,\n            avatarType: typeof serverUserResponse?.user?.avatar,\n            avatarPreview: serverUserResponse?.user?.avatar?.substring(0, 50) || '–Ω–µ—Ç',\n            fullResponse: serverUserResponse\n          });\n          \n          if (serverUserResponse && serverUserResponse.user) {\n            const serverAvatar = serverUserResponse.user.avatar;\n            \n            \n            if (serverAvatar && \n                typeof serverAvatar === 'string' && \n                serverAvatar.trim().length > 0 &&\n                serverAvatar !== 'null' &&\n                serverAvatar !== 'undefined') {\n              avatarToUse = serverAvatar;\n              \n              \n              const serverAvatarType = serverUserResponse.user.avatarType;\n              if (serverAvatarType === 'video' || serverAvatarType === 'image') {\n                avatarTypeToUse = serverAvatarType;\n              } else {\n                \n                avatarTypeToUse = detectAvatarType(avatarToUse);\n              }\n              \n              console.log('‚úÖ –ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', {\n                hasAvatar: !!avatarToUse,\n                type: avatarTypeToUse,\n                serverAvatarType: serverAvatarType,\n                detectedType: detectAvatarType(avatarToUse),\n                length: avatarToUse?.length || 0,\n                startsWith: avatarToUse?.substring(0, 30) || '–Ω–µ—Ç',\n                isVideo: avatarToUse?.startsWith('data:video/') || false\n              });\n              \n              \n              const userWithServerAvatar = {\n                ...activeProfile,\n                id: activeProfile.id,\n                dbId: serverUserResponse.user.id,\n                avatar: avatarToUse,\n                avatarType: avatarTypeToUse,\n                fullName: serverUserResponse.user.fullName ?? activeProfile.fullName,\n              };\n              setUser(userWithServerAvatar);\n              \n              try {\n                setUserToLocalStorage(userWithServerAvatar);\n              } catch (localError) {\n                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å user –≤ localStorage:', localError);\n              }\n              \n              setProfileAvatarSafe(activeId, avatarToUse);\n            } else {\n              console.log('‚ö†Ô∏è –ê–≤–∞—Ç–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞:', {\n                serverAvatar: serverAvatar,\n                type: typeof serverAvatar,\n                length: serverAvatar?.length || 0,\n                isEmpty: !serverAvatar || serverAvatar.trim().length === 0\n              });\n            }\n            \n            if (serverUserResponse?.user?.fullName || serverUserResponse?.user?.id) {\n              const userWithFullName = {\n                ...activeProfile,\n                fullName: serverUserResponse.user.fullName ?? activeProfile.fullName,\n                dbId: serverUserResponse.user.id,\n              };\n              setUser(userWithFullName);\n              try {\n                const stored = localStorage.getItem('user');\n                const base = stored ? JSON.parse(stored) : {};\n                setUserToLocalStorage({ ...base, fullName: serverUserResponse.user.fullName });\n              } catch (e) {  }\n            }\n          } else {\n            console.log('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', serverUserResponse);\n          }\n        } catch (serverError) {\n          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', serverError);\n          console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', {\n            message: serverError.message,\n            response: serverError.response?.data,\n            status: serverError.response?.status\n          });\n        }\n        \n        \n        if (!avatarToUse) {\n          try {\n            const userRaw = localStorage.getItem('user');\n            if (userRaw) {\n              const userData = JSON.parse(userRaw);\n              if (userData.avatar) {\n                avatarToUse = userData.avatar;\n                avatarTypeToUse = detectAvatarType(avatarToUse) || userData.avatarType || 'image';\n                console.log('‚úÖ –ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ localStorage.user');\n              }\n            }\n          } catch (localError) {\n            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ user –∏–∑ localStorage:', localError);\n          }\n        }\n        \n        \n        if (!avatarToUse) {\n          try {\n            const avatarFromStorage = localStorage.getItem(`profile_avatar_${activeId}`);\n            if (avatarFromStorage) {\n              avatarToUse = avatarFromStorage;\n              avatarTypeToUse = detectAvatarType(avatarFromStorage);\n              console.log('‚úÖ –ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞');\n            }\n          } catch (storageError) {\n            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞ –∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:', storageError);\n          }\n        }\n        \n        \n        if (!avatarToUse && (activeProfile.avatar || activeProfile.profile_image)) {\n          avatarToUse = activeProfile.avatar || activeProfile.profile_image;\n          avatarTypeToUse = detectAvatarType(avatarToUse) || activeProfile.avatarType || 'image';\n          console.log('‚úÖ –ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è');\n        }\n        \n        if (avatarToUse) {\n          console.log('‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä:', {\n            hasAvatar: true,\n            type: avatarTypeToUse,\n            length: avatarToUse.length\n          });\n\n          \n          setAvatar(avatarToUse);\n          setAvatarType(avatarTypeToUse);\n\n          \n          const userWithAvatar = {\n            ...activeProfile,\n            avatar: avatarToUse,\n            avatarType: avatarTypeToUse,\n          };\n          setUser(userWithAvatar);\n\n          setUserToLocalStorage(userWithAvatar);\n        } else {\n          console.warn('‚ö†Ô∏è –ê–≤–∞—Ç–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –≤ –æ–¥–Ω–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ');\n          setAvatar(null);\n        }\n\n        \n        localStorage.setItem('profiles', JSON.stringify(list));\n        localStorage.setItem('activeProfileId', activeId);\n        const finalUser = user || activeProfile;\n        if (finalUser) {\n          setUserToLocalStorage(finalUser);\n        }\n\n        if (isMounted) {\n          setLoading(false);\n        }\n      } catch (error) {\n        console.error('Profile initialization error:', error);\n        if (isMounted) {\n          setLoading(false);\n          navigate('/profile/edit');\n        }\n      }\n    };\n\n    initializeProfile();\n\n    return () => {\n      isMounted = false;\n    };\n  }, [navigate, usernameParam]);\n\n  \n  useEffect(() => {\n    const handleStorageChange = () => {\n      const userRaw = localStorage.getItem('user');\n      const activeIdRaw = localStorage.getItem('activeProfileId');\n      if (userRaw && activeIdRaw) {\n        try {\n          const updatedUser = JSON.parse(userRaw);\n          const activeId = activeIdRaw;\n          if (updatedUser.id === activeId && updatedUser.profileCompleted) {\n            setUser(updatedUser);\n            \n            if (updatedUser.avatar || updatedUser.profile_image) {\n              setAvatar(updatedUser.avatar || updatedUser.profile_image);\n              setAvatarType(updatedUser.avatarType || 'image');\n            }\n          }\n        } catch (error) {\n          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ localStorage:', error);\n        }\n      }\n    };\n\n   \n    window.addEventListener('storage', handleStorageChange);\n    \n    \n    window.addEventListener('focus', handleStorageChange);\n\n    return () => {\n      window.removeEventListener('storage', handleStorageChange);\n      window.removeEventListener('focus', handleStorageChange);\n    };\n  }, []);\n\n  \n  useEffect(() => {\n    if (loading || !user) return;\n    const currentAvatar = avatar || user.avatar;\n    if (currentAvatar) return; \n    let cancelled = false;\n    (async () => {\n      try {\n        const res = await authAPI.getCurrentUser();\n        if (cancelled || !res?.user) return;\n        const serverAvatar = res.user.avatar;\n        if (serverAvatar && typeof serverAvatar === 'string' && serverAvatar.trim().length > 0) {\n          setAvatar(serverAvatar);\n          setAvatarType(res.user.avatarType || (serverAvatar.startsWith('data:video/') ? 'video' : 'image'));\n          setUser((prev) => ({ ...prev, avatar: serverAvatar, avatarType: res.user.avatarType || 'image' }));\n          const activeId = activeProfileId || localStorage.getItem('activeProfileId');\n          if (activeId) setProfileAvatarSafe(activeId, serverAvatar);\n          try {\n            const stored = localStorage.getItem('user');\n            const base = stored ? JSON.parse(stored) : {};\n            setUserToLocalStorage({ ...base, avatar: serverAvatar, avatarType: res.user.avatarType || 'image' });\n          } catch (e) {  }\n        }\n      } catch (e) {\n        if (!cancelled) console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä —Å —Å–µ—Ä–≤–µ—Ä–∞:', e);\n      }\n    })();\n    return () => { cancelled = true; };\n  }, [loading, user?.id, activeProfileId]);\n\n  \n  useEffect(() => {\n    if (loading) {\n      return; \n    }\n\n    const loadPosts = async () => {\n      try {\n        \n        const response = await postsAPI.getMyPosts(activeProfileId);\n        if (response.success) {\n          setPosts(response.posts || []);\n          setPostsLoading(false);\n          return;\n        }\n      } catch (error) {\n        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ—Å—Ç–æ–≤ –ø–æ profileId, –ø—Ä–æ–±—É–µ–º –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞:', error);\n      }\n      \n      try {\n        const response = await postsAPI.getMyPosts();\n        if (response.success) {\n          const all = response.posts || [];\n          const filtered = activeProfileId\n            ? all.filter((p) => p.profileId === activeProfileId || !p.profileId)\n            : all;\n          setPosts(filtered);\n        }\n      } catch (fallbackError) {\n        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ—Å—Ç–æ–≤ –ø—Ä–æ—Ñ–∏–ª—è:', fallbackError);\n      } finally {\n        setPostsLoading(false);\n      }\n    };\n\n    \n    if (activeProfileId) {\n      loadPosts();\n    } else {\n      setPostsLoading(false);\n    }\n  }, [loading, activeProfileId]);\n\n  \n  useEffect(() => {\n    const loadPostWithComments = async () => {\n      if (!selectedPost) {\n        setPostComments([]);\n        setReplyingTo(null);\n        setReplyText('');\n        setExpandedReplies(new Set());\n        return;\n      }\n\n      try {\n        const response = await postsAPI.getPostById(selectedPost.id);\n        if (response.success && response.post) {\n          setPostComments(response.post.comments || []);\n          \n          setSelectedPost((prev) => ({\n            ...prev,\n            likesCount: response.post.likesCount || 0,\n            commentsCount: response.post.commentsCount || 0,\n            viewsCount: response.post.viewsCount || 0,\n          }));\n        }\n      } catch (error) {\n        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', error);\n        setPostComments([]);\n      }\n    };\n\n    loadPostWithComments();\n  }, [selectedPost]);\n\n  \n  useEffect(() => {\n    if (!selectedPost || !focusCommentWhenOpen) return;\n    const t = setTimeout(() => {\n      commentInputRef.current?.focus();\n      setFocusCommentWhenOpen(false);\n    }, 300);\n    return () => clearTimeout(t);\n  }, [selectedPost, focusCommentWhenOpen]);\n\n  \n  useEffect(() => {\n    if (!miniChatPostId) {\n      setMiniChatComments([]);\n      setMiniChatNewText('');\n      return;\n    }\n    (async () => {\n      try {\n        const res = await postsAPI.getPostById(miniChatPostId);\n        if (res.success && res.post) setMiniChatComments(res.post.comments || []);\n      } catch (e) {\n        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –º–∏–Ω–∏-—á–∞—Ç–∞:', e);\n      }\n    })();\n  }, [miniChatPostId]);\n\n  const handleToggleLike = async (post, e) => {\n    e.stopPropagation();\n    if (likingPostId) return;\n    setLikingPostId(post.id);\n    try {\n      const res = await postsAPI.toggleLike(post.id);\n      if (res.success) {\n        setPosts((prev) =>\n          prev.map((p) =>\n            p.id === post.id\n              ? { ...p, liked: res.liked, likesCount: res.likesCount ?? (p.likesCount || 0) + (res.liked ? 1 : -1) }\n              : p\n          )\n        );\n      }\n    } catch (err) {\n      console.error('–û—à–∏–±–∫–∞ –ª–∞–π–∫–∞:', err);\n    } finally {\n      setLikingPostId(null);\n    }\n  };\n\n  const handleMiniChatSubmit = async (e) => {\n    e.preventDefault();\n    if (!miniChatPostId || !miniChatNewText.trim() || miniChatLoading) return;\n    setMiniChatLoading(true);\n    try {\n      const res = await postsAPI.addComment(miniChatPostId, miniChatNewText.trim());\n      if (res.success && res.comment) {\n        setMiniChatComments((prev) => [...prev, res.comment]);\n        setMiniChatNewText('');\n        setPosts((prev) =>\n          prev.map((p) =>\n            p.id === miniChatPostId ? { ...p, commentsCount: (p.commentsCount || 0) + 1 } : p\n          )\n        );\n      }\n    } catch (err) {\n      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', err);\n    } finally {\n      setMiniChatLoading(false);\n    }\n  };\n\n  const handleStartEditPost = (post) => {\n    if (!post) return;\n    setSelectedPost(post);\n    setEditingPostId(post.id);\n    setEditingTitle(post.title != null ? String(post.title) : '');\n    setEditingCaption(post.caption || '');\n    setEditingMedia(null);\n    setPostMenuPostId(null);\n  };\n\n  const handleEditMediaChange = (e) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n    const isVideo = file.type.startsWith('video/');\n    const isImage = file.type.startsWith('image/');\n    if (!isImage && !isVideo) {\n      return;\n    }\n    const reader = new FileReader();\n    reader.onload = () => {\n      setEditingMedia(reader.result);\n    };\n    reader.readAsDataURL(file);\n    e.target.value = '';\n  };\n\n  const handleSaveEditedPost = async () => {\n    if (!editingPostId) return;\n    const trimmedTitle = (editingTitle || '').trim();\n    const trimmedCaption = (editingCaption || '').trim();\n    setEditingCaptionSaving(true);\n    try {\n      const postId = String(editingPostId);\n      const payload = { title: trimmedTitle, caption: trimmedCaption };\n      if (editingMedia) {\n        payload.image = editingMedia;\n        payload.images = [editingMedia];\n        payload.isVideo = editingMedia.startsWith('data:video/');\n      }\n      const res = await postsAPI.updatePost(postId, payload);\n      if (res && res.success) {\n        const updated = {\n          title: res.post?.title != null ? String(res.post.title) : trimmedTitle,\n          caption: trimmedCaption,\n          ...(res.post?.image && {\n            image: res.post.image,\n            images: res.post.images?.length ? res.post.images : [res.post.image],\n          }),\n          ...(res.post?.isVideo !== undefined && { isVideo: res.post.isVideo }),\n        };\n        setPosts((prev) =>\n          prev.map((p) => (String(p.id) === postId ? { ...p, ...updated } : p))\n        );\n        closePostModal();\n      } else {\n        console.warn('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–∞: –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç API', res);\n      }\n    } catch (error) {\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ—Å—Ç–∞:', error);\n    } finally {\n      setEditingCaptionSaving(false);\n    }\n  };\n\n  const handleCancelEditPost = () => {\n    setEditingPostId(null);\n    setEditingTitle('');\n    setEditingCaption('');\n    setEditingMedia(null);\n  };\n\n \n  const closePostModal = () => {\n    setSelectedPost(null);\n    setEditingPostId(null);\n    setEditingTitle('');\n    setEditingCaption('');\n    setEditingMedia(null);\n    setNewCommentText('');\n    setReplyingTo(null);\n    setReplyText('');\n    setFocusCommentWhenOpen(false);\n  };\n\n  const handleDeletePost = async (post) => {\n    if (!post) return;\n    if (!window.confirm('Do you really want to delete this post?')) return;\n    setPostMenuPostId(null);\n    try {\n      await postsAPI.deletePost(post.id);\n      setPosts((prev) => prev.filter((p) => p.id !== post.id));\n      try {\n        const profileId = activeProfileId;\n        if (profileId) {\n          const map = JSON.parse(localStorage.getItem('profilePostsMap') || '{}');\n          const listForProfile = map[profileId] || [];\n          map[profileId] = listForProfile.filter((pid) => pid !== post.id);\n          localStorage.setItem('profilePostsMap', JSON.stringify(map));\n        }\n      } catch {\n        \n      }\n    } catch (error) {\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞:', error);\n    }\n  };\n\n  const handleAssignPostToProfile = async (postId, targetProfileId) => {\n    try {\n      const res = await postsAPI.updatePost(postId, { profileId: targetProfileId });\n      if (res.success) {\n        setPosts((prev) => prev.filter((p) => p.id !== postId));\n        setRemoveFromProfilePostId(null);\n      }\n    } catch (err) {\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –ø–æ—Å—Ç–∞ –≤ –¥—Ä—É–≥–æ–π –ø—Ä–æ—Ñ–∏–ª—å:', err);\n    }\n  };\n\n  const handleAvatarChange = (e) => {\n    const file = e.target.files[0];\n    if (file) {\n      setAvatarFile(file);\n      const isVideo = file.type.startsWith('video/');\n      setAvatarType(isVideo ? 'video' : 'image');\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setAvatar(reader.result);\n      };\n      reader.readAsDataURL(file);\n    }\n  };\n\n  const handleAvatarSave = async () => {\n    if (!avatarFile || !avatar) {\n      console.warn('‚ö†Ô∏è –ù–µ–ª—å–∑—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä: –Ω–µ—Ç —Ñ–∞–π–ª–∞ –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö');\n      return;\n    }\n    \n    try {\n      console.log('üíæ –ù–∞—á–∏–Ω–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞:', {\n        hasAvatar: !!avatar,\n        avatarLength: avatar.length,\n        avatarType: avatarType,\n        avatarPreview: avatar.substring(0, 50)\n      });\n      \n      \n      const response = await authAPI.updateAvatar(avatar);\n      \n      console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ updateAvatar:', {\n        hasResponse: !!response,\n        hasUser: !!response?.user,\n        hasAvatar: !!response?.user?.avatar,\n        avatarLength: response?.user?.avatar?.length || 0\n      });\n\n      \n      const savedAvatar = response?.user?.avatar || avatar;\n      const updatedUser = {\n        ...(user || {}),\n        avatar: savedAvatar,\n        avatarType: avatarType,\n      };\n\n      console.log('‚úÖ –ê–≤–∞—Ç–∞—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ');\n      setUser(updatedUser);\n      setAvatar(savedAvatar); \n\n      const activeId = activeProfileId || localStorage.getItem('activeProfileId');\n      if (activeId) setProfileAvatarSafe(activeId, savedAvatar);\n\n      \n      try {\n        const stored = localStorage.getItem('user');\n        const base = stored ? JSON.parse(stored) : {};\n        const merged = { ...base, ...updatedUser };\n        setUserToLocalStorage(merged);\n      } catch (localError) {\n        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ user –≤ localStorage:', localError);\n      }\n\n      \n      try {\n        const profilesRaw = localStorage.getItem('profiles');\n        if (profilesRaw) {\n          const profilesList = JSON.parse(profilesRaw) || [];\n          const activeId = activeProfileId || localStorage.getItem('activeProfileId');\n          \n          if (activeId) {\n            const updatedProfiles = profilesList.map((p) =>\n              p.id === activeId\n                ? { ...p, avatar: '', avatarType: avatarType } \n                : p\n            );\n            localStorage.setItem('profiles', JSON.stringify(updatedProfiles));\n\n            \n            try {\n              let serverProfiles = [];\n              try {\n                const currentUserRes = await authAPI.getCurrentUser();\n                serverProfiles = currentUserRes?.user?.profiles || [];\n              } catch (_) {}\n\n              const profilesForServer = updatedProfiles.map((p) => {\n                const fromServer = serverProfiles.find((s) => s && String(s.id) === String(p.id));\n                const avatar = p.id === activeId ? savedAvatar : (fromServer?.avatar ?? p.avatar ?? '');\n                return { ...p, avatar };\n              });\n              await authAPI.updateProfiles(profilesForServer);\n            } catch (serverError) {\n              console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', serverError);\n            }\n          }\n        }\n      } catch (profilesError) {\n        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ profiles:', profilesError);\n      }\n\n      setAvatarFile(null);\n      console.log('‚úÖ –ê–≤–∞—Ç–∞—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ—Ñ–∏–ª—å');\n      \n      \n      try {\n        const freshUser = await authAPI.getCurrentUser();\n        if (freshUser?.user?.avatar) {\n          setAvatar(freshUser.user.avatar);\n          setAvatarType(freshUser.user.avatarType || avatarType);\n          setUser((prev) => ({ ...prev, avatar: freshUser.user.avatar, avatarType: freshUser.user.avatarType || avatarType }));\n          const activeId = activeProfileId || localStorage.getItem('activeProfileId');\n          if (activeId) setProfileAvatarSafe(activeId, freshUser.user.avatar);\n          setUserToLocalStorage({ ...(typeof localStorage.getItem('user') === 'string' ? JSON.parse(localStorage.getItem('user') || '{}') : {}), ...updatedUser, avatar: freshUser.user.avatar });\n        }\n      } catch (e) {\n        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);\n      }\n      \n      \n      setAvatar(savedAvatar);\n      setAvatarType(avatarType);\n    } catch (error) {\n      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞:', error);\n      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');\n    }\n  };\n\n  if (loading) {\n    return <div className=\"profile-loading\">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;\n  }\n\n  if (profileNotFound) {\n    return (\n      <div className=\"profile-loading\">\n        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</p>\n        <Link to=\"/\">–ù–∞ –≥–ª–∞–≤–Ω—É—é</Link>\n      </div>\n    );\n  }\n\n  \n  if (viewUser) {\n    const handleFollowClick = async () => {\n      if (followLoading || !viewUser.id) return;\n      setFollowLoading(true);\n      try {\n        const res = await usersAPI.toggleFollow(viewUser.id);\n        setViewUser((prev) => ({\n          ...prev,\n          isFollowing: res.isFollowing,\n          followersCount: res.followersCount ?? prev.followersCount,\n        }));\n      } catch (e) {\n        console.error('Follow error:', e);\n      } finally {\n        setFollowLoading(false);\n      }\n    };\n\n    return (\n      <div className=\"profile-container\">\n        <aside className=\"profile-sidebar\">\n          <div className=\"sidebar-logo\">ICHGRAM</div>\n          <nav className=\"sidebar-nav\">\n            <Link to=\"/\" className=\"nav-item\">\n              <div className=\"nav-icon-placeholder\">\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z\"></path>\n                  <polyline points=\"9 22 9 12 15 12 15 22\"></polyline>\n                </svg>\n              </div>\n              <span>Home</span>\n            </Link>\n            <Link to=\"/search\" className=\"nav-item\">\n              <div className=\"nav-icon-placeholder\">\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <circle cx=\"11\" cy=\"11\" r=\"8\"></circle>\n                  <path d=\"m21 21-4.35-4.35\"></path>\n                </svg>\n              </div>\n              <span>Search</span>\n            </Link>\n            <Link to=\"/explore\" className=\"nav-item\">\n              <div className=\"nav-icon-placeholder\">\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <polygon points=\"12 2 2 7 12 12 22 7 12 2\"></polygon>\n                  <polyline points=\"2 17 12 22 22 17\"></polyline>\n                  <polyline points=\"2 12 12 17 22 12\"></polyline>\n                </svg>\n              </div>\n              <span>Explore</span>\n            </Link>\n            <Link to=\"/messages\" className=\"nav-item\">\n              <div className=\"nav-icon-placeholder\">\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\"></path>\n                </svg>\n              </div>\n              <span>Messages</span>\n            </Link>\n            <Link to=\"/notifications\" className=\"nav-item\">\n              <div className=\"nav-icon-placeholder\">\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z\"></path>\n                </svg>\n              </div>\n              <span>Notifications</span>\n            </Link>\n            <button\n              className=\"nav-item\"\n              type=\"button\"\n              onClick={openCreateModal}\n              style={{ background: 'none', border: 'none', width: '100%', textAlign: 'left', cursor: 'pointer' }}\n            >\n              <div className=\"nav-icon-placeholder\">\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"></rect>\n                  <line x1=\"12\" y1=\"8\" x2=\"12\" y2=\"16\"></line>\n                  <line x1=\"8\" y1=\"12\" x2=\"16\" y2=\"12\"></line>\n                </svg>\n              </div>\n              <span>Create</span>\n            </button>\n            <Link to=\"/profile\" className=\"nav-item active\">\n              <div className=\"nav-icon-placeholder\">\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"></path>\n                  <circle cx=\"12\" cy=\"7\" r=\"4\"></circle>\n                </svg>\n              </div>\n              <span>Profile</span>\n            </Link>\n          </nav>\n          {user && (\n            <Link to=\"/profile\" className=\"sidebar-current-user\">\n              <div className=\"sidebar-current-avatar\">\n                {user.avatar ? (\n                  (user.avatarType === 'video' || (typeof user.avatar === 'string' && user.avatar.startsWith('data:video/'))) ? (\n                    <video src={user.avatar} className=\"profile-avatar-image\" autoPlay loop muted playsInline />\n                  ) : (\n                    <img src={user.avatar} alt={user.username || 'avatar'} className=\"profile-avatar-image\" />\n                  )\n                ) : (\n                  <span className=\"sidebar-current-initial\">\n                    {(user.username || 'U').charAt(0).toUpperCase()}\n                  </span>\n                )}\n              </div>\n              <div className=\"sidebar-current-info\">\n                <span className=\"sidebar-current-name\">\n                  {user.fullName || (user.username ? user.username.replace(/^@/, '') : '') || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}\n                </span>\n                <span className=\"sidebar-current-username\">\n                  {user.username || ''}\n                </span>\n              </div>\n            </Link>\n          )}\n        </aside>\n        <main className=\"profile-main\">\n          <header className=\"profile-header\">\n            <h1 className=\"profile-title\">{viewUser.username || 'Profile'}</h1>\n          </header>\n          <section className=\"profile-section\">\n            <div className=\"profile-info\">\n              <div className=\"profile-avatar-container\">\n                <div className=\"profile-avatar-wrapper\">\n                  {viewUser.avatar ? (\n                    viewUser.avatarType === 'video' ? (\n                      <video src={viewUser.avatar} className=\"profile-avatar-image\" autoPlay loop muted playsInline />\n                    ) : (\n                      <img src={viewUser.avatar} alt=\"\" className=\"profile-avatar-image\" />\n                    )\n                  ) : (\n                    <div className=\"profile-avatar-placeholder\">\n                      {(viewUser.username || 'U').charAt(0).toUpperCase()}\n                    </div>\n                  )}\n                </div>\n              </div>\n              <div className=\"profile-details\">\n                <div className=\"profile-username-row\">\n                  <h2 className=\"profile-username\">{viewUser.username || ''}</h2>\n                  <Link\n                    to={`/messages?user=${viewUser.id}`}\n                    className=\"profile-message-btn\"\n                    title=\"Message him\"\n                  >\n                    <svg className=\"profile-message-btn-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                      <path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\"></path>\n                    </svg>\n                    <span>Message</span>\n                  </Link>\n                  <button\n                    type=\"button\"\n                    className=\"profile-edit-btn\"\n                    onClick={handleFollowClick}\n                    disabled={followLoading}\n                  >\n                    {viewUser.isFollowing ? 'Unfollow' : 'Follow'}\n                  </button>\n                </div>\n                <div className=\"profile-stats\">\n                  <div className=\"stat-item\">\n                    <span className=\"stat-number\">{viewUser.postsCount ?? posts.length}</span>\n                    <span className=\"stat-label\">posts</span>\n                  </div>\n                  <div className=\"stat-item\">\n                    <span className=\"stat-number\">{viewUser.followersCount ?? 0}</span>\n                    <span className=\"stat-label\">followers</span>\n                  </div>\n                  <div className=\"stat-item\">\n                    <span className=\"stat-number\">{viewUser.followingCount ?? 0}</span>\n                    <span className=\"stat-label\">following</span>\n                  </div>\n                </div>\n                {viewUser.bio ? (\n                  <div className=\"profile-bio\"><p>{viewUser.bio}</p></div>\n                ) : null}\n              </div>\n            </div>\n          </section>\n          <div className=\"profile-posts-grid profile-posts-empty\">\n            {postsLoading ? (\n              <div className=\"post-item\"><div className=\"post-image-placeholder\">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div></div>\n            ) : posts.length === 0 ? (\n              <div className=\"post-item\"><div className=\"post-image-placeholder\">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤</div></div>\n            ) : (\n              posts.map((post) => (\n                <div key={post.id} className=\"post-item-wrapper\">\n                  <div\n                    className=\"post-item\"\n                    onClick={() => setSelectedPost(post)}\n                  >\n                    {post.isVideo || (post.image && post.image.startsWith?.('data:video/')) ? (\n                      <video src={post.image} className=\"post-item-image\" muted />\n                    ) : (\n                      <img src={post.image || ''} alt=\"\" className=\"post-item-image\" />\n                    )}\n                  </div>\n                </div>\n              ))\n            )}\n          </div>\n        </main>\n      </div>\n    );\n  }\n\n  \n  const currentProfileAvatar =\n    avatar ||\n    user?.avatar ||\n    (activeProfileId\n      ? (() => {\n          try {\n            return localStorage.getItem(`profile_avatar_${activeProfileId}`) || null;\n          } catch {\n            return null;\n          }\n        })()\n      : null);\n  const currentProfileAvatarType =\n    avatarType ||\n    user?.avatarType ||\n    (currentProfileAvatar?.startsWith?.('data:video/') ? 'video' : 'image');\n\n  \n  const getAvatarForProfileId = (profileId) => {\n    if (!profileId || profileId === activeProfileId) return currentProfileAvatar;\n    try {\n      return localStorage.getItem(`profile_avatar_${profileId}`) || null;\n    } catch {\n      return null;\n    }\n  };\n  const getAvatarTypeForProfileId = (profileId) => {\n    const av = getAvatarForProfileId(profileId);\n    return av?.startsWith?.('data:video/') ? 'video' : 'image';\n  };\n\n  const postsCount = posts.length || user?.postsCount || 0;\n  const followersCount = user?.followersCount ?? 0;\n  const followingCount = user?.followingCount ?? 0;\n\n  const aboutText = user?.about || '';\n  const shouldTruncateBio = aboutText.length > 140;\n  const visibleBioText = shouldTruncateBio && !isBioExpanded\n    ? aboutText.slice(0, 140)\n    : aboutText;\n\n  const handleEditProfileClick = () => {\n   \n    navigate('/profile/edit', { state: { mode: 'edit' } });\n  };\n\n  const handleCreateNewProfileClick = () => {\n   \n    const newProfile = {\n      id: `profile-${Date.now()}`,\n      username: '',\n      website: '',\n      about: '',\n      avatar: '', \n      avatarType: 'image',\n      profileCompleted: false,\n      postsCount: 0,\n      followersCount: 0,\n      followingCount: 0,\n    };\n\n    const updatedProfiles = [...profiles, newProfile];\n    setProfiles(updatedProfiles);\n    setUser(newProfile);\n    setAvatar(null);\n    setAvatarType('image');\n    setActiveProfileId(newProfile.id);\n\n    \n    localStorage.setItem('profiles', JSON.stringify(updatedProfiles));\n    localStorage.setItem('activeProfileId', newProfile.id);\n    setUserToLocalStorage(newProfile);\n\n    navigate('/profile/edit', { state: { mode: 'create' } });\n  };\n\n  const handleProfileSwitch = (profileId) => {\n    if (!profileId || profileId === activeProfileId) return;\n\n    let list = profiles.length\n      ? profiles\n      : (() => {\n          try {\n            return uniqueProfilesById(JSON.parse(localStorage.getItem('profiles') || '[]') || []);\n          } catch {\n            return [];\n          }\n        })();\n    list = uniqueProfilesById(list);\n\n    const selected = list.find((p) => p.id === profileId);\n    if (!selected) return;\n\n    setActiveProfileId(profileId);\n    setPostsLoading(true);\n    setPosts([]);\n    \n    \n    let avatarToUse = null;\n    try {\n      const avatarFromStorage = localStorage.getItem(`profile_avatar_${profileId}`);\n      if (avatarFromStorage) {\n        avatarToUse = avatarFromStorage;\n      }\n    } catch {}\n    \n    if (!avatarToUse && (selected.avatar || selected.profile_image)) {\n      avatarToUse = selected.avatar || selected.profile_image;\n    }\n    \n    const userWithAvatar = { ...selected, avatar: avatarToUse || '' };\n    setUser(userWithAvatar);\n    \n    const typeToUse = selected.avatarType || (avatarToUse?.startsWith?.('data:video/') ? 'video' : 'image');\n    if (avatarToUse) {\n      setAvatar(avatarToUse);\n      setAvatarType(typeToUse);\n    } else {\n      setAvatar(null);\n     \n      (async () => {\n        try {\n          const res = await authAPI.getCurrentUser();\n          if (res?.user?.avatar && typeof res.user.avatar === 'string' && res.user.avatar.trim().length > 0) {\n            setAvatar(res.user.avatar);\n            setAvatarType(res.user.avatarType || (res.user.avatar.startsWith('data:video/') ? 'video' : 'image'));\n            setUser((prev) => ({ ...prev, avatar: res.user.avatar, avatarType: res.user.avatarType || 'image' }));\n            setProfileAvatarSafe(profileId, res.user.avatar);\n          }\n        } catch (e) {\n          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è:', e);\n        }\n      })();\n    }\n\n    localStorage.setItem('activeProfileId', profileId);\n    setUserToLocalStorage(userWithAvatar);\n    localStorage.setItem('profiles', JSON.stringify(list));\n  };\n\n  \n  const handleAddComment = async (e) => {\n    e.preventDefault();\n    if (!selectedPost || !newCommentText.trim() || commentLoading) return;\n\n    setCommentLoading(true);\n    try {\n      const response = await postsAPI.addComment(selectedPost.id, newCommentText.trim());\n      if (response.success && response.comment) {\n        setPostComments((prev) => [...prev, response.comment]);\n        \n        setSelectedPost((prev) => ({\n          ...prev,\n          commentsCount: (prev?.commentsCount || 0) + 1,\n        }));\n        \n        setPosts((prevPosts) =>\n          prevPosts.map((post) =>\n            post.id === selectedPost.id\n              ? { ...post, commentsCount: (post.commentsCount || 0) + 1 }\n              : post\n          )\n        );\n        setNewCommentText('');\n      }\n    } catch (error) {\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', error);\n    } finally {\n      setCommentLoading(false);\n    }\n  };\n\n  \n  const handleAddReply = async (commentId, e) => {\n    e.preventDefault();\n    if (!selectedPost || !replyText.trim() || commentLoading) return;\n\n    setCommentLoading(true);\n    try {\n      const response = await postsAPI.addComment(selectedPost.id, replyText.trim(), commentId);\n      if (response.success && response.comment) {\n        \n        const postResponse = await postsAPI.getPostById(selectedPost.id);\n        if (postResponse.success && postResponse.post) {\n          setPostComments(postResponse.post.comments || []);\n        }\n        setReplyText('');\n        setReplyingTo(null);\n      }\n    } catch (error) {\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞:', error);\n    } finally {\n      setCommentLoading(false);\n    }\n  };\n\n  \n  const handleSendMessage = () => {\n    if (selectedPost?.user?.id) {\n      navigate(`/messages?user=${selectedPost.user.id}`);\n    } else {\n      navigate('/messages');\n    }\n  };\n\n  return (\n    <div className=\"profile-container\">\n      {}\n      <aside className=\"profile-sidebar\">\n        <div className=\"sidebar-logo\">ICHGRAM</div>\n        <nav className=\"sidebar-nav\">\n          <Link to=\"/\" className=\"nav-item\">\n            <div className=\"nav-icon-placeholder\">\n              <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z\"></path>\n                <polyline points=\"9 22 9 12 15 12 15 22\"></polyline>\n              </svg>\n            </div>\n            <span>Home</span>\n          </Link>\n          <Link to=\"/search\" className=\"nav-item\">\n            <div className=\"nav-icon-placeholder\">\n              <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <circle cx=\"11\" cy=\"11\" r=\"8\"></circle>\n                <path d=\"m21 21-4.35-4.35\"></path>\n              </svg>\n            </div>\n            <span>Search</span>\n          </Link>\n          <Link to=\"/explore\" className=\"nav-item\">\n            <div className=\"nav-icon-placeholder\">\n              <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <polygon points=\"12 2 2 7 12 12 22 7 12 2\"></polygon>\n                <polyline points=\"2 17 12 22 22 17\"></polyline>\n                <polyline points=\"2 12 12 17 22 12\"></polyline>\n              </svg>\n            </div>\n            <span>Explore</span>\n          </Link>\n          <Link to=\"/messages\" className=\"nav-item\">\n            <div className=\"nav-icon-placeholder\">\n              <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\"></path>\n              </svg>\n            </div>\n            <span>Messages</span>\n          </Link>\n          <Link to=\"/notifications\" className=\"nav-item\">\n            <div className=\"nav-icon-placeholder\">\n              <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z\"></path>\n              </svg>\n            </div>\n            <span>Notifications</span>\n          </Link>\n          <button\n            className=\"nav-item\"\n            type=\"button\"\n            onClick={openCreateModal}\n            style={{ background: 'none', border: 'none', width: '100%', textAlign: 'left', cursor: 'pointer' }}\n          >\n            <div className=\"nav-icon-placeholder\">\n              <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"></rect>\n                <line x1=\"12\" y1=\"8\" x2=\"12\" y2=\"16\"></line>\n                <line x1=\"8\" y1=\"12\" x2=\"16\" y2=\"12\"></line>\n              </svg>\n            </div>\n            <span>Create</span>\n          </button>\n          <Link to=\"/profile\" className=\"nav-item active\">\n            <div className=\"nav-icon-placeholder\">\n              <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"></path>\n                <circle cx=\"12\" cy=\"7\" r=\"4\"></circle>\n              </svg>\n            </div>\n            <span>Profile</span>\n          </Link>\n        </nav>\n\n        {}\n        {user && (\n          <Link to=\"/profile\" className=\"sidebar-current-user\">\n            <div className=\"sidebar-current-avatar\">\n              {currentProfileAvatarType === 'video' && currentProfileAvatar ? (\n                <video\n                  src={currentProfileAvatar}\n                  className=\"profile-avatar-image\"\n                  autoPlay\n                  loop\n                  muted\n                  playsInline\n                />\n              ) : currentProfileAvatar ? (\n                <img src={currentProfileAvatar} alt={user.username || 'avatar'} className=\"profile-avatar-image\" />\n              ) : (\n                <span className=\"sidebar-current-initial\">\n                  {(user?.username || 'U').charAt(0).toUpperCase()}\n                </span>\n              )}\n            </div>\n            <div className=\"sidebar-current-info\">\n              <span className=\"sidebar-current-name\">\n                {user.fullName || (user.username ? user.username.replace(/^@/, '') : '') || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}\n              </span>\n              <span className=\"sidebar-current-username\">\n                {user.username || ''}\n              </span>\n            </div>\n          </Link>\n        )}\n      </aside>\n\n      {}\n      <main className=\"profile-main\">\n        {}\n        <header className=\"profile-header\">\n          <h1 className=\"profile-title\">My profile</h1>\n        </header>\n\n        {}\n        <section className=\"profile-section\">\n          <div className=\"profile-info\">\n            {}\n            <div className=\"profile-avatar-container\">\n              <div \n                className=\"profile-avatar-wrapper\"\n                onClick={() => {\n                  const input = document.getElementById('avatar-upload');\n                  if (input) input.click();\n                }}\n                style={{ cursor: 'pointer' }}\n              >\n                {currentProfileAvatar ? (\n                  currentProfileAvatarType === 'video' ? (\n                    <video\n                      src={currentProfileAvatar}\n                      className=\"profile-avatar-image\"\n                      autoPlay\n                      loop\n                      muted\n                      playsInline\n                      onError={(e) => {\n                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–µ–æ-–∞–≤–∞—Ç–∞—Ä–∞:', e);\n                      }}\n                    />\n                  ) : (\n                    <img \n                      src={currentProfileAvatar} \n                      alt=\"Profile\" \n                      className=\"profile-avatar-image\"\n                      onError={(e) => {\n                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è-–∞–≤–∞—Ç–∞—Ä–∞:', e);\n                      }}\n                    />\n                  )\n                ) : (\n                  <div className=\"profile-avatar-placeholder\">\n                    {}\n                  </div>\n                )}\n                <label htmlFor=\"avatar-upload\" className=\"profile-avatar-edit\">\n                  <input\n                    type=\"file\"\n                    id=\"avatar-upload\"\n                    accept=\"image/*,video/*\"\n                    onChange={handleAvatarChange}\n                    style={{ display: 'none' }}\n                  />\n                  <span className=\"profile-avatar-edit-icon\">üì∑</span>\n                </label>\n              </div>\n              {avatarFile && (\n                <button \n                  className=\"profile-avatar-save-btn\"\n                  onClick={handleAvatarSave}\n                >\n                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ\n                </button>\n              )}\n            </div>\n\n            {}\n            <div className=\"profile-details\">\n              <div className=\"profile-username-row\">\n                <h2 className=\"profile-username\">\n                  {user?.username || 'itcareerhub'}\n                </h2>\n                {(() => {\n                  const listForSwitcher = uniqueProfilesById(profiles);\n                  return listForSwitcher.length > 1 && (\n                    <select\n                      className=\"profile-switcher\"\n                      value={activeProfileId || ''}\n                      onChange={(e) => handleProfileSwitch(e.target.value)}\n                    >\n                      {listForSwitcher.map((p) => (\n                        <option key={p.id} value={p.id}>\n                          {p.username || p.fullName || 'Profile'}\n                        </option>\n                      ))}\n                    </select>\n                  );\n                })()}\n                <button\n                  type=\"button\"\n                  className=\"profile-edit-btn\"\n                  onClick={handleEditProfileClick}\n                >\n                  Edit profile\n                </button>\n                <button\n                  type=\"button\"\n                  className=\"profile-edit-btn\"\n                  onClick={handleCreateNewProfileClick}\n                >\n                  Create a new profile\n                </button>\n              </div>\n\n              {/}\n              <div className=\"profile-stats\">\n                <div className=\"stat-item\">\n                  <span className=\"stat-number\">{postsCount}</span>\n                  <span className=\"stat-label\">posts</span>\n                </div>\n                <div className=\"stat-item\">\n                  <span className=\"stat-number\">{followersCount}</span>\n                  <span className=\"stat-label\">followers</span>\n                </div>\n                <div className=\"stat-item\">\n                  <span className=\"stat-number\">{followingCount}</span>\n                  <span className=\"stat-label\">following</span>\n                </div>\n              </div>\n\n              {}\n              <div className=\"profile-bio\">\n                {aboutText ? (\n                  <p>\n                    {visibleBioText}\n                    {shouldTruncateBio && !isBioExpanded && (\n                      <button\n                        type=\"button\"\n                        className=\"profile-bio-more\"\n                        onClick={() => setIsBioExpanded(true)}\n                      >\n                        ... more\n                      </button>\n                    )}\n                  </p>\n                ) : (\n                  <>\n                    <p>‚Ä¢ –ì–∞—Ä–∞–Ω—Ç–∏—è –ø–æ–º–æ—â–∏ —Å —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º –≤ –≤–µ–¥—É—â–∏–µ –Ü–¢-–∫–æ–º–ø–∞–Ω–∏–∏</p>\n                    <p>‚Ä¢ –í—ã–ø—É—Å–∫–Ω–∏–∫–∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ—Ç 45–∫ –µ–≤—Ä–æ</p>\n                    <p>–ë–ï–°–ü–õ–ê–¢–ù–ê–Ø... more</p>\n                  </>\n                )}\n                {user?.website ? (\n                  <a href={user.website} className=\"profile-link\" target=\"_blank\" rel=\"noreferrer\">\n                    {user.website}\n                  </a>\n                ) : (\n                  <a href=\"#\" className=\"profile-link\">bit.ly/3rpilbh</a>\n                )}\n              </div>\n            </div>\n          </div>\n\n          {}\n          {postsLoading ? (\n            <div className=\"profile-posts-grid profile-posts-empty\">\n              <div className=\"post-item\">\n                <div className=\"post-image-placeholder\">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>\n              </div>\n            </div>\n          ) : (\n            <div className={`profile-posts-grid ${posts.length === 0 ? 'profile-posts-empty' : ''}`}>\n              {}\n              <button\n                type=\"button\"\n                className=\"post-item post-item-add\"\n                onClick={openCreateModal}\n              >\n                <span className=\"post-item-add-plus\">+</span>\n              </button>\n\n              {}\n              {posts.map((post) => (\n                <div\n                  key={post.id}\n                  className=\"post-item-wrapper\"\n                >\n                  <div\n                    className=\"post-item\"\n                    onClick={async () => {\n                      \n                      try {\n                        await postsAPI.incrementViews(post.id);\n                        \n                        setPosts((prevPosts) =>\n                          prevPosts.map((p) =>\n                            p.id === post.id\n                              ? { ...p, viewsCount: (p.viewsCount || 0) + 1 }\n                              : p\n                          )\n                        );\n                      } catch (error) {\n                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤:', error);\n                      }\n                      setSelectedPost(post);\n                    }}\n                  >\n                    {}\n                    <button\n                      type=\"button\"\n                      className=\"post-options-button\"\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        setPostMenuPostId(post.id);\n                      }}\n                      aria-label=\"More options\"\n                    >\n                      <svg viewBox=\"0 0 24 24\" fill=\"currentColor\" width=\"18\" height=\"18\">\n                        <circle cx=\"12\" cy=\"5\" r=\"1.5\" />\n                        <circle cx=\"12\" cy=\"12\" r=\"1.5\" />\n                        <circle cx=\"12\" cy=\"19\" r=\"1.5\" />\n                      </svg>\n                    </button>\n                    {post.isVideo || (typeof post.image === 'string' && post.image.startsWith('data:video')) ? (\n                      <video\n                        src={post.image}\n                        style={{ width: '100%', height: '100%', objectFit: 'cover' }}\n                        autoPlay\n                        loop\n                        muted\n                        playsInline\n                      />\n                    ) : (\n                      <img\n                        src={post.image}\n                        alt={post.caption || 'Post'}\n                        style={{ width: '100%', height: '100%', objectFit: 'cover' }}\n                      />\n                    )}\n                    {}\n                    <div className=\"post-card-bottom\">\n                      {(post.title || post.caption) && (\n                        <p className=\"post-item-caption-on-card\" title={post.title || post.caption}>\n                          <span className=\"post-item-title-on-card\">\n                            {post.title || (post.caption && post.caption.length > 70 ? post.caption.slice(0, 70) + '‚Ä¶' : post.caption)}\n                          </span>\n                        </p>\n                      )}\n                      <div className=\"post-stats post-stats-on-card\" onClick={(e) => e.stopPropagation()}>\n                        <button\n                          type=\"button\"\n                          className={`post-stat-btn post-stat-btn-like ${post.liked ? 'post-stat-btn-active' : ''}`}\n                          onClick={(e) => handleToggleLike(post, e)}\n                          disabled={likingPostId === post.id}\n                          title=\"–ù—Ä–∞–≤–∏—Ç—Å—è\"\n                        >\n                          <svg viewBox=\"0 0 24 24\" fill={post.liked ? 'currentColor' : 'none'} stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" width=\"18\" height=\"18\">\n                            <path d=\"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z\"></path>\n                          </svg>\n                          <span>{post.likesCount || 0}</span>\n                        </button>\n                        <div className=\"post-stat-btn post-stat-btn-views\" title=\"–ü—Ä–æ—Å–º–æ—Ç—Ä—ã\">\n                          <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" width=\"18\" height=\"18\">\n                            <path d=\"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z\"></path>\n                            <circle cx=\"12\" cy=\"12\" r=\"3\"></circle>\n                          </svg>\n                          <span>{post.viewsCount || 0}</span>\n                        </div>\n                        <button\n                          type=\"button\"\n                          className=\"post-stat-btn post-stat-btn-comment\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            setMiniChatPostId(miniChatPostId === post.id ? null : post.id);\n                          }}\n                          title=\"Discussion\"\n                        >\n                          <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" width=\"18\" height=\"18\">\n                            <path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\"></path>\n                          </svg>\n                          <span>{post.commentsCount || 0}</span>\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                  {}\n                  {miniChatPostId === post.id && (\n                    <div className=\"post-mini-chat\" onClick={(e) => e.stopPropagation()}>\n                      <div className=\"post-mini-chat-header\">\n                        <span>Discussion</span>\n                        <button type=\"button\" className=\"post-mini-chat-close\" onClick={() => setMiniChatPostId(null)} aria-label=\"–ó–∞–∫—Ä—ã—Ç—å\">√ó</button>\n                      </div>\n                      <div className=\"post-mini-chat-list\">\n                        {miniChatComments.length === 0 ? (\n                          <p className=\"post-mini-chat-empty\">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>\n                        ) : (\n                          miniChatComments.map((c) => {\n                            const rawName = (c.user?.username || '').trim().replace(/^@+/, '') || 'User';\n                            const displayNick = rawName === 'User' ? 'User' : `@${rawName}`;\n                            const initial = rawName.charAt(0).toUpperCase();\n                            const isCurrentUser = (user?.dbId || user?.id) && c.user?.id && (String(c.user.id) === String(user.dbId || user.id));\n                            const commentAvatar = isCurrentUser\n                              ? (avatar || user?.avatar || c.user?.avatar)\n                              : (c.user?.avatar);\n                            const isVideoAvatar = commentAvatar && typeof commentAvatar === 'string' && commentAvatar.startsWith('data:video');\n                            return (\n                              <div key={c.id} className=\"post-mini-chat-item\">\n                                <div className=\"post-mini-chat-item-avatar\">\n                                  {commentAvatar && !isVideoAvatar ? (\n                                    <img src={commentAvatar} alt={displayNick} />\n                                  ) : (\n                                    <span className=\"post-mini-chat-item-initial\">{initial}</span>\n                                  )}\n                                </div>\n                                <div className=\"post-mini-chat-item-body\">\n                                  <strong>{displayNick}</strong>\n                                  <span>{c.text}</span>\n                                </div>\n                              </div>\n                            );\n                          })\n                        )}\n                      </div>\n                      <form className=\"post-mini-chat-form\" onSubmit={handleMiniChatSubmit}>\n                        <input\n                          type=\"text\"\n                          className=\"post-mini-chat-input\"\n                          placeholder=\"Write a comment\"\n                          value={miniChatNewText}\n                          onChange={(e) => setMiniChatNewText(e.target.value)}\n                          disabled={miniChatLoading}\n                        />\n                        <EmojiPicker\n                          onSelect={(emoji) => setMiniChatNewText((prev) => prev + emoji)}\n                          disabled={miniChatLoading}\n                        />\n                        <button type=\"submit\" className=\"post-mini-chat-send\" disabled={!miniChatNewText.trim() || miniChatLoading}>\n                          Send\n                        </button>\n                      </form>\n                    </div>\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n        </section>\n\n        {}\n        <footer className=\"profile-footer\">\n          <nav className=\"footer-nav\">\n            <Link to=\"/\">Home</Link>\n            <Link to=\"/search\">Search</Link>\n            <Link to=\"/explore\">Explore</Link>\n            <Link to=\"/messages\">Messages</Link>\n            <Link to=\"/notifications\">Notifications</Link>\n            <Link to=\"/create\">Create</Link>\n          </nav>\n          <div className=\"footer-copyright\">¬©2026 ICHgram</div>\n        </footer>\n      </main>\n\n      {}\n      {postMenuPostId && (() => {\n        const menuPost = posts.find((p) => p.id === postMenuPostId);\n        if (!menuPost) return null;\n        const openFullPost = (focusComment = false) => {\n          setFocusCommentWhenOpen(focusComment);\n          setSelectedPost(menuPost);\n          setPostMenuPostId(null);\n        };\n        return (\n          <>\n            <div className=\"profile-post-menu-backdrop\" onClick={() => setPostMenuPostId(null)} />\n            <div className=\"profile-post-menu-modal\" onClick={(e) => e.stopPropagation()}>\n              <button\n                type=\"button\"\n                className=\"profile-post-menu-item\"\n                onClick={() => {\n                  handleStartEditPost(menuPost);\n                  setPostMenuPostId(null);\n                }}\n              >\n                Edit post\n              </button>\n              <button type=\"button\" className=\"profile-post-menu-item\" onClick={() => openFullPost(false)}>\n                View full post\n              </button>\n              <button type=\"button\" className=\"profile-post-menu-item\" onClick={() => openFullPost(true)}>\n                Reply to messages\n              </button>\n              <button type=\"button\" className=\"profile-post-menu-item\" onClick={() => { navigator.clipboard?.writeText(`${window.location.origin}${window.location.pathname}?post=${menuPost.id}`); setPostMenuPostId(null); }}>Copy link</button>\n              <button type=\"button\" className=\"profile-post-menu-item profile-post-menu-item-delete\" onClick={() => handleDeletePost(menuPost)}>Delete</button>\n              <button type=\"button\" className=\"profile-post-menu-item profile-post-menu-item-cancel\" onClick={() => setPostMenuPostId(null)}>Cancel</button>\n            </div>\n          </>\n        );\n      })()}\n\n      {}\n      {removeFromProfilePostId && (() => {\n        const otherProfiles = uniqueProfilesById(profiles).filter((p) => p.id && String(p.id) !== String(activeProfileId));\n        return (\n          <>\n            <div className=\"profile-post-menu-backdrop\" onClick={() => setRemoveFromProfilePostId(null)} />\n            <div className=\"profile-post-menu-modal profile-remove-from-profile-modal\" onClick={(e) => e.stopPropagation()}>\n              <div className=\"profile-remove-from-profile-title\">Assign this post to another profile:</div>\n              {otherProfiles.length === 0 ? (\n                <p className=\"profile-remove-from-profile-empty\">No other profiles. Create a profile first or delete the post.</p>\n              ) : (\n                <ul className=\"profile-remove-from-profile-list\">\n                  {otherProfiles.map((p) => (\n                    <li key={p.id}>\n                      <button\n                        type=\"button\"\n                        className=\"profile-post-menu-item\"\n                        onClick={() => handleAssignPostToProfile(removeFromProfilePostId, p.id)}\n                      >\n                        {p.username || p.fullName || 'Profile'}\n                      </button>\n                    </li>\n                  ))}\n                </ul>\n              )}\n              <button type=\"button\" className=\"profile-post-menu-item profile-post-menu-item-cancel\" onClick={() => setRemoveFromProfilePostId(null)}>Cancel</button>\n            </div>\n          </>\n        );\n      })()}\n\n      {}\n      {selectedPost && selectedPost.id && (\n        <>\n          <div\n            className=\"profile-post-modal-backdrop\"\n            onClick={closePostModal}\n            aria-hidden=\"true\"\n          />\n          <div className=\"profile-post-modal\" onClick={(e) => e.stopPropagation()}>\n            <button\n              type=\"button\"\n              className=\"profile-post-modal-close\"\n              onClick={(e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                closePostModal();\n              }}\n              aria-label=\"Close\"\n            >\n              √ó\n            </button>\n            <div className=\"profile-post-modal-content\">\n              <div className=\"profile-post-modal-media\">\n                {(() => {\n                  const isEdit = editingPostId && selectedPost?.id && String(editingPostId) === String(selectedPost.id);\n                  const mediaSrc = isEdit && editingMedia ? editingMedia : selectedPost.image;\n                  const isVideoMedia = selectedPost.isVideo || (typeof mediaSrc === 'string' && mediaSrc.startsWith('data:video'));\n                  return (\n                    <>\n                      {isVideoMedia ? (\n                        <video src={mediaSrc} autoPlay loop muted playsInline />\n                      ) : (\n                        <img src={mediaSrc} alt={selectedPost.caption || 'Post'} />\n                      )}\n                      {isEdit && (\n                        <div className=\"profile-post-modal-edit-media\">\n                          <input\n                            id={EDIT_MEDIA_INPUT_ID}\n                            ref={editMediaInputRef}\n                            type=\"file\"\n                            accept=\"image/*,video/*\"\n                            className=\"profile-post-modal-edit-media-input\"\n                            onChange={handleEditMediaChange}\n                            aria-label=\"Change photo or video\"\n                          />\n                          <label htmlFor={EDIT_MEDIA_INPUT_ID} className=\"profile-post-modal-edit-media-btn\">\n                            Change photo or video\n                          </label>\n                        </div>\n                      )}\n                    </>\n                  );\n                })()}\n              </div>\n              <div className=\"profile-post-modal-side\">\n                {}\n                <div className=\"profile-post-modal-header\">\n                  <div className=\"profile-post-modal-avatar\">\n                    {(() => {\n                      const displayAvatar = getAvatarForProfileId(selectedPost?.profileId);\n                      const isVideo = getAvatarTypeForProfileId(selectedPost?.profileId) === 'video';\n                      if (displayAvatar) {\n                        return isVideo ? (\n                          <video src={displayAvatar} autoPlay loop muted playsInline />\n                        ) : (\n                          <img src={displayAvatar} alt={user?.username || 'avatar'} />\n                        );\n                      }\n                      return (\n                        <span className=\"profile-post-modal-initial\">\n                          {(user?.username || 'U').charAt(0).toUpperCase()}\n                        </span>\n                      );\n                    })()}\n                  </div>\n                  <div className=\"profile-post-modal-user\">\n                    <span className=\"profile-post-modal-username\">\n                      {user?.username}\n                    </span>\n                  </div>\n                  {}\n                  <span className=\"profile-post-modal-your-post\">Your post</span>\n                </div>\n\n                {}\n                <div className=\"profile-post-modal-comments\">\n                  {}\n                  {selectedPost.caption !== undefined && (\n                    <div className=\"profile-post-modal-comment\">\n                      <div className=\"profile-post-modal-comment-avatar\">\n                        {(() => {\n                          const displayAvatar = getAvatarForProfileId(selectedPost?.profileId);\n                          const isVideo = getAvatarTypeForProfileId(selectedPost?.profileId) === 'video';\n                          if (displayAvatar) {\n                            return isVideo ? (\n                              <video src={displayAvatar} autoPlay loop muted playsInline />\n                            ) : (\n                              <img src={displayAvatar} alt={user?.username || 'avatar'} />\n                            );\n                          }\n                          return (\n                            <span className=\"profile-post-modal-initial\">\n                              {(user?.username || 'U').charAt(0).toUpperCase()}\n                            </span>\n                          );\n                        })()}\n                      </div>\n                      <div className=\"profile-post-modal-comment-body\">\n                        <div className=\"profile-post-modal-comment-header\">\n                          <span className=\"profile-post-modal-comment-username\">\n                            {user?.username}\n                          </span>\n                          {editingPostId && selectedPost?.id && String(editingPostId) === String(selectedPost.id) ? (\n                            <div className=\"profile-post-modal-edit-caption\">\n                              <label className=\"profile-post-modal-edit-caption-label\">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏</label>\n                              <input\n                                type=\"text\"\n                                className=\"profile-post-modal-edit-title-input\"\n                                value={editingTitle}\n                                onChange={(e) => setEditingTitle(e.target.value)}\n                                placeholder=\"–ö—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞...\"\n                                maxLength={300}\n                              />\n                              <label className=\"profile-post-modal-edit-caption-label\">–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞</label>\n                              <textarea\n                                className=\"profile-post-modal-edit-caption-input\"\n                                value={editingCaption}\n                                onChange={(e) => setEditingCaption(e.target.value)}\n                                placeholder=\"–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞...\"\n                                rows={4}\n                              />\n                              <div className=\"profile-post-modal-edit-caption-actions\">\n                                <button\n                                  type=\"button\"\n                                  className=\"profile-post-modal-edit-caption-save\"\n                                  onClick={handleSaveEditedPost}\n                                  disabled={editingCaptionSaving}\n                                >\n                                  {editingCaptionSaving ? 'Saving...' : 'Save changes'}\n                                </button>\n                                <button\n                                  type=\"button\"\n                                  className=\"profile-post-modal-edit-caption-cancel\"\n                                  onClick={handleCancelEditPost}\n                                  disabled={editingCaptionSaving}\n                                >\n                                  Cancel\n                                </button>\n                              </div>\n                            </div>\n                          ) : (\n                            <>\n                              {selectedPost.title ? (\n                                <span className=\"profile-post-modal-comment-text profile-post-modal-comment-title\">{selectedPost.title}</span>\n                              ) : null}\n                              <span className=\"profile-post-modal-comment-text\">\n                                {selectedPost.caption}\n                              </span>\n                            </>\n                          )}\n                        </div>\n                        <div className=\"profile-post-modal-comment-meta\">\n                          <span className=\"profile-post-modal-comment-time\">\n                            {formatPostTime(selectedPost.createdAt)}\n                          </span>\n                        </div>\n                      </div>\n                    </div>\n                  )}\n                  {}\n                  {postComments.map((comment) => (\n                    <div key={comment.id} className=\"profile-post-modal-comment-wrapper\">\n                      <div className=\"profile-post-modal-comment\">\n                        <div className=\"profile-post-modal-comment-avatar\">\n                          {comment.user?.avatar ? (\n                            typeof comment.user.avatar === 'string' && comment.user.avatar.startsWith('data:video') ? (\n                              <video\n                                src={comment.user.avatar}\n                                autoPlay\n                                loop\n                                muted\n                                playsInline\n                              />\n                            ) : (\n                              <img\n                                src={comment.user.avatar}\n                                alt={comment.user?.username || 'avatar'}\n                              />\n                            )\n                          ) : (\n                            <span className=\"profile-post-modal-initial\">\n                              {(comment.user?.username || 'U').charAt(0).toUpperCase()}\n                            </span>\n                          )}\n                        </div>\n                        <div className=\"profile-post-modal-comment-body\">\n                          <div className=\"profile-post-modal-comment-header\">\n                            <span className=\"profile-post-modal-comment-username\">\n                              {comment.user?.username}\n                            </span>\n                            <span className=\"profile-post-modal-comment-text\">\n                              {comment.text}\n                            </span>\n                          </div>\n                          <div className=\"profile-post-modal-comment-meta\">\n                            <span className=\"profile-post-modal-comment-time\">\n                              {formatPostTime(comment.createdAt)}\n                            </span>\n                            <button\n                              type=\"button\"\n                              className=\"profile-post-modal-reply-btn\"\n                              onClick={() => {\n                                setReplyingTo(replyingTo === comment.id ? null : comment.id);\n                                setReplyText('');\n                              }}\n                            >\n                              {replyingTo === comment.id ? '–û—Ç–º–µ–Ω–∞' : '–û—Ç–≤–µ—Ç–∏—Ç—å'}\n                            </button>\n                            {(comment.repliesCount || 0) > 0 && (\n                              <button\n                                type=\"button\"\n                                className=\"profile-post-modal-view-replies-btn\"\n                                onClick={() => {\n                                  setExpandedReplies((prev) => {\n                                    const newSet = new Set(prev);\n                                    if (newSet.has(comment.id)) {\n                                      newSet.delete(comment.id);\n                                    } else {\n                                      newSet.add(comment.id);\n                                    }\n                                    return newSet;\n                                  });\n                                }}\n                              >\n                                {expandedReplies.has(comment.id) \n                                  ? '–°–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç—ã' \n                                  : `–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç—ã (${comment.repliesCount || 0})`}\n                              </button>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n                      {}\n                      {replyingTo === comment.id && (\n                        <form\n                          className=\"profile-post-modal-reply-form\"\n                          onSubmit={(e) => handleAddReply(comment.id, e)}\n                        >\n                          <input\n                            type=\"text\"\n                            className=\"profile-post-modal-reply-input\"\n                            placeholder={`–û—Ç–≤–µ—Ç–∏—Ç—å ${comment.user?.username}...`}\n                            value={replyText}\n                            onChange={(e) => setReplyText(e.target.value)}\n                            disabled={commentLoading}\n                            autoFocus\n                          />\n                          <EmojiPicker\n                            onSelect={(emoji) => setReplyText((prev) => prev + emoji)}\n                            disabled={commentLoading}\n                          />\n                          <button\n                            type=\"submit\"\n                            className=\"profile-post-modal-reply-submit\"\n                            disabled={!replyText.trim() || commentLoading}\n                          >\n                            {commentLoading ? 'Sending...' : 'Send'}\n                          </button>\n                        </form>\n                      )}\n                      {}\n                      {(comment.replies || []).length > 0 && expandedReplies.has(comment.id) && (\n                        <div className=\"profile-post-modal-replies\">\n                          {comment.replies.map((reply) => (\n                            <div key={reply.id} className=\"profile-post-modal-comment profile-post-modal-reply\">\n                              <div className=\"profile-post-modal-comment-avatar\">\n                                {reply.user?.avatar ? (\n                                  typeof reply.user.avatar === 'string' && reply.user.avatar.startsWith('data:video') ? (\n                                    <video\n                                      src={reply.user.avatar}\n                                      autoPlay\n                                      loop\n                                      muted\n                                      playsInline\n                                    />\n                                  ) : (\n                                    <img\n                                      src={reply.user.avatar}\n                                      alt={reply.user?.username || 'avatar'}\n                                    />\n                                  )\n                                ) : (\n                                  <span className=\"profile-post-modal-initial\">\n                                    {(reply.user?.username || 'U').charAt(0).toUpperCase()}\n                                  </span>\n                                )}\n                              </div>\n                              <div className=\"profile-post-modal-comment-body\">\n                                <div className=\"profile-post-modal-comment-header\">\n                                  <span className=\"profile-post-modal-comment-username\">\n                                    {reply.user?.username}\n                                  </span>\n                                  <span className=\"profile-post-modal-comment-text\">\n                                    {reply.text}\n                                  </span>\n                                </div>\n                                <div className=\"profile-post-modal-comment-meta\">\n                                  <span className=\"profile-post-modal-comment-time\">\n                                    {formatPostTime(reply.createdAt)}\n                                  </span>\n                                </div>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                    </div>\n                  ))}\n                </div>\n\n                {}\n                <div className=\"profile-post-modal-footer\">\n                  <div className=\"profile-post-modal-actions\">\n                    <button type=\"button\" className=\"profile-post-modal-icon-btn\">\n                      <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <path d=\"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z\"></path>\n                      </svg>\n                    </button>\n                    <button type=\"button\" className=\"profile-post-modal-icon-btn\">\n                      <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\"></path>\n                      </svg>\n                    </button>\n                    <button\n                      type=\"button\"\n                      className=\"profile-post-modal-icon-btn\"\n                      onClick={handleSendMessage}\n                      title=\"Send message\"\n                    >\n                      <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <line x1=\"22\" y1=\"2\" x2=\"11\" y2=\"13\"></line>\n                        <polygon points=\"22 2 15 22 11 13 2 9 22 2\"></polygon>\n                      </svg>\n                    </button>\n                    <button\n                      type=\"button\"\n                      className=\"profile-post-modal-icon-btn profile-post-modal-icon-btn-save\"\n                    >\n                      <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <path d=\"M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z\"></path>\n                      </svg>\n                    </button>\n                  </div>\n                  <div className=\"profile-post-modal-stats\">\n                    <span className=\"profile-post-modal-likes\" title=\"–õ–∞–π–∫–∏\">\n                      {selectedPost.likesCount || 0}\n                    </span>\n                    <span className=\"profile-post-modal-views\" title=\"–ü—Ä–æ—Å–º–æ—Ç—Ä—ã\">\n                      {selectedPost.viewsCount || 0}\n                    </span>\n                    <span className=\"profile-post-modal-comments-count\" title=\"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏\">\n                      {selectedPost.commentsCount || 0}\n                    </span>\n                  </div>\n                  <div className=\"profile-post-modal-time\">\n                    {formatPostTime(selectedPost.createdAt)}\n                  </div>\n                  <form\n                    className=\"profile-post-modal-add-comment\"\n                    onSubmit={handleAddComment}\n                  >\n                    <input\n                      ref={commentInputRef}\n                      type=\"text\"\n                      className=\"profile-post-modal-input\"\n                      placeholder=\"Add comment\"\n                      value={newCommentText}\n                      onChange={(e) => setNewCommentText(e.target.value)}\n                      disabled={commentLoading}\n                    />\n                    <EmojiPicker\n                      onSelect={(emoji) => setNewCommentText((prev) => prev + emoji)}\n                      disabled={commentLoading}\n                    />\n                    <button\n                      type=\"submit\"\n                      className=\"profile-post-modal-post-btn\"\n                      disabled={!newCommentText.trim() || commentLoading}\n                    >\n                      {commentLoading ? 'Sending...' : 'Send'}\n                    </button>\n                  </form>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n    </div>\n  );\n};\n\nexport default Profile;\n"
        }
    ]
}