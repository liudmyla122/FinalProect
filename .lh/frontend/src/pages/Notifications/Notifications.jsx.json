{
    "sourceFile": "frontend/src/pages/Notifications/Notifications.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1770737365841,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1770737365841,
            "name": "Commit-0",
            "content": "import { useEffect, useState } from 'react'\nimport { Link } from 'react-router-dom'\nimport { postsAPI } from '../../services/api'\nimport AppSidebar from '../../components/AppSidebar/AppSidebar'\nimport EmojiPicker from '../../components/EmojiPicker/EmojiPicker'\nimport './Notifications.css'\n\nconst formatCount = (count) => {\n  if (count == null || count === 0) return '0'\n  if (count >= 1000) return `${(count / 1000).toFixed(1)}k`\n  return String(count)\n}\n\nconst Notifications = () => {\n  const [posts, setPosts] = useState([])\n  const [loading, setLoading] = useState(true)\n  const [error, setError] = useState(false)\n  const [modalPostId, setModalPostId] = useState(null)\n  const [modalPostData, setModalPostData] = useState(null)\n  const [modalLoading, setModalLoading] = useState(false)\n  const [likingPostId, setLikingPostId] = useState(null)\n  const [savingPostId, setSavingPostId] = useState(null)\n  const [modalComment, setModalComment] = useState('')\n  const [modalSubmitting, setModalSubmitting] = useState(false)\n\n  useEffect(() => {\n    let cancelled = false\n    const load = async () => {\n      setLoading(true)\n      setError(false)\n      try {\n        const res = await postsAPI.getLikedPosts()\n        if (!cancelled && res.success && res.posts) {\n          setPosts(res.posts)\n        }\n      } catch (e) {\n        if (!cancelled) setError(true)\n      } finally {\n        if (!cancelled) setLoading(false)\n      }\n    }\n    load()\n    return () => {\n      cancelled = true\n    }\n  }, [])\n\n  useEffect(() => {\n    if (!modalPostId) {\n      setModalPostData(null)\n      setModalComment('')\n      return\n    }\n    let cancelled = false\n    setModalLoading(true)\n    setModalComment('')\n    postsAPI\n      .getPostById(modalPostId)\n      .then((res) => {\n        if (!cancelled && res?.success && res?.post) {\n          setModalPostData(res.post)\n        }\n        if (!cancelled) setModalLoading(false)\n      })\n      .catch(() => {\n        if (!cancelled) setModalLoading(false)\n      })\n    return () => {\n      cancelled = true\n    }\n  }, [modalPostId])\n\n  const handlePostClick = (postId) => {\n    setModalPostId(postId)\n  }\n\n  const closeModal = () => {\n    setModalPostId(null)\n    setModalPostData(null)\n  }\n\n  const handleLikeClick = async () => {\n    if (!modalPostData || likingPostId) return\n    setLikingPostId(modalPostData.id)\n    try {\n      const res = await postsAPI.toggleLike(modalPostData.id)\n      if (res.success) {\n        setModalPostData((d) =>\n          d\n            ? {\n                ...d,\n                liked: res.liked,\n                likesCount: res.likesCount ?? d.likesCount,\n              }\n            : d,\n        )\n        if (!res.liked) {\n          setPosts((prev) => prev.filter((p) => p.id !== modalPostData.id))\n          closeModal()\n        }\n      }\n    } catch (e) {\n      console.error('Like error:', e)\n    } finally {\n      setLikingPostId(null)\n    }\n  }\n\n  const handleToggleSave = async () => {\n    if (!modalPostData || savingPostId) return\n    setSavingPostId(modalPostData.id)\n    try {\n      const res = await postsAPI.toggleSave(modalPostData.id)\n      if (res.success) {\n        setModalPostData((d) =>\n          d\n            ? {\n                ...d,\n                saved: res.saved,\n                savesCount:\n                  res.savesCount ?? (d.savesCount || 0) + (res.saved ? 1 : -1),\n              }\n            : d,\n        )\n      }\n    } catch (e) {\n      console.error('Toggle save error:', e)\n    } finally {\n      setSavingPostId(null)\n    }\n  }\n\n  const handleShareClick = async () => {\n    if (!modalPostData) return\n    const url = `${window.location.origin}/?post=${modalPostData.id}`\n    try {\n      if (navigator.share) {\n        await navigator.share({\n          title: 'Post',\n          url,\n          text: modalPostData.caption || '',\n        })\n      } else {\n        await navigator.clipboard.writeText(url)\n        alert('Ссылка скопирована')\n      }\n    } catch (e) {\n      if (e.name !== 'AbortError') {\n        try {\n          await navigator.clipboard.writeText(url)\n          alert('Ссылка скопирована')\n        } catch {\n          console.error('Share error:', e)\n        }\n      }\n    }\n  }\n\n  const handleAddComment = async (e) => {\n    e.preventDefault()\n    if (!modalPostData || !modalComment.trim() || modalSubmitting) return\n    setModalSubmitting(true)\n    try {\n      const res = await postsAPI.addComment(\n        modalPostData.id,\n        modalComment.trim(),\n      )\n      if (res.success && res.comment) {\n        setModalPostData((d) =>\n          d\n            ? {\n                ...d,\n                comments: [...(d.comments || []), res.comment],\n                commentsCount: (d.commentsCount || 0) + 1,\n              }\n            : d,\n        )\n        setModalComment('')\n      }\n    } catch (e) {\n      console.error('Add comment error:', e)\n    } finally {\n      setModalSubmitting(false)\n    }\n  }\n\n  return (\n    <div className=\"app-layout-with-sidebar\">\n      <AppSidebar activeItem=\"notifications\" />\n      <main className=\"app-layout-main notifications-main\">\n        <div className=\"notifications-content\">\n          {loading ? (\n            <div className=\"notifications-loading\">Загрузка...</div>\n          ) : error ? (\n            <div className=\"notifications-error\">\n              Не удалось загрузить посты с вашими лайками.\n            </div>\n          ) : posts.length === 0 ? (\n            <div className=\"notifications-empty-wrap\">\n              <div className=\"notifications-empty\">\n                <p>Здесь пока нет постов, которым вы поставили лайк.</p>\n                <p>\n                  Ставьте лайки постам в ленте — они появятся на этой странице.\n                </p>\n                <Link to=\"/\" className=\"notifications-empty-link\">\n                  Перейти в ленту\n                </Link>\n              </div>\n            </div>\n          ) : (\n            <div className=\"notifications-grid\">\n              {posts.map((post) => {\n                const img =\n                  post.images && post.images.length > 0\n                    ? post.images[0]\n                    : post.image\n                const isVideo =\n                  post.isVideo ||\n                  (typeof img === 'string' && img.startsWith('data:video'))\n                return (\n                  <button\n                    key={post.id}\n                    type=\"button\"\n                    className=\"notifications-post-item\"\n                    onClick={() => handlePostClick(post.id)}\n                  >\n                    <div className=\"notifications-post-media-wrap\">\n                      {isVideo ? (\n                        <video\n                          src={img}\n                          className=\"notifications-post-media\"\n                          autoPlay\n                          loop\n                          muted\n                          playsInline\n                        />\n                      ) : (\n                        <img\n                          src={img}\n                          alt={post.caption || 'Post'}\n                          className=\"notifications-post-media\"\n                        />\n                      )}\n                    </div>\n                    <div className=\"notifications-post-title\">\n                      {post.title || 'Untitled'}\n                    </div>\n                  </button>\n                )\n              })}\n            </div>\n          )}\n        </div>\n        <footer className=\"notifications-footer\">\n          <nav className=\"notifications-footer-nav\">\n            <Link to=\"/\">Home</Link>\n            <Link to=\"/search\">Search</Link>\n            <Link to=\"/explore\">Explore</Link>\n            <Link to=\"/messages\">Messages</Link>\n            <Link to=\"/notifications\">Notifications</Link>\n            <Link to=\"/create\">Create</Link>\n          </nav>\n          <div className=\"notifications-footer-copyright\">© 2026 ICHgram</div>\n        </footer>\n      </main>\n\n      {modalPostId && (\n        <>\n          <div\n            className=\"notifications-modal-overlay\"\n            onClick={closeModal}\n            aria-hidden=\"true\"\n          />\n          <div\n            className=\"notifications-modal\"\n            role=\"dialog\"\n            aria-modal=\"true\"\n            onClick={(e) => e.stopPropagation()}\n          >\n            <button\n              type=\"button\"\n              className=\"notifications-modal-close\"\n              onClick={closeModal}\n              aria-label=\"Закрыть\"\n            >\n              ×\n            </button>\n            {modalLoading ? (\n              <div className=\"notifications-modal-loading\">Загрузка...</div>\n            ) : modalPostData ? (\n              <div className=\"notifications-modal-inner\">\n                <div className=\"notifications-modal-media\">\n                  {(() => {\n                    const imgs =\n                      modalPostData.images?.length > 0\n                        ? modalPostData.images\n                        : modalPostData.image\n                          ? [modalPostData.image]\n                          : []\n                    const src = imgs[0]\n                    const isVideo =\n                      modalPostData.isVideo ||\n                      (typeof src === 'string' && src.startsWith('data:video'))\n                    if (!src) return null\n                    return isVideo ? (\n                      <video\n                        src={src}\n                        controls\n                        playsInline\n                        className=\"notifications-modal-image\"\n                      />\n                    ) : (\n                      <img\n                        src={src}\n                        alt=\"\"\n                        className=\"notifications-modal-image\"\n                      />\n                    )\n                  })()}\n                </div>\n                <div className=\"notifications-modal-side\">\n                  <div className=\"notifications-modal-actions\">\n                    <button\n                      type=\"button\"\n                      className={`notifications-modal-action-btn notifications-modal-action-btn--like${modalPostData.liked ? ' notifications-modal-action-btn--liked' : ''}`}\n                      title=\"Нравится\"\n                      onClick={handleLikeClick}\n                      disabled={likingPostId === modalPostData.id}\n                    >\n                      <svg\n                        className=\"notifications-modal-action-icon\"\n                        viewBox=\"0 0 24 24\"\n                        fill={modalPostData.liked ? 'currentColor' : 'none'}\n                        stroke=\"currentColor\"\n                        strokeWidth=\"2\"\n                      >\n                        <path d=\"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z\"></path>\n                      </svg>\n                      <span className=\"notifications-modal-action-count\">\n                        {formatCount(modalPostData.likesCount)}\n                      </span>\n                    </button>\n                    <span className=\"notifications-modal-comments-count\">\n                      {formatCount(modalPostData.commentsCount)}\n                    </span>\n                    <button\n                      type=\"button\"\n                      className=\"notifications-modal-action-btn\"\n                      title=\"Поделиться\"\n                      onClick={handleShareClick}\n                    >\n                      <svg\n                        className=\"notifications-modal-action-icon\"\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        strokeWidth=\"2\"\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                      >\n                        <line x1=\"22\" y1=\"2\" x2=\"11\" y2=\"13\"></line>\n                        <polygon points=\"22 2 15 22 11 13 2 9 22 2\"></polygon>\n                      </svg>\n                    </button>\n                    <button\n                      type=\"button\"\n                      className={`notifications-modal-action-btn notifications-modal-action-btn--save${modalPostData.saved ? ' notifications-modal-action-btn--saved' : ''}`}\n                      title=\"Saved\"\n                      onClick={handleToggleSave}\n                      disabled={savingPostId === modalPostData.id}\n                    >\n                      <svg\n                        className=\"notifications-modal-action-icon\"\n                        viewBox=\"0 0 24 24\"\n                        fill={modalPostData.saved ? 'currentColor' : 'none'}\n                        stroke=\"currentColor\"\n                        strokeWidth=\"2\"\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                      >\n                        <path d=\"M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z\"></path>\n                      </svg>\n                      <span className=\"notifications-modal-action-count\">\n                        {formatCount(modalPostData.savesCount ?? 0)}\n                      </span>\n                    </button>\n                  </div>\n                  <div className=\"notifications-modal-caption-block\">\n                    <div className=\"notifications-modal-title-text\">\n                      {modalPostData.title || 'Без названия'}\n                    </div>\n                    <div className=\"notifications-modal-caption\">\n                      {modalPostData.caption || ''}\n                    </div>\n                  </div>\n                  <div className=\"notifications-modal-comments-list\">\n                    {(modalPostData.comments || []).map((c) => (\n                      <div key={c.id} className=\"notifications-modal-comment\">\n                        <div className=\"notifications-modal-comment-avatar\">\n                          {c.user?.avatar &&\n                          typeof c.user.avatar === 'string' ? (\n                            c.user.avatar.startsWith('data:video') ? (\n                              <video\n                                src={c.user.avatar}\n                                autoPlay\n                                loop\n                                muted\n                                playsInline\n                              />\n                            ) : (\n                              <img\n                                src={c.user.avatar}\n                                alt={c.user?.username || 'avatar'}\n                              />\n                            )\n                          ) : (\n                            <span className=\"notifications-modal-comment-avatar-fallback\">\n                              {(c.user?.username || 'U')\n                                .charAt(0)\n                                .toUpperCase()}\n                            </span>\n                          )}\n                        </div>\n                        <div className=\"notifications-modal-comment-body\">\n                          <span className=\"notifications-modal-comment-username\">\n                            {c.user?.username || 'User'}\n                          </span>\n                          <span className=\"notifications-modal-comment-text\">\n                            {c.text}\n                          </span>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                  <form\n                    className=\"notifications-modal-add-comment\"\n                    onSubmit={handleAddComment}\n                  >\n                    <input\n                      type=\"text\"\n                      className=\"notifications-modal-input\"\n                      placeholder=\"Добавить комментарий...\"\n                      value={modalComment}\n                      onChange={(e) => setModalComment(e.target.value)}\n                      maxLength={500}\n                    />\n                    <EmojiPicker\n                      onSelect={(emoji) =>\n                        setModalComment((prev) =>\n                          prev.length + emoji.length <= 500\n                            ? prev + emoji\n                            : prev,\n                        )\n                      }\n                      disabled={modalSubmitting}\n                    />\n                    <button\n                      type=\"submit\"\n                      className=\"notifications-modal-submit\"\n                      disabled={!modalComment.trim() || modalSubmitting}\n                    >\n                      {modalSubmitting ? '...' : 'Send'}\n                    </button>\n                  </form>\n                </div>\n              </div>\n            ) : null}\n          </div>\n        </>\n      )}\n    </div>\n  )\n}\n\nexport default Notifications\n"
        }
    ]
}