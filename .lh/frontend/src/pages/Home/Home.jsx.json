{
    "sourceFile": "frontend/src/pages/Home/Home.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1769703737811,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1769788654846,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -531,9 +531,9 @@\n               }`}\n               onClick={() => {\n                 setShowNotificationsPanel(!showNotificationsPanel)\n                 if (!showNotificationsPanel) {\n-                  setShowSearchPanel(false)\n+                  closeSearch()\n                 }\n               }}\n               style={{\n                 background: 'none',\n"
                },
                {
                    "date": 1769788662260,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -562,9 +562,9 @@\n             </button>\n             <button\n               className=\"home-nav-item\"\n               onClick={() => {\n-                setShowSearchPanel(false)\n+                closeSearch()\n                 setShowNotificationsPanel(false)\n                 openCreateModal()\n               }}\n               style={{\n"
                }
            ],
            "date": 1769703737811,
            "name": "Commit-0",
            "content": "import { useEffect, useState } from 'react';\nimport { Link, useNavigate } from 'react-router-dom';\nimport { authAPI, searchAPI, postsAPI, usersAPI } from '../../services/api';\nimport { useCreatePost } from '../../context/CreatePostContext';\nimport { setUserToLocalStorage } from '../../utils/storage';\nimport foto1 from '../../assets/images/login/foto1.svg';\nimport foto2 from '../../assets/images/login/foto2.svg';\nimport foto3 from '../../assets/images/login/foto3.svg';\nimport foto4 from '../../assets/images/login/foto4.svg';\n\nimport post1 from '../../assets/images/login/post1.jpg';\nimport post2 from '../../assets/images/login/post2.jpg';\nimport post3 from '../../assets/images/login/post3.jpg';\nimport './Home.css';\n\n\nconst formatCount = (count) => {\n  if (count == null || count === 0) return '0';\n  if (count >= 1000) return `${(count / 1000).toFixed(1)}k`;\n  return String(count);\n};\n\nconst formatTime = (dateString) => {\n  if (!dateString) return '';\n  const date = new Date(dateString);\n  const now = new Date();\n  const diffMs = now - date;\n  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));\n  if (diffDays <= 0) return 'today';\n  if (diffDays === 1) return '1 day';\n  if (diffDays < 7) return `${diffDays} days`;\n  const diffWeeks = Math.floor(diffDays / 7);\n  return `${diffWeeks} week`;\n};\n\nconst Home = () => {\n  const navigate = useNavigate();\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [showSearchPanel, setShowSearchPanel] = useState(false);\n  const [showNotificationsPanel, setShowNotificationsPanel] = useState(false);\n  const [searchQuery, setSearchQuery] = useState('');\n  const [searchResults, setSearchResults] = useState([]);\n  const [searchLoading, setSearchLoading] = useState(false);\n  const [recentSearches, setRecentSearches] = useState(['sashaa']);\n  const [expandedComments, setExpandedComments] = useState({});\n  const { open: openCreateModal } = useCreatePost();\n  const [feedPosts, setFeedPosts] = useState([]);\n  const [feedLoading, setFeedLoading] = useState(true);\n  const [feedError, setFeedError] = useState(false);\n  const [likingPostId, setLikingPostId] = useState(null);\n  const [homePostModalId, setHomePostModalId] = useState(null);\n  const [homePostModalData, setHomePostModalData] = useState(null);\n  const [homePostModalComment, setHomePostModalComment] = useState('');\n  const [homePostModalSubmitting, setHomePostModalSubmitting] = useState(false);\n  const [savedPostIds, setSavedPostIds] = useState(() => {\n    try {\n      return new Set(JSON.parse(localStorage.getItem('saved_post_ids') || '[]'));\n    } catch {\n      return new Set();\n    }\n  });\n  const [followingUserIds, setFollowingUserIds] = useState(new Set());\n  const [followLoadingId, setFollowLoadingId] = useState(null);\n  const [notifications] = useState([\n    {\n      id: 1,\n      username: 'sashaa',\n      avatar: foto1,\n      text: 'liked your photo',\n      timeAgo: '2 d',\n      previewImage: post1,\n      postId: 1,\n    },\n    {\n      id: 2,\n      username: 'sashaa',\n      avatar: foto2,\n      text: 'commented your photo',\n      timeAgo: '2 week',\n      previewImage: post2,\n      postId: 2,\n    },\n    {\n      id: 3,\n      username: 'sashaa',\n      avatar: foto3,\n      text: 'started following',\n      timeAgo: '2 d',\n      previewImage: post3,\n      postId: 3,\n    },\n  ]);\n\n  useEffect(() => {\n    document.title = 'Home - ICHGRAM';\n    \n    const token = localStorage.getItem('token');\n    if (!token) {\n      navigate('/login');\n      return;\n    }\n\n    const fetchUser = async () => {\n      try {\n        const response = await authAPI.getCurrentUser();\n        const currentUser = response.user;\n        \n        \n        let userWithAvatar = { ...currentUser };\n        if (currentUser.avatar && currentUser.avatar.trim().length > 0) {\n          userWithAvatar.avatar = currentUser.avatar;\n          userWithAvatar.avatarType = currentUser.avatarType || (currentUser.avatar.startsWith('data:video/') ? 'video' : 'image');\n        }\n        \n        setUser(userWithAvatar);\n\n       \n        if (currentUser && Array.isArray(currentUser.profiles)) {\n          const serverProfiles = currentUser.profiles || [];\n          if (serverProfiles.length > 0) {\n            localStorage.setItem('profiles', JSON.stringify(serverProfiles));\n\n            \n            const activeId = localStorage.getItem('activeProfileId') || serverProfiles[0].id;\n            if (activeId) {\n              localStorage.setItem('activeProfileId', activeId);\n              const activeProfile =\n                serverProfiles.find((p) => p.id === activeId) || serverProfiles[0];\n              \n              \n              try {\n                const avatarFromStorage = localStorage.getItem(`profile_avatar_${activeId}`);\n                if (avatarFromStorage) {\n                  activeProfile.avatar = avatarFromStorage;\n                  activeProfile.avatarType = activeProfile.avatarType || (avatarFromStorage.startsWith('data:video/') ? 'video' : 'image');\n                } else if (userWithAvatar.avatar) {\n                  \n                  activeProfile.avatar = userWithAvatar.avatar;\n                  activeProfile.avatarType = userWithAvatar.avatarType;\n                }\n              } catch (e) {\n                console.warn('Ошибка при загрузке аватара из отдельного хранилища:', e);\n              }\n              \n              setUserToLocalStorage(activeProfile);\n              setUser({ ...activeProfile, dbId: currentUser.id }); \n            }\n          } else {\n            setUserToLocalStorage(userWithAvatar);\n          }\n        } else {\n          setUserToLocalStorage(userWithAvatar);\n        }\n      } catch (error) {\n        \n        const isUnauthorized = error.response?.status === 401;\n        if (isUnauthorized) {\n          localStorage.removeItem('token');\n          localStorage.removeItem('user');\n          navigate('/login');\n        }\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    fetchUser();\n  }, [navigate]);\n\n  \n  useEffect(() => {\n    const loadFeed = async () => {\n      setFeedError(false);\n      try {\n        const response = await postsAPI.getFeed(20, 0);\n        const posts = response?.posts;\n        if (Array.isArray(posts)) {\n          setFeedPosts(posts);\n        } else if (response?.success === true) {\n          setFeedPosts([]);\n        }\n      } catch (error) {\n        console.error('Feed load error:', error);\n        setFeedPosts([]);\n        setFeedError(true);\n      } finally {\n        setFeedLoading(false);\n      }\n    };\n\n    if (!loading) {\n      loadFeed();\n    }\n  }, [loading]);\n\n  useEffect(() => {\n    if (!homePostModalId) return;\n    const load = async () => {\n      try {\n        const res = await postsAPI.getPostById(homePostModalId);\n        if (res.success && res.post) setHomePostModalData(res.post);\n      } catch (e) {\n        console.error('Load post for modal:', e);\n        closePostModal();\n      }\n    };\n    load();\n  }, [homePostModalId]);\n\n  const handleHomeModalAddComment = async (e) => {\n    e.preventDefault();\n    if (!homePostModalId || !homePostModalComment.trim() || homePostModalSubmitting) return;\n    setHomePostModalSubmitting(true);\n    try {\n      const res = await postsAPI.addComment(homePostModalId, homePostModalComment.trim());\n      if (res.success && res.comment) {\n        setHomePostModalData((d) =>\n          d ? { ...d, comments: [...(d.comments || []), res.comment], commentsCount: (d.commentsCount || 0) + 1 } : d\n        );\n        setFeedPosts((prev) =>\n          prev.map((p) => (p.id === homePostModalId ? { ...p, commentsCount: (p.commentsCount || 0) + 1 } : p))\n        );\n        setHomePostModalComment('');\n      }\n    } catch (e) {\n      console.error('Add comment error:', e);\n    } finally {\n      setHomePostModalSubmitting(false);\n    }\n  };\n\n  \n  useEffect(() => {\n    const searchUsers = async () => {\n      if (!searchQuery.trim()) {\n        setSearchResults([]);\n        return;\n      }\n\n      setSearchLoading(true);\n      try {\n        const response = await searchAPI.searchUsers(searchQuery);\n        if (response.success) {\n          setSearchResults(response.users || []);\n        }\n      } catch (error) {\n        console.error('Search error:', error);\n        setSearchResults([]);\n      } finally {\n        setSearchLoading(false);\n      }\n    };\n\n   \n    const timeoutId = setTimeout(() => {\n      searchUsers();\n    }, 300);\n\n    return () => clearTimeout(timeoutId);\n  }, [searchQuery]);\n\n  const handleNotificationClick = (postId) => {\n    const postElement = document.getElementById(`home-post-${postId}`);\n    if (postElement) {\n      postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });\n      setShowNotificationsPanel(false);\n    }\n  };\n\n  const toggleCommentExpand = (postId) => {\n    setExpandedComments((prev) => ({\n      ...prev,\n      [postId]: !prev[postId],\n    }));\n  };\n\n  const handleLikeClick = async (post) => {\n    if (likingPostId === post.id) return;\n    setLikingPostId(post.id);\n    try {\n      const res = await postsAPI.toggleLike(post.id);\n      if (res.success) {\n        setFeedPosts((prev) =>\n          prev.map((p) =>\n            p.id === post.id\n              ? { ...p, liked: res.liked, likesCount: res.likesCount ?? (p.likesCount || 0) + (res.liked ? 1 : -1) }\n              : p\n          )\n        );\n        if (homePostModalId === post.id && homePostModalData) {\n          setHomePostModalData((d) => (d ? { ...d, liked: res.liked, likesCount: res.likesCount ?? d.likesCount } : d));\n        }\n      }\n    } catch (e) {\n      console.error('Like error:', e);\n    } finally {\n      setLikingPostId(null);\n    }\n  };\n\n  const openPostModal = (post) => {\n    setHomePostModalId(post.id);\n    setHomePostModalData(null);\n    setHomePostModalComment('');\n  };\n\n  const closePostModal = () => {\n    setHomePostModalId(null);\n    setHomePostModalData(null);\n    setHomePostModalComment('');\n  };\n\n  const handleShareClick = async (post) => {\n    const url = `${window.location.origin}/?post=${post.id}`;\n    try {\n      if (navigator.share) {\n        await navigator.share({\n          title: 'Post',\n          url,\n          text: post.caption || '',\n        });\n      } else {\n        await navigator.clipboard.writeText(url);\n        alert('Ссылка скопирована');\n      }\n    } catch (e) {\n      if (e.name !== 'AbortError') {\n        try {\n          await navigator.clipboard.writeText(url);\n          alert('Ссылка скопирована');\n        } catch {\n          console.error('Share error:', e);\n        }\n      }\n    }\n  };\n\n  const toggleSavedPost = (postId) => {\n    setSavedPostIds((prev) => {\n      const next = new Set(prev);\n      if (next.has(postId)) next.delete(postId);\n      else next.add(postId);\n      try {\n        localStorage.setItem('saved_post_ids', JSON.stringify([...next]));\n      } catch (_) {}\n      return next;\n    });\n  };\n\n  if (loading) {\n    return <div className=\"home-loading\">Загрузка...</div>;\n  }\n\n  return (\n    <div className=\"home-container\">\n      <div className=\"home-layout\">\n        {}\n        <aside className=\"home-sidebar\">\n          <div className=\"home-sidebar-logo\">ICHGRAM</div>\n          <nav className=\"home-sidebar-nav\">\n            <Link to=\"/\" className=\"home-nav-item active\">\n              <svg className=\"home-nav-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z\"></path>\n                <polyline points=\"9 22 9 12 15 12 15 22\"></polyline>\n              </svg>\n              <span>Home</span>\n            </Link>\n            <button \n              className={`home-nav-item ${showSearchPanel ? 'active' : ''}`}\n              onClick={() => {\n                setShowSearchPanel(!showSearchPanel);\n                if (!showSearchPanel) {\n                  setShowNotificationsPanel(false);\n                }\n              }}\n              style={{ background: 'none', border: 'none', width: '100%', textAlign: 'left', cursor: 'pointer' }}\n            >\n              <svg className=\"home-nav-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <circle cx=\"11\" cy=\"11\" r=\"8\"></circle>\n                <path d=\"m21 21-4.35-4.35\"></path>\n              </svg>\n              <span>Search</span>\n            </button>\n            <Link to=\"/explore\" className=\"home-nav-item\">\n              <svg className=\"home-nav-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <polygon points=\"12 2 2 7 12 12 22 7 12 2\"></polygon>\n                <polyline points=\"2 17 12 22 22 17\"></polyline>\n                <polyline points=\"2 12 12 17 22 12\"></polyline>\n              </svg>\n              <span>Explore</span>\n            </Link>\n            <Link to=\"/messages\" className=\"home-nav-item\">\n              <svg className=\"home-nav-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <line x1=\"22\" y1=\"2\" x2=\"11\" y2=\"13\"></line>\n                <polygon points=\"22 2 15 22 11 13 2 9 22 2\"></polygon>\n              </svg>\n              <span>Messages</span>\n            </Link>\n            <button\n              className={`home-nav-item ${showNotificationsPanel ? 'active' : ''}`}\n              onClick={() => {\n                setShowNotificationsPanel(!showNotificationsPanel);\n                if (!showNotificationsPanel) {\n                  setShowSearchPanel(false);\n                }\n              }}\n              style={{ background: 'none', border: 'none', width: '100%', textAlign: 'left', cursor: 'pointer' }}\n            >\n              <svg className=\"home-nav-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z\"></path>\n              </svg>\n              <span>Notifications</span>\n            </button>\n            <button\n              className=\"home-nav-item\"\n              onClick={() => {\n                setShowSearchPanel(false);\n                setShowNotificationsPanel(false);\n                openCreateModal();\n              }}\n              style={{ background: 'none', border: 'none', width: '100%', textAlign: 'left', cursor: 'pointer' }}\n            >\n              <svg className=\"home-nav-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"></rect>\n                <line x1=\"12\" y1=\"8\" x2=\"12\" y2=\"16\"></line>\n                <line x1=\"8\" y1=\"12\" x2=\"16\" y2=\"12\"></line>\n              </svg>\n              <span>Create</span>\n            </button>\n            <Link to=\"/profile\" className=\"home-nav-item\">\n              <svg className=\"home-nav-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"></path>\n                <circle cx=\"12\" cy=\"7\" r=\"4\"></circle>\n              </svg>\n              <span>Profile</span>\n            </Link>\n          </nav>\n          \n          {}\n          {user && (\n            <Link to=\"/profile\" className=\"home-sidebar-current-user\">\n              <div className=\"home-sidebar-current-avatar\">\n                {user.avatar ? (\n                  (user.avatarType === 'video' || (typeof user.avatar === 'string' && user.avatar.startsWith('data:video/'))) ? (\n                    <video\n                      src={user.avatar}\n                      className=\"home-post-avatar-image\"\n                      autoPlay\n                      loop\n                      muted\n                      playsInline\n                      onError={(e) => {\n                        console.error('Ошибка при загрузке видео-аватара в боковой панели:', e);\n                      }}\n                    />\n                  ) : (\n                    <img \n                      src={user.avatar} \n                      alt={user.username || 'avatar'}\n                      onError={(e) => {\n                        console.error('Ошибка при загрузке изображения-аватара в боковой панели:', e);\n                      }}\n                    />\n                  )\n                ) : (\n                  <span className=\"home-sidebar-current-initial\">\n                    {(user.username || 'U').charAt(0).toUpperCase()}\n                  </span>\n                )}\n              </div>\n              <div className=\"home-sidebar-current-info\">\n                <span className=\"home-sidebar-current-name\">\n                  {user.fullName || (user.username ? user.username.replace(/^@/, '') : '') || 'Пользователь'}\n                </span>\n                <span className=\"home-sidebar-current-username\">\n                  {user.username || ''}\n                </span>\n              </div>\n            </Link>\n          )}\n\n          {}\n          <div className=\"home-sidebar-bubbles\">\n            <div className=\"home-bubble home-bubble-1\"></div>\n            <div className=\"home-bubble home-bubble-2\"></div>\n            <div className=\"home-bubble home-bubble-3\"></div>\n            <div className=\"home-bubble home-bubble-4\"></div>\n            <div className=\"home-bubble home-bubble-5\"></div>\n            <div className=\"home-bubble home-bubble-6\"></div>\n          </div>\n        </aside>\n\n        {}\n        {(showSearchPanel || showNotificationsPanel) && (\n          <div\n            className=\"home-search-overlay\"\n            onClick={() => {\n              setShowSearchPanel(false);\n              setShowNotificationsPanel(false);\n            }}\n          ></div>\n        )}\n\n        {}\n        {showSearchPanel && (\n          <div className=\"home-search-panel\">\n            {}\n            <div className=\"home-search-panel-bubble home-search-panel-bubble-1\"></div>\n            <div className=\"home-search-panel-bubble home-search-panel-bubble-2\"></div>\n            <div className=\"home-search-panel-bubble home-search-panel-bubble-3\"></div>\n            <div className=\"home-search-panel-bubble home-search-panel-bubble-4\"></div>\n            <div className=\"home-search-panel-bubble home-search-panel-bubble-5\"></div>\n            <div className=\"home-search-panel-bubble home-search-panel-bubble-6\"></div>\n            <div className=\"home-search-panel-bubble home-search-panel-bubble-7\"></div>\n            <div className=\"home-search-panel-bubble home-search-panel-bubble-8\"></div>\n            <div className=\"home-search-panel-bubble home-search-panel-bubble-9\"></div>\n            <div className=\"home-search-panel-bubble home-search-panel-bubble-10\"></div>\n            <div className=\"home-search-panel-bubble home-search-panel-bubble-11\"></div>\n            <div className=\"home-search-panel-bubble home-search-panel-bubble-12\"></div>\n            \n            <div className=\"home-search-panel-header\">\n              <h2 className=\"home-search-panel-title\">Search</h2>\n            </div>\n\n            <div className=\"home-search-input-container\">\n              <svg className=\"home-search-input-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <circle cx=\"11\" cy=\"11\" r=\"8\"></circle>\n                <path d=\"m21 21-4.35-4.35\"></path>\n              </svg>\n              <input\n                type=\"text\"\n                className=\"home-search-input\"\n                placeholder=\"Search\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                autoFocus\n              />\n              {searchQuery && (\n                <button className=\"home-search-clear-btn\" onClick={() => setSearchQuery('')}>\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"></line>\n                    <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"></line>\n                  </svg>\n                </button>\n              )}\n            </div>\n\n            {!searchQuery && recentSearches.length > 0 && (\n              <div className=\"home-search-recent-section\">\n                <div className=\"home-search-recent-header\">\n                  <h3 className=\"home-search-recent-title\">Recent</h3>\n                  <button className=\"home-search-clear-recent-btn\" onClick={() => setRecentSearches([])}>\n                    Clear\n                  </button>\n                </div>\n                <div className=\"home-search-recent-list\">\n                  {recentSearches.map((search, index) => (\n                    <div key={index} className=\"home-search-recent-item\">\n                      <div className=\"home-search-recent-avatar\">\n                        {search === 'sashaa' ? (\n                          <img src={foto1} alt={search} className=\"home-search-recent-avatar-image\" />\n                        ) : (\n                          <div className=\"home-search-recent-avatar-placeholder\">\n                            {search.charAt(0).toUpperCase()}\n                          </div>\n                        )}\n                      </div>\n                      <span className=\"home-search-recent-username\">{search}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {searchQuery && (\n              <div className=\"home-search-results\">\n                {searchLoading ? (\n                  <div className=\"home-search-loading\">Поиск...</div>\n                ) : searchResults.length > 0 ? (\n                  <div className=\"home-search-results-list\">\n                    {searchResults.map((resultUser) => (\n                      <Link\n                        key={resultUser.id}\n                        to={`/profile/${resultUser.username}`}\n                        className=\"home-search-result-item\"\n                        onClick={() => {\n                          \n                          if (!recentSearches.includes(resultUser.username)) {\n                            setRecentSearches([resultUser.username, ...recentSearches.slice(0, 4)]);\n                          }\n                          setShowSearchPanel(false);\n                        }}\n                      >\n                        <div className=\"home-search-result-avatar\">\n                          {resultUser.avatar ? (\n                            <img src={resultUser.avatar} alt={resultUser.username} />\n                          ) : (\n                            <div className=\"home-search-result-avatar-placeholder\">\n                              {resultUser.username.charAt(0).toUpperCase()}\n                            </div>\n                          )}\n                        </div>\n                        <div className=\"home-search-result-info\">\n                          <span className=\"home-search-result-username\">{resultUser.username}</span>\n                          {resultUser.fullName && (\n                            <span className=\"home-search-result-fullname\">{resultUser.fullName}</span>\n                          )}\n                        </div>\n                      </Link>\n                    ))}\n                  </div>\n                ) : (\n                  <div className=\"home-search-no-results\">\n                    <p>Пользователи не найдены</p>\n                  </div>\n                )}\n              </div>\n            )}\n          </div>\n        )}\n\n        {}\n        {showNotificationsPanel && (\n          <div className=\"home-notifications-panel\">\n            <div className=\"home-notifications-header\">\n              <h2 className=\"home-notifications-title\">Notifications</h2>\n            </div>\n\n            <div className=\"home-notifications-section\">\n              <h3 className=\"home-notifications-subtitle\">New</h3>\n\n              <div className=\"home-notifications-list\">\n                {notifications.map((n) => (\n                  <button\n                    key={n.id}\n                    className=\"home-notification-item\"\n                    type=\"button\"\n                    onClick={() => handleNotificationClick(n.postId)}\n                  >\n                    <div className=\"home-notification-user\">\n                      <div className=\"home-notification-avatar\">\n                        <img src={n.avatar} alt={n.username} />\n                      </div>\n                      <div className=\"home-notification-text\">\n                        <span className=\"home-notification-username\">{n.username}</span>{' '}\n                        <span className=\"home-notification-action\">{n.text}</span>\n                        <div className=\"home-notification-time\">{n.timeAgo}</div>\n                      </div>\n                    </div>\n                    <div className=\"home-notification-preview\">\n                      <img src={n.previewImage} alt=\"post preview\" />\n                    </div>\n                  </button>\n                ))}\n              </div>\n            </div>\n          </div>\n        )}\n\n        {}\n        <main className={`home-main ${showSearchPanel || showNotificationsPanel ? 'home-main-dimmed' : ''}`}>\n          {}\n          <div className=\"home-posts-container\">\n            {feedLoading ? (\n              <div className=\"home-loading\">Загрузка постов...</div>\n            ) : feedError ? (\n              <div className=\"home-loading home-feed-error\">\n                <p>Ошибка загрузки ленты.</p>\n                <p>Убедитесь, что бэкенд запущен: в папке <code>backend</code> выполните <code>npm run dev</code>.</p>\n              </div>\n            ) : feedPosts.length === 0 ? (\n              <div className=\"home-loading\">\n                <p>Пока нет публикаций</p>\n                <p className=\"home-feed-empty-hint\">Опубликуйте первый пост (Create) или добавьте тестовые данные: в папке backend выполните <code>npm run seed:add</code>.</p>\n              </div>\n            ) : (\n              feedPosts.map((post) => {\n                const isMyPost = user && (user.dbId || user.id) && post.user?.id && String(post.user.id) === String(user.dbId || user.id);\n                const avatarFromProfile =\n                  isMyPost && post.profileId\n                    ? (() => {\n                        try {\n                          return localStorage.getItem(`profile_avatar_${post.profileId}`) || null;\n                        } catch {\n                          return null;\n                        }\n                      })()\n                    : null;\n                const displayAvatar = avatarFromProfile || post.user?.avatar;\n                const displayAvatarType =\n                  post.user?.avatarType === 'video' ||\n                  (typeof displayAvatar === 'string' && displayAvatar.startsWith('data:video/'))\n                    ? 'video'\n                    : 'image';\n                const postUsername = (post.user?.username || '').replace(/^@+/, '') || 'user';\n                const isCurrentUserPost = user && (user.dbId || user.id) && post.user?.id && String(post.user.id) === String(user.dbId || user.id);\n                const profileLink = isCurrentUserPost ? '/profile' : `/profile/${encodeURIComponent(postUsername)}`;\n                return (\n                <article key={post.id} id={`home-post-${post.id}`} className=\"home-post\">\n                  <div className=\"home-post-header\">\n                    <Link to={profileLink} className=\"home-post-user-link\">\n                      <div className=\"home-post-user\">\n                        <div className=\"home-post-avatar-placeholder\">\n                          {displayAvatar ? (\n                            displayAvatarType === 'video' ? (\n                              <video\n                                src={displayAvatar}\n                                className=\"home-post-avatar-image\"\n                                autoPlay\n                                loop\n                                muted\n                                playsInline\n                              />\n                            ) : (\n                              <img\n                                src={displayAvatar}\n                                alt={post.user?.username || 'User avatar'}\n                                className=\"home-post-avatar-image\"\n                              />\n                            )\n                          ) : (\n                            <div className=\"home-post-avatar-placeholder\">\n                              {(post.user?.username || 'U').charAt(0).toUpperCase()}\n                            </div>\n                          )}\n                        </div>\n                        <div className=\"home-post-user-info\">\n                          <span className=\"home-post-username\">{post.user?.username || 'User'}</span>\n                          <span className=\"home-post-time\">{formatTime(post.createdAt)}</span>\n                        </div>\n                      </div>\n                    </Link>\n                    {!isCurrentUserPost && (\n                      <button\n                        type=\"button\"\n                        className=\"home-post-follow-btn\"\n                        disabled={followLoadingId === String(post.user?.id)}\n                        onClick={async (e) => {\n                          e.preventDefault();\n                          const uid = post.user?.id;\n                          if (!uid || followLoadingId) return;\n                          setFollowLoadingId(String(uid));\n                          try {\n                            const res = await usersAPI.toggleFollow(uid);\n                            setFollowingUserIds((prev) => {\n                              const next = new Set(prev);\n                              const sid = String(uid);\n                              if (res.isFollowing) next.add(sid); else next.delete(sid);\n                              return next;\n                            });\n                          } catch (err) {\n                            console.error('Follow error:', err);\n                          } finally {\n                            setFollowLoadingId(null);\n                          }\n                        }}\n                      >\n                        {followingUserIds.has(String(post.user?.id)) ? 'following' : 'follow'}\n                      </button>\n                    )}\n                  </div>\n\n                  <div className=\"home-post-image-placeholder\">\n                    {post.isVideo || (typeof post.image === 'string' && post.image.startsWith('data:video')) ? (\n                      <video\n                        src={post.image}\n                        className=\"home-post-image\"\n                        autoPlay\n                        loop\n                        muted\n                        playsInline\n                      />\n                    ) : (\n                      <img src={post.image} alt={post.caption || 'Post image'} className=\"home-post-image\" />\n                    )}\n                  </div>\n\n                  <div className=\"home-post-actions\">\n                    <button\n                      type=\"button\"\n                      className={`home-post-action-btn${post.liked ? ' home-post-action-btn--liked' : ''}`}\n                      title=\"Нравится\"\n                      onClick={() => handleLikeClick(post)}\n                      disabled={likingPostId === post.id}\n                    >\n                      <svg className=\"home-post-icon\" viewBox=\"0 0 24 24\" fill={post.liked ? 'currentColor' : 'none'} stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <path d=\"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z\"></path>\n                      </svg>\n                      <span className=\"home-post-action-count\">{formatCount(post.likesCount)}</span>\n                    </button>\n                    <button\n                      type=\"button\"\n                      className=\"home-post-action-btn\"\n                      title=\"Комментарии\"\n                      onClick={() => openPostModal(post)}\n                    >\n                      <svg className=\"home-post-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\"></path>\n                      </svg>\n                      <span className=\"home-post-action-count\">{formatCount(post.commentsCount)}</span>\n                    </button>\n                    <button\n                      type=\"button\"\n                      className=\"home-post-action-btn\"\n                      title=\"Поделиться\"\n                      onClick={() => handleShareClick(post)}\n                    >\n                      <svg className=\"home-post-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <line x1=\"22\" y1=\"2\" x2=\"11\" y2=\"13\"></line>\n                        <polygon points=\"22 2 15 22 11 13 2 9 22 2\"></polygon>\n                      </svg>\n                    </button>\n                    <button\n                      type=\"button\"\n                      className={`home-post-action-btn${savedPostIds.has(post.id) ? ' home-post-action-btn--saved' : ''}`}\n                      title={savedPostIds.has(post.id) ? 'Убрать из сохранённых' : 'Сохранить'}\n                      onClick={() => toggleSavedPost(post.id)}\n                    >\n                      <svg className=\"home-post-icon\" viewBox=\"0 0 24 24\" fill={savedPostIds.has(post.id) ? 'currentColor' : 'none'} stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <path d=\"M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z\"></path>\n                      </svg>\n                    </button>\n                  </div>\n\n                  <div className=\"home-post-caption\">\n                    {post.caption || ''}\n                  </div>\n                </article>\n                );\n              })\n            )}\n          </div>\n\n          {}\n          <div className=\"home-updates-section\">\n            <div className=\"home-updates-icon\">\n              <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#00A9BE\" strokeWidth=\"3\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <polyline points=\"20 6 9 17 4 12\" />\n              </svg>\n            </div>\n            <h3 className=\"home-updates-title\">You've seen all the updates</h3>\n            <p className=\"home-updates-subtitle\">\n              You have viewed all new publications\n            </p>\n          </div>\n\n          {}\n          <footer className=\"home-footer\">\n            <nav className=\"home-footer-nav\">\n              <Link to=\"/\">Home</Link>\n              <Link to=\"/search\">Search</Link>\n              <Link to=\"/explore\">Explore</Link>\n              <Link to=\"/messages\">Messages</Link>\n              <Link to=\"/notifications\">Notifications</Link>\n              <Link to=\"/create\">Create</Link>\n            </nav>\n            <div className=\"home-footer-copyright\">© 2026 ICHgram</div>\n          </footer>\n        </main>\n\n        {}\n        {homePostModalId && (\n          <>\n            <div className=\"home-search-overlay\" onClick={closePostModal} aria-hidden=\"true\" />\n            <div className=\"home-post-modal\" role=\"dialog\" aria-modal=\"true\">\n              <button type=\"button\" className=\"home-post-modal-close\" onClick={closePostModal} aria-label=\"Закрыть\">×</button>\n              {!homePostModalData ? (\n                <div className=\"home-post-modal-loading\">Загрузка...</div>\n              ) : (\n                <div className=\"home-post-modal-inner\">\n                  <div className=\"home-post-modal-media\">\n                    {homePostModalData.isVideo || (typeof homePostModalData.image === 'string' && homePostModalData.image.startsWith('data:video')) ? (\n                      <video src={homePostModalData.image} controls playsInline className=\"home-post-modal-image\" />\n                    ) : (\n                      <img src={homePostModalData.image} alt=\"\" className=\"home-post-modal-image\" />\n                    )}\n                  </div>\n                  <div className=\"home-post-modal-side\">\n                    <div className=\"home-post-modal-actions\">\n                      <button\n                        type=\"button\"\n                        className={`home-post-action-btn${homePostModalData.liked ? ' home-post-action-btn--liked' : ''}`}\n                        title=\"Нравится\"\n                        onClick={() => handleLikeClick({ id: homePostModalData.id, liked: homePostModalData.liked, likesCount: homePostModalData.likesCount })}\n                        disabled={likingPostId === homePostModalData.id}\n                      >\n                        <svg className=\"home-post-icon\" viewBox=\"0 0 24 24\" fill={homePostModalData.liked ? 'currentColor' : 'none'} stroke=\"currentColor\" strokeWidth=\"2\"><path d=\"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z\"></path></svg>\n                        <span className=\"home-post-action-count\">{formatCount(homePostModalData.likesCount)}</span>\n                      </button>\n                      <span className=\"home-post-modal-comments-count\">{formatCount(homePostModalData.commentsCount)}</span>\n                    </div>\n                    <div className=\"home-post-modal-caption\">{homePostModalData.caption || ''}</div>\n                    <div className=\"home-post-modal-comments-list\">\n                      {(homePostModalData.comments || []).map((c) => (\n                        <div key={c.id} className=\"home-post-modal-comment\">\n                          <span className=\"home-post-modal-comment-username\">{c.user?.username || 'User'}</span>\n                          <span className=\"home-post-modal-comment-text\">{c.text}</span>\n                        </div>\n                      ))}\n                    </div>\n                    <form className=\"home-post-modal-add-comment\" onSubmit={handleHomeModalAddComment}>\n                      <input\n                        type=\"text\"\n                        className=\"home-post-modal-input\"\n                        placeholder=\"Добавить комментарий...\"\n                        value={homePostModalComment}\n                        onChange={(e) => setHomePostModalComment(e.target.value)}\n                        maxLength={500}\n                      />\n                      <button type=\"submit\" className=\"home-post-modal-submit\" disabled={!homePostModalComment.trim() || homePostModalSubmitting}>\n                        {homePostModalSubmitting ? '...' : 'Отправить'}\n                      </button>\n                    </form>\n                  </div>\n                </div>\n              )}\n            </div>\n          </>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default Home;\n"
        }
    ]
}