{
    "sourceFile": "frontend/src/components/PostModal/PostModal.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1770737356648,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1770737356648,
            "name": "Commit-0",
            "content": "import { useEffect, useState } from 'react'\nimport { postsAPI } from '../../services/api'\nimport { usePostModal } from '../../context/PostModalContext'\nimport EmojiPicker from '../EmojiPicker/EmojiPicker'\nimport './PostModal.css'\n\nconst formatCount = (count) => {\n  if (count == null || count === 0) return '0'\n  if (count >= 1000) return `${(count / 1000).toFixed(1)}k`\n  return String(count)\n}\n\nexport default function PostModal() {\n  const { isOpen, postId, initialData, closePostModal } = usePostModal()\n  const [postData, setPostData] = useState(null)\n  const [loading, setLoading] = useState(false)\n  const [likingPostId, setLikingPostId] = useState(null)\n  const [savingPostId, setSavingPostId] = useState(null)\n  const [comment, setComment] = useState('')\n  const [submitting, setSubmitting] = useState(false)\n\n  useEffect(() => {\n    if (!isOpen || !postId) {\n      setPostData(null)\n      setComment('')\n      return\n    }\n\n    if (initialData) {\n      setPostData(initialData)\n      return\n    }\n\n    let cancelled = false\n    setLoading(true)\n    setComment('')\n    postsAPI\n      .getPostById(postId)\n      .then((res) => {\n        if (!cancelled && res?.success && res?.post) {\n          setPostData(res.post)\n        }\n        if (!cancelled) setLoading(false)\n      })\n      .catch(() => {\n        if (!cancelled) setLoading(false)\n      })\n\n    return () => {\n      cancelled = true\n    }\n  }, [isOpen, postId, initialData])\n\n  const handleLikeClick = async () => {\n    if (!postData || likingPostId) return\n    setLikingPostId(postData.id)\n    try {\n      const res = await postsAPI.toggleLike(postData.id)\n      if (res.success) {\n        setPostData((d) =>\n          d\n            ? {\n                ...d,\n                liked: res.liked,\n                likesCount: res.likesCount ?? d.likesCount,\n              }\n            : d,\n        )\n      }\n    } catch (e) {\n      console.error('Like error:', e)\n    } finally {\n      setLikingPostId(null)\n    }\n  }\n\n  const handleToggleSave = async () => {\n    if (!postData || savingPostId) return\n    setSavingPostId(postData.id)\n    try {\n      const res = await postsAPI.toggleSave(postData.id)\n      if (res.success) {\n        setPostData((d) =>\n          d\n            ? {\n                ...d,\n                saved: res.saved,\n                savesCount:\n                  res.savesCount ?? (d.savesCount || 0) + (res.saved ? 1 : -1),\n              }\n            : d,\n        )\n      }\n    } catch (e) {\n      console.error('Toggle save error:', e)\n    } finally {\n      setSavingPostId(null)\n    }\n  }\n\n  const handleShareClick = async () => {\n    if (!postData) return\n    const url = `${window.location.origin}/?post=${postData.id}`\n    try {\n      if (navigator.share) {\n        await navigator.share({\n          title: 'Post',\n          url,\n          text: postData.caption || '',\n        })\n      } else {\n        await navigator.clipboard.writeText(url)\n        alert('Ссылка скопирована')\n      }\n    } catch (e) {\n      if (e.name !== 'AbortError') {\n        try {\n          await navigator.clipboard.writeText(url)\n          alert('Ссылка скопирована')\n        } catch {\n          console.error('Share error:', e)\n        }\n      }\n    }\n  }\n\n  const handleAddComment = async (e) => {\n    e.preventDefault()\n    if (!postData || !comment.trim() || submitting) return\n    setSubmitting(true)\n    try {\n      const res = await postsAPI.addComment(postData.id, comment.trim())\n      if (res.success && res.comment) {\n        setPostData((d) =>\n          d\n            ? {\n                ...d,\n                comments: [...(d.comments || []), res.comment],\n                commentsCount: (d.commentsCount || 0) + 1,\n              }\n            : d,\n        )\n        setComment('')\n      }\n    } catch (e) {\n      console.error('Add comment error:', e)\n    } finally {\n      setSubmitting(false)\n    }\n  }\n\n  if (!isOpen) return null\n\n  return (\n    <>\n      <div\n        className=\"post-modal-overlay\"\n        onClick={closePostModal}\n        aria-hidden=\"true\"\n      />\n      <div\n        className=\"post-modal\"\n        role=\"dialog\"\n        aria-modal=\"true\"\n        onClick={(e) => e.stopPropagation()}\n      >\n        <button\n          type=\"button\"\n          className=\"post-modal-close\"\n          onClick={closePostModal}\n          aria-label=\"Закрыть\"\n        >\n          ×\n        </button>\n        {loading ? (\n          <div className=\"post-modal-loading\">Загрузка...</div>\n        ) : postData ? (\n          <div className=\"post-modal-inner\">\n            <div className=\"post-modal-media\">\n              {(() => {\n                const imgs =\n                  postData.images?.length > 0\n                    ? postData.images\n                    : postData.image\n                      ? [postData.image]\n                      : []\n                const src = imgs[0]\n                const isVideo =\n                  postData.isVideo ||\n                  (typeof src === 'string' && src.startsWith('data:video'))\n                if (!src) return null\n                return isVideo ? (\n                  <video\n                    src={src}\n                    controls\n                    playsInline\n                    className=\"post-modal-image\"\n                  />\n                ) : (\n                  <img src={src} alt=\"\" className=\"post-modal-image\" />\n                )\n              })()}\n            </div>\n            <div className=\"post-modal-side\">\n              <div className=\"post-modal-actions\">\n                <button\n                  type=\"button\"\n                  className={`post-modal-action-btn post-modal-action-btn--like${postData.liked ? ' post-modal-action-btn--liked' : ''}`}\n                  title=\"Нравится\"\n                  onClick={handleLikeClick}\n                  disabled={likingPostId === postData.id}\n                >\n                  <svg\n                    className=\"post-modal-action-icon\"\n                    viewBox=\"0 0 24 24\"\n                    fill={postData.liked ? 'currentColor' : 'none'}\n                    stroke=\"currentColor\"\n                    strokeWidth=\"2\"\n                  >\n                    <path d=\"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z\"></path>\n                  </svg>\n                  <span className=\"post-modal-action-count\">\n                    {formatCount(postData.likesCount)}\n                  </span>\n                </button>\n                <span className=\"post-modal-comments-count\">\n                  {formatCount(postData.commentsCount)}\n                </span>\n                <button\n                  type=\"button\"\n                  className=\"post-modal-action-btn\"\n                  title=\"Поделиться\"\n                  onClick={handleShareClick}\n                >\n                  <svg\n                    className=\"post-modal-action-icon\"\n                    viewBox=\"0 0 24 24\"\n                    fill=\"none\"\n                    stroke=\"currentColor\"\n                    strokeWidth=\"2\"\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                  >\n                    <line x1=\"22\" y1=\"2\" x2=\"11\" y2=\"13\"></line>\n                    <polygon points=\"22 2 15 22 11 13 2 9 22 2\"></polygon>\n                  </svg>\n                </button>\n                <button\n                  type=\"button\"\n                  className={`post-modal-action-btn post-modal-action-btn--save${postData.saved ? ' post-modal-action-btn--saved' : ''}`}\n                  title=\"Saved\"\n                  onClick={handleToggleSave}\n                  disabled={savingPostId === postData.id}\n                >\n                  <svg\n                    className=\"post-modal-action-icon\"\n                    viewBox=\"0 0 24 24\"\n                    fill={postData.saved ? 'currentColor' : 'none'}\n                    stroke=\"currentColor\"\n                    strokeWidth=\"2\"\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                  >\n                    <path d=\"M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z\"></path>\n                  </svg>\n                  <span className=\"post-modal-action-count\">\n                    {formatCount(postData.savesCount ?? 0)}\n                  </span>\n                </button>\n              </div>\n              <div className=\"post-modal-caption-block\">\n                <div className=\"post-modal-title-text\">\n                  {postData.title || 'Untitled'}\n                </div>\n                <div className=\"post-modal-caption\">\n                  {postData.caption || ''}\n                </div>\n              </div>\n              <div className=\"post-modal-comments-list\">\n                {(postData.comments || []).map((c) => (\n                  <div key={c.id} className=\"post-modal-comment\">\n                    <div className=\"post-modal-comment-avatar\">\n                      {c.user?.avatar && typeof c.user.avatar === 'string' ? (\n                        c.user.avatar.startsWith('data:video') ? (\n                          <video\n                            src={c.user.avatar}\n                            autoPlay\n                            loop\n                            muted\n                            playsInline\n                          />\n                        ) : (\n                          <img\n                            src={c.user.avatar}\n                            alt={c.user?.username || 'avatar'}\n                          />\n                        )\n                      ) : (\n                        <span className=\"post-modal-comment-avatar-fallback\">\n                          {(c.user?.username || 'U').charAt(0).toUpperCase()}\n                        </span>\n                      )}\n                    </div>\n                    <div className=\"post-modal-comment-body\">\n                      <span className=\"post-modal-comment-username\">\n                        {c.user?.username || 'User'}\n                      </span>\n                      <span className=\"post-modal-comment-text\">{c.text}</span>\n                    </div>\n                  </div>\n                ))}\n              </div>\n              <form\n                className=\"post-modal-add-comment\"\n                onSubmit={handleAddComment}\n              >\n                <input\n                  type=\"text\"\n                  className=\"post-modal-input\"\n                  placeholder=\"Добавить комментарий...\"\n                  value={comment}\n                  onChange={(e) => setComment(e.target.value)}\n                  maxLength={500}\n                />\n                <EmojiPicker\n                  onSelect={(emoji) =>\n                    setComment((prev) =>\n                      prev.length + emoji.length <= 500 ? prev + emoji : prev,\n                    )\n                  }\n                  disabled={submitting}\n                />\n                <button\n                  type=\"submit\"\n                  className=\"post-modal-submit\"\n                  disabled={!comment.trim() || submitting}\n                >\n                  {submitting ? '...' : 'Send'}\n                </button>\n              </form>\n            </div>\n          </div>\n        ) : null}\n      </div>\n    </>\n  )\n}\n"
        }
    ]
}