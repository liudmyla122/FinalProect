{
    "sourceFile": "backend/src/scripts/seedAdditional.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1769702262522,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1769702262522,
            "name": "Commit-0",
            "content": "\nconst mongoose = require('mongoose');\nconst bcrypt = require('bcrypt');\nrequire('dotenv').config();\n\nconst User = require('../models/userModel');\nconst Post = require('../models/postModel');\nconst connectDB = require('../config/db');\n\n\nfunction svgImage(hexColor, text) {\n  const encoded = Buffer.from(\n    `<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"600\" height=\"600\" viewBox=\"0 0 600 600\"><rect width=\"100%\" height=\"100%\" fill=\"${hexColor}\"/><text x=\"50%\" y=\"50%\" font-size=\"24\" fill=\"rgba(255,255,255,0.9)\" text-anchor=\"middle\" dy=\".3em\" font-family=\"sans-serif\">${text}</text></svg>`,\n    'utf8'\n  ).toString('base64');\n  return `data:image/svg+xml;base64,${encoded}`;\n}\nconst FALLBACK_IMAGES = [\n  svgImage('#E8A87C', 'Sunset'),\n  svgImage('#4A90E2', 'Code'),\n  svgImage('#9B59B6', 'Art'),\n  svgImage('#27AE60', 'Fitness'),\n  svgImage('#E74C3C', 'Food'),\n  svgImage('#3498DB', 'Music'),\n  svgImage('#1ABC9C', 'Writing'),\n  svgImage('#2C3E50', 'Adventure'),\n];\n\n\nasync function fetchRealImage(seed, width = 600, height = 600) {\n  if (typeof fetch !== 'function') return null;\n  const url = `https://picsum.photos/${width}/${height}?random=${seed}`;\n  try {\n    const signal = AbortSignal.timeout ? AbortSignal.timeout(10000) : undefined;\n    const res = await fetch(url, { signal });\n    if (!res.ok) throw new Error(`HTTP ${res.status}`);\n    const buf = Buffer.from(await res.arrayBuffer());\n    const base64 = buf.toString('base64');\n    const contentType = res.headers.get('content-type') || 'image/jpeg';\n    return `data:${contentType};base64,${base64}`;\n  } catch (err) {\n    console.warn(`   ‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ (${url}): ${err.message}`);\n    return null;\n  }\n}\n\n\nasync function getPostImages() {\n  console.log('üñº –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ –¥–ª—è –ø–æ—Å—Ç–æ–≤ (picsum.photos)...');\n  const results = await Promise.all(\n    [1, 2, 3, 4, 5, 6, 7, 8].map((seed) => fetchRealImage(seed, 600, 600))\n  );\n  const images = results.map((data, i) => data || FALLBACK_IMAGES[i]);\n  const realCount = results.filter(Boolean).length;\n  if (realCount > 0) console.log(`   ‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${realCount}/8 (–æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî –∑–∞–ø–∞—Å–Ω—ã–µ)`);\n  else console.log('   ‚ö† –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–∞–ø–∞—Å–Ω—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–Ω–µ—Ç —Å–µ—Ç–∏ –∏–ª–∏ –æ—à–∏–±–∫–∞).');\n  return images;\n}\n\n\nasync function getAvatarImages() {\n  console.log('üë§ –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (picsum.photos 200x200)...');\n  const results = await Promise.all(\n    [11, 22, 33, 44, 55, 66, 77, 88].map((seed) => fetchRealImage(seed, 200, 200))\n  );\n  const fallbackAvatar = svgImage('#9B59B6', '?');\n  const images = results.map((data) => data || fallbackAvatar);\n  const realCount = results.filter(Boolean).length;\n  if (realCount > 0) console.log(`   ‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∞–≤–∞—Ç–∞—Ä–æ–≤: ${realCount}/8`);\n  else console.log('   ‚ö† –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–∞–ø–∞—Å–Ω—ã–µ –∞–≤–∞—Ç–∞—Ä—ã.');\n  return images;\n}\n\nconst testUsers = [\n  { email: 'sashaa@example.com', username: 'sashaa', fullName: 'Sasha Anderson', password: 'password123', avatar: '', bio: 'Photographer and traveler üåç' },\n  { email: 'igor@example.com', username: 'igor', fullName: 'Igor Petrov', password: 'password123', avatar: '', bio: 'Developer and designer üíª' },\n  { email: 'marija@example.com', username: 'marija', fullName: 'Marija Novak', password: 'password123', avatar: '', bio: 'Artist and creator üé®' },\n  { email: 'alex@example.com', username: 'alex', fullName: 'Alex Johnson', password: 'password123', avatar: '', bio: 'Fitness enthusiast üí™' },\n  { email: 'lisa@example.com', username: 'lisa', fullName: 'Lisa Brown', password: 'password123', avatar: '', bio: 'Food blogger üçï' },\n  { email: 'david@example.com', username: 'david', fullName: 'David Wilson', password: 'password123', avatar: '', bio: 'Musician and producer üéµ' },\n  { email: 'emma@example.com', username: 'emma', fullName: 'Emma Davis', password: 'password123', avatar: '', bio: 'Writer and poet üìù' },\n  { email: 'mike@example.com', username: 'mike', fullName: 'Mike Taylor', password: 'password123', avatar: '', bio: 'Adventure seeker üèîÔ∏è' },\n];\n\nfunction buildTestPosts(users, images) {\n  const img = (i) => (images && images[i]) || FALLBACK_IMAGES[i];\n  return [\n    { user: users[0]._id, image: img(0), images: [img(0)], isVideo: false, caption: 'Beautiful sunset today! üåÖ #sunset #nature', likes: [users[1]._id, users[2]._id], comments: [{ user: users[1]._id, text: 'Amazing shot! üî•' }] },\n    { user: users[1]._id, image: img(1), images: [img(1)], isVideo: false, caption: 'Working on a new project. Stay tuned! üíª #coding', likes: [users[0]._id], comments: [] },\n    { user: users[2]._id, image: img(2), images: [img(2)], isVideo: false, caption: 'New artwork in progress üé® #art #creative', likes: [users[0]._id, users[1]._id], comments: [{ user: users[0]._id, text: 'Stunning! ‚ú®' }] },\n    { user: users[3]._id, image: img(3), images: [img(3)], isVideo: false, caption: 'Morning workout complete! üí™ #fitness', likes: [], comments: [] },\n    { user: users[4]._id, image: img(4), images: [img(4)], isVideo: false, caption: 'Delicious homemade pasta üçù #food', likes: [users[0]._id], comments: [] },\n    { user: users[5]._id, image: img(5), images: [img(5)], isVideo: false, caption: 'New track dropping soon! üéµ #music', likes: [], comments: [] },\n    { user: users[6]._id, image: img(6), images: [img(6)], isVideo: false, caption: 'Words have power ‚úçÔ∏è #writing #poetry', likes: [users[2]._id], comments: [] },\n    { user: users[7]._id, image: img(7), images: [img(7)], isVideo: false, caption: 'Mountain adventure! üèîÔ∏è #adventure', likes: [users[0]._id, users[1]._id], comments: [] },\n  ];\n}\n\nconst seedAdditional = async () => {\n  try {\n    await connectDB();\n    console.log(' –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø–æ—Å—Ç–æ–≤ (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö)...\\n');\n\n    const createdUsers = [];\n    for (const userData of testUsers) {\n      const existing = await User.findOne({ $or: [{ email: userData.email }, { username: userData.username }] });\n      if (existing) {\n        console.log(`   ‚è≠ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å: ${userData.username}`);\n        createdUsers.push(existing);\n        continue;\n      }\n      const salt = await bcrypt.genSalt(10);\n      const hashedPassword = await bcrypt.hash(userData.password, salt);\n      const user = new User({ ...userData, password: hashedPassword });\n      await user.save();\n      createdUsers.push(user);\n      console.log(`   ‚úì –°–æ–∑–¥–∞–Ω: ${user.username} (${user.email})`);\n    }\n\n    \n    console.log(`–°–≤—è–∑–∏ followers/following (–º–µ–∂–¥—É –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)...`);\n    const followingIds = createdUsers.map((_, i) => {\n      const followingCount = Math.min(2, createdUsers.length - 1);\n      const arr = [];\n      for (let j = 1; j <= followingCount; j++) {\n        const idx = (i + j) % createdUsers.length;\n        if (idx !== i) arr.push(createdUsers[idx]._id);\n      }\n      return arr;\n    });\n    const followersIds = createdUsers.map((_, i) => {\n      const arr = [];\n      for (let j = 0; j < createdUsers.length; j++) {\n        if (j === i) continue;\n        if (followingIds[j].some(id => id.toString() === createdUsers[i]._id.toString())) {\n          arr.push(createdUsers[j]._id);\n        }\n      }\n      return arr;\n    });\n    for (let i = 0; i < createdUsers.length; i++) {\n      const user = createdUsers[i];\n      const curFollowing = (user.following || []).map(id => id.toString());\n      const toAddFollowing = followingIds[i].filter(id => !curFollowing.includes(id.toString()));\n      const curFollowers = (user.followers || []).map(id => id.toString());\n      const toAddFollowers = followersIds[i].filter(id => !curFollowers.includes(id.toString()));\n      if (toAddFollowing.length) user.following = [...(user.following || []), ...toAddFollowing];\n      if (toAddFollowers.length) user.followers = [...(user.followers || []), ...toAddFollowers];\n      if (toAddFollowing.length || toAddFollowers.length) await user.save();\n    }\n    console.log('   –ì–æ—Ç–æ–≤–æ');\n\n    \n    const avatarImages = await getAvatarImages();\n    for (let i = 0; i < createdUsers.length; i++) {\n      const user = createdUsers[i];\n      if (avatarImages[i]) {\n        user.avatar = avatarImages[i];\n        user.avatarType = 'image';\n        await user.save();\n      }\n    }\n    console.log('   ‚úì –ê–≤–∞—Ç–∞—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö');\n\n    const postImages = await getPostImages();\n    const postsData = buildTestPosts(createdUsers, postImages);\n    let created = 0;\n    for (let i = 0; i < createdUsers.length; i++) {\n      const user = createdUsers[i];\n      const hasPosts = user.posts && user.posts.length > 0;\n      if (hasPosts) continue;\n      const postData = postsData[i];\n      if (!postData) continue;\n      const post = new Post(postData);\n      await post.save();\n      user.posts = user.posts || [];\n      user.posts.push(post._id);\n      await user.save();\n      created++;\n    }\n    console.log(`\\nüì∏ –°–æ–∑–¥–∞–Ω–æ –ø–æ—Å—Ç–æ–≤: ${created}`);\n\n    \n    const userIds = createdUsers.map((u) => u._id);\n    const existingPosts = await Post.find({ user: { $in: userIds } }).sort({ createdAt: 1 });\n    let updated = 0;\n    for (const post of existingPosts) {\n      const userIndex = createdUsers.findIndex((u) => u._id.toString() === post.user.toString());\n      if (userIndex < 0 || userIndex >= postImages.length) continue;\n      const img = postImages[userIndex];\n      if (post.image !== img) {\n        post.image = img;\n        post.images = [img];\n        await post.save();\n        updated++;\n      }\n    }\n    if (updated) console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–æ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –≤ –ø–æ—Å—Ç–∞—Ö: ${updated}`);\n\n    console.log('–ì–æ—Ç–æ–≤–æ! –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ç—Ä–æ–Ω—É—Ç—ã. –í –ª–µ–Ω—Ç–µ —Ç–µ–ø–µ—Ä—å –ø–æ—Å—Ç—ã –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.');\n    console.log('   –ü–∞—Ä–æ–ª—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤: password123 (–Ω–∞–ø—Ä–∏–º–µ—Ä sashaa, igor, marija).');\n    process.exit(0);\n  } catch (error) {\n    console.error('–û—à–∏–±–∫–∞:', error);\n    process.exit(1);\n  }\n};\n\nseedAdditional();\n"
        }
    ]
}