{
    "sourceFile": "backend/src/controllers/authController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1769701540305,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1770727799585,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -313,20 +313,29 @@\n       });\n     }\n \n     \n-    const cleanedProfiles = profiles.map((profile) => ({\n-      id: profile.id || `profile-${Date.now()}-${Math.random()}`,\n-      username: profile.username || '',\n-      website: profile.website || '',\n-      about: profile.about || '',\n-      avatar: profile.avatar || '',\n-      avatarType: profile.avatarType || 'image',\n-      profileCompleted: profile.profileCompleted !== undefined ? profile.profileCompleted : false,\n-      postsCount: typeof profile.postsCount === 'number' ? profile.postsCount : 0,\n-      followersCount: typeof profile.followersCount === 'number' ? profile.followersCount : 0,\n-      followingCount: typeof profile.followingCount === 'number' ? profile.followingCount : 0,\n-    }));\n+    const cleanedProfiles = profiles.map((profile) => {\n+      const avatarVal = profile.avatar || '';\n+      // Auto-detect video type if not provided\n+      let type = profile.avatarType;\n+      if (!type) {\n+         type = avatarVal.startsWith('data:video/') ? 'video' : 'image';\n+      }\n+      \n+      return {\n+        id: profile.id || `profile-${Date.now()}-${Math.random()}`,\n+        username: profile.username || '',\n+        website: profile.website || '',\n+        about: profile.about || '',\n+        avatar: avatarVal,\n+        avatarType: type,\n+        profileCompleted: profile.profileCompleted !== undefined ? profile.profileCompleted : false,\n+        postsCount: typeof profile.postsCount === 'number' ? profile.postsCount : 0,\n+        followersCount: typeof profile.followersCount === 'number' ? profile.followersCount : 0,\n+        followingCount: typeof profile.followingCount === 'number' ? profile.followingCount : 0,\n+      };\n+    });\n \n     user.profiles = cleanedProfiles;\n     if (organization !== undefined) {\n       user.organization = typeof organization === 'string' ? organization.trim().slice(0, 200) : '';\n"
                },
                {
                    "date": 1770727857745,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -218,14 +218,14 @@\n       return res.status(404).json({ message: 'User not found' })\n     }\n \n     const avatarSizeMB = (avatar.length * 3) / 4 / 1024 / 1024\n-    const MAX_AVATAR_SIZE_MB = 1024 * 1024\n+    const MAX_AVATAR_SIZE_MB = 12 // Limit to 12MB (MongoDB doc limit is 16MB)\n \n     if (avatarSizeMB > MAX_AVATAR_SIZE_MB) {\n-      console.warn('âš ï¸ ÐÐ²Ð°Ñ‚Ð°Ñ€ Ð¾Ñ‡ÐµÐ½ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹:', avatarSizeMB.toFixed(2), 'MB')\n+      console.warn('âš ï¸ ÐÐ²Ð°Ñ‚Ð°Ñ€ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹:', avatarSizeMB.toFixed(2), 'MB')\n       return res.status(400).json({\n-        message: `Avatar is too large. Maximum size is 1TB`,\n+        message: `Avatar is too large (${avatarSizeMB.toFixed(2)} MB). Maximum size is ${MAX_AVATAR_SIZE_MB} MB.`,\n         avatarSizeMB: avatarSizeMB.toFixed(2),\n       })\n     }\n \n"
                }
            ],
            "date": 1769701540305,
            "name": "Commit-0",
            "content": "const User = require('../models/userModel');\nconst { generateToken } = require('../config/jwt');\n\n\nconst register = async (req, res) => {\n  try {\n    const { email, username, fullName, password } = req.body;\n\n    \n    if (!email || !username || !fullName || !password) {\n      return res.status(400).json({ message: 'All fields are required' });\n    }\n\n    if (password.length < 6) {\n      return res.status(400).json({ message: 'Password must be at least 6 characters' });\n    }\n\n    \n    const existingUser = await User.findOne({\n      $or: [{ email }, { username }],\n    });\n\n    if (existingUser) {\n      return res.status(400).json({\n        message: existingUser.email === email ? 'Email already exists' : 'Username already exists',\n      });\n    }\n\n    \n    const user = new User({\n      email,\n      username,\n      fullName,\n      password,\n    });\n\n    await user.save();\n\n    \n    const token = generateToken(user._id);\n\n    res.status(201).json({\n      message: 'User registered successfully',\n      token,\n      user: {\n        id: user._id,\n        email: user.email,\n        username: user.username,\n        fullName: user.fullName,\n        avatar: user.avatar,\n        bio: user.bio,\n        profiles: user.profiles || [],\n      },\n    });\n  } catch (error) {\n    console.error('Registration error:', error);\n    res.status(500).json({ message: 'Server error during registration', error: error.message });\n  }\n};\n\n\nconst login = async (req, res) => {\n  try {\n    const { email, password } = req.body;\n    const loginInput = (email && typeof email === 'string' ? email.trim() : '') || '';\n    const passwordInput = password != null && typeof password === 'string' ? password : '';\n\n    if (!loginInput || !passwordInput) {\n      return res.status(400).json({ message: 'Email and password are required' });\n    }\n\n    \n    const isEmail = loginInput.includes('@');\n    const user = await User.findOne(\n      isEmail\n        ? { email: loginInput.toLowerCase() }\n        : { username: loginInput }\n    );\n\n    if (!user) {\n      return res.status(401).json({ message: 'Invalid email or password' });\n    }\n\n    \n    const isPasswordValid = await user.comparePassword(passwordInput);\n\n    if (!isPasswordValid) {\n      return res.status(401).json({ message: 'Invalid email or password' });\n    }\n\n    \n    const token = generateToken(user._id);\n\n    res.status(200).json({\n      message: 'Login successful',\n      token,\n      user: {\n        id: user._id,\n        email: user.email,\n        username: user.username,\n        fullName: user.fullName,\n        avatar: user.avatar,\n        bio: user.bio,\n        profiles: user.profiles || [],\n      },\n    });\n  } catch (error) {\n    console.error('Login error:', error);\n    res.status(500).json({ message: 'Server error during login', error: error.message });\n  }\n};\n\n\nconst getCurrentUser = async (req, res) => {\n  try {\n    \n    const user = req.user;\n    \n    if (!user) {\n      console.error('âŒ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² req.user');\n      return res.status(404).json({ \n        success: false,\n        message: 'User not found' \n      });\n    }\n    \n    console.log('ðŸ“¤ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:', {\n      userId: user._id,\n      username: user.username,\n      hasAvatar: !!user.avatar,\n      avatarLength: user.avatar?.length || 0,\n      avatarType: typeof user.avatar,\n      profilesCount: user.profiles?.length || 0\n    });\n    \n    \n    let avatarType = user.avatarType || 'image';\n    if (user.avatar && typeof user.avatar === 'string' && user.avatar.startsWith('data:video/')) {\n      avatarType = 'video';\n    }\n    \n    \n    let avatar = user.avatar || '';\n    if (avatar && typeof avatar !== 'string') {\n      console.warn('âš ï¸ ÐÐ²Ð°Ñ‚Ð°Ñ€ Ð½Ðµ ÑÐ²Ð»ÑÐµÑ‚ÑÑ ÑÑ‚Ñ€Ð¾ÐºÐ¾Ð¹, Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð² ÑÑ‚Ñ€Ð¾ÐºÑƒ');\n      avatar = String(avatar);\n    }\n    \n    \n    const responseData = {\n      success: true,\n      user: {\n        id: user._id,\n        email: user.email,\n        username: user.username,\n        fullName: user.fullName,\n        avatar: avatar,\n        avatarType: avatarType,\n        bio: user.bio || '',\n        profiles: user.profiles || [],\n      },\n    };\n    \n    \n    try {\n      const jsonString = JSON.stringify(responseData);\n      const sizeMB = Buffer.byteLength(jsonString, 'utf8') / 1024 / 1024;\n      \n      if (sizeMB > 100) {\n        console.warn(`âš ï¸ Ð Ð°Ð·Ð¼ÐµÑ€ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¾Ñ‡ÐµÐ½ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹: ${sizeMB.toFixed(2)} MB`);\n      }\n      \n      console.log(`ðŸ“¦ Ð Ð°Ð·Ð¼ÐµÑ€ Ð¾Ñ‚Ð²ÐµÑ‚Ð°: ${sizeMB.toFixed(2)} MB`);\n    } catch (jsonError) {\n      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° JSON:', jsonError);\n    }\n    \n    res.status(200).json(responseData);\n  } catch (error) {\n    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:', error);\n    console.error('Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸:', {\n      name: error.name,\n      message: error.message,\n      stack: error.stack\n    });\n    res.status(500).json({ \n      success: false,\n      message: 'Server error during fetching user', \n      error: error.message \n    });\n  }\n};\n\n\nconst updateAvatar = async (req, res) => {\n  try {\n    const { avatar } = req.body || {};\n\n    console.log('ðŸ“¥ Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°:', {\n      userId: req.user?._id,\n      hasAvatar: !!avatar,\n      avatarType: typeof avatar,\n      avatarLength: avatar?.length || 0,\n      avatarPreview: avatar?.substring(0, 50) || 'Ð½ÐµÑ‚'\n    });\n\n    if (!avatar || typeof avatar !== 'string') {\n      console.warn('âš ï¸ ÐÐµÐ²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ð¹ Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ð² Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ');\n      return res.status(400).json({ message: 'Avatar (base64 string) is required' });\n    }\n\n    \n    const user = req.user;\n    if (!user) {\n      console.error('âŒ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² req.user');\n      return res.status(404).json({ message: 'User not found' });\n    }\n\n \n    const avatarSizeMB = (avatar.length * 3) / 4 / 1024 / 1024; \n    const MAX_AVATAR_SIZE_MB = 1024 * 1024; \n    \n    if (avatarSizeMB > MAX_AVATAR_SIZE_MB) {\n      console.warn('âš ï¸ ÐÐ²Ð°Ñ‚Ð°Ñ€ Ð¾Ñ‡ÐµÐ½ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹:', avatarSizeMB.toFixed(2), 'MB');\n      return res.status(400).json({ \n        message: `Avatar is too large. Maximum size is 1TB`,\n        avatarSizeMB: avatarSizeMB.toFixed(2)\n      });\n    }\n    \n    \n    if (avatarSizeMB > 15) {\n      console.warn('âš ï¸ Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: ÐÐ²Ð°Ñ‚Ð°Ñ€ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°ÐµÑ‚ Ð»Ð¸Ð¼Ð¸Ñ‚ MongoDB (16MB). ÐœÐ¾Ð¶ÐµÑ‚ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ñ‚ÑŒÑÑ GridFS Ð¸Ð»Ð¸ Ð²Ð½ÐµÑˆÐ½ÐµÐµ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ.');\n    }\n\n    \n    const avatarType = avatar.startsWith('data:video/') ? 'video' : 'image';\n\n    user.avatar = avatar;\n    user.avatarType = avatarType;\n    \n    try {\n      await user.save();\n      \n      \n      const savedUser = await User.findById(user._id);\n      const avatarSaved = savedUser && savedUser.avatar && savedUser.avatar.length > 0;\n      \n      console.log('âœ… ÐÐ²Ð°Ñ‚Ð°Ñ€ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½ Ð² Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…:', {\n        userId: user._id,\n        avatarLength: user.avatar?.length || 0,\n        avatarType: avatarType,\n        avatarSizeMB: avatarSizeMB.toFixed(2),\n        avatarSaved: avatarSaved,\n        savedAvatarLength: savedUser?.avatar?.length || 0\n      });\n      \n      if (!avatarSaved) {\n        console.error('âŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐÐ²Ð°Ñ‚Ð°Ñ€ Ð½Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ð»ÑÑ Ð² Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…!');\n        return res.status(500).json({ \n          message: 'Avatar was not saved to database',\n          error: 'Save operation failed'\n        });\n      }\n    } catch (saveError) {\n      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ð¸ Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð° Ð² MongoDB:', saveError);\n      if (saveError.message && saveError.message.includes('too large')) {\n        return res.status(400).json({ \n          message: 'Avatar is too large for database',\n          error: saveError.message\n        });\n      }\n      throw saveError;\n    }\n\n    return res.status(200).json({\n      message: 'Avatar updated successfully',\n      user: {\n        id: user._id,\n        email: user.email,\n        username: user.username,\n        fullName: user.fullName,\n        avatar: user.avatar, \n        avatarType: user.avatarType || avatarType, \n        bio: user.bio,\n        profiles: user.profiles || [],\n      },\n    });\n  } catch (error) {\n    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°:', error);\n    res.status(500).json({ message: 'Server error during avatar update', error: error.message });\n  }\n};\n\n\nconst updateProfiles = async (req, res) => {\n  try {\n    const { profiles } = req.body || {};\n\n    if (!Array.isArray(profiles)) {\n      return res.status(400).json({ \n        success: false,\n        message: 'Profiles array is required' \n      });\n    }\n\n    \n    const user = req.user;\n    if (!user) {\n      return res.status(404).json({ \n        success: false,\n        message: 'User not found' \n      });\n    }\n\n    \n    const cleanedProfiles = profiles.map((profile) => ({\n      id: profile.id || `profile-${Date.now()}-${Math.random()}`,\n      username: profile.username || '',\n      website: profile.website || '',\n      about: profile.about || '',\n      avatar: profile.avatar || '',\n      avatarType: profile.avatarType || 'image',\n      profileCompleted: profile.profileCompleted !== undefined ? profile.profileCompleted : false,\n      postsCount: typeof profile.postsCount === 'number' ? profile.postsCount : 0,\n      followersCount: typeof profile.followersCount === 'number' ? profile.followersCount : 0,\n      followingCount: typeof profile.followingCount === 'number' ? profile.followingCount : 0,\n    }));\n\n    user.profiles = cleanedProfiles;\n    await user.save();\n\n    return res.status(200).json({\n      success: true,\n      message: 'Profiles updated successfully',\n      user: {\n        id: user._id,\n        email: user.email,\n        username: user.username,\n        fullName: user.fullName,\n        avatar: user.avatar,\n        bio: user.bio,\n        profiles: user.profiles || [],\n      },\n    });\n  } catch (error) {\n    console.error('Update profiles error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error during profiles update',\n      error: error.message,\n    });\n  }\n};\n\n\nconst resetPassword = async (req, res) => {\n  try {\n    const { emailOrUsername } = req.body;\n\n    \n    if (!emailOrUsername || emailOrUsername.trim() === '') {\n      return res.status(400).json({ message: 'Email or username is required' });\n    }\n\n    \n    const user = await User.findOne({\n      $or: [\n        { email: emailOrUsername.toLowerCase().trim() },\n        { username: emailOrUsername.trim() },\n      ],\n    });\n\n    \n    if (!user) {\n      \n      return res.status(200).json({\n        message: 'If an account with that email or username exists, we have sent a password reset link.',\n      });\n    }\n\n    \n    console.log(`Password reset requested for user: ${user.email}`);\n\n    res.status(200).json({\n      message: 'If an account with that email or username exists, we have sent a password reset link.',\n    \n    });\n  } catch (error) {\n    console.error('Reset password error:', error);\n    res.status(500).json({ message: 'Server error during password reset', error: error.message });\n  }\n};\n\nmodule.exports = {\n  register,\n  login,\n  getCurrentUser,\n  resetPassword,\n  updateAvatar,\n  updateProfiles,\n};\n"
        }
    ]
}