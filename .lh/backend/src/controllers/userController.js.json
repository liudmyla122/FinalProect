{
    "sourceFile": "backend/src/controllers/userController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1769701952380,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1769786763601,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,7 @@\n const User = require('../models/userModel')\n const Post = require('../models/postModel')\n+const { createNotification } = require('./notificationController')\n \n const getProfileByUsername = async (req, res) => {\n   try {\n     const { username } = req.params\n"
                },
                {
                    "date": 1769786773040,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -172,8 +172,15 @@\n       if (!targetUser.followers) targetUser.followers = []\n       targetUser.followers.push(me._id)\n       if (!me.following) me.following = []\n       me.following.push(targetUser._id)\n+\n+      // Create notification\n+      await createNotification({\n+        recipient: targetUser._id,\n+        sender: me._id,\n+        type: 'follow',\n+      })\n     }\n \n     await targetUser.save()\n     await me.save()\n"
                }
            ],
            "date": 1769701952380,
            "name": "Commit-0",
            "content": "const User = require('../models/userModel');\nconst Post = require('../models/postModel');\n\n\nconst getProfileByUsername = async (req, res) => {\n  try {\n    const { username } = req.params;\n    if (!username || !username.trim()) {\n      return res.status(400).json({ success: false, message: 'Username is required' });\n    }\n    const currentUserId = req.user?._id;\n\n    const foundUser = await User.findOne({ username: username.trim() })\n      .select('username fullName avatar avatarType bio followers following')\n      .lean();\n\n    if (!foundUser) {\n      return res.status(404).json({ success: false, message: 'User not found' });\n    }\n\n    const followersCount = foundUser.followers?.length || 0;\n    const followingCount = foundUser.following?.length || 0;\n    const isFollowing =\n      currentUserId &&\n      Array.isArray(foundUser.followers) &&\n      foundUser.followers.some((id) => id && id.toString() === currentUserId.toString());\n\n    const posts = await Post.find({ user: foundUser._id }).sort({ createdAt: -1 }).lean();\n    const postsCount = posts.length;\n\n    res.status(200).json({\n      success: true,\n      user: {\n        id: foundUser._id,\n        username: foundUser.username,\n        fullName: foundUser.fullName || '',\n        avatar: foundUser.avatar || '',\n        avatarType: foundUser.avatarType || 'image',\n        bio: foundUser.bio || '',\n        followersCount,\n        followingCount,\n        postsCount,\n        isFollowing: !!isFollowing,\n      },\n    });\n  } catch (error) {\n    console.error('Get profile by username error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error',\n      error: error.message,\n    });\n  }\n};\n\n\nconst getPostsByUserId = async (req, res) => {\n  try {\n    const { userId } = req.params;\n    if (!userId) {\n      return res.status(400).json({ success: false, message: 'User id is required' });\n    }\n\n    const posts = await Post.find({ user: userId })\n      .sort({ createdAt: -1 })\n      .populate('user', 'username fullName avatar avatarType')\n      .lean();\n\n    const currentUserId = req.user?._id;\n    const formatted = posts.map((post) => {\n      const u = post.user;\n      const liked =\n        currentUserId &&\n        Array.isArray(post.likes) &&\n        post.likes.some((lid) => lid && lid.toString() === currentUserId.toString());\n      return {\n        id: post._id,\n        profileId: post.profileId != null ? String(post.profileId) : null,\n        image: post.image,\n        images: post.images?.length ? post.images : [post.image].filter(Boolean),\n        isVideo: !!post.isVideo,\n        title: post.title != null ? String(post.title) : '',\n        caption: post.caption || '',\n        createdAt: post.createdAt,\n        updatedAt: post.updatedAt,\n        user: u\n          ? {\n              id: u._id,\n              username: u.username,\n              fullName: u.fullName,\n              avatar: u.avatar || '',\n              avatarType: u.avatarType || 'image',\n            }\n          : null,\n        likesCount: post.likes?.length || 0,\n        commentsCount: post.comments?.length || 0,\n        viewsCount: post.views || 0,\n        liked: !!liked,\n      };\n    });\n\n    res.status(200).json({\n      success: true,\n      posts: formatted,\n      count: formatted.length,\n    });\n  } catch (error) {\n    console.error('Get posts by user id error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error',\n      error: error.message,\n    });\n  }\n};\n\n\nconst toggleFollow = async (req, res) => {\n  try {\n    const currentUser = req.user;\n    if (!currentUser || !currentUser._id) {\n      return res.status(401).json({ success: false, message: 'Not authenticated' });\n    }\n    const { userId } = req.params;\n    if (!userId || userId === currentUser._id.toString()) {\n      return res.status(400).json({ success: false, message: 'Invalid user id' });\n    }\n\n    const targetUser = await User.findById(userId);\n    if (!targetUser) {\n      return res.status(404).json({ success: false, message: 'User not found' });\n    }\n\n    const me = await User.findById(currentUser._id);\n    if (!me) {\n      return res.status(404).json({ success: false, message: 'Current user not found' });\n    }\n\n    const myFollowing = (me.following || []).map((id) => id.toString());\n    const targetFollowers = (targetUser.followers || []).map((id) => id.toString());\n    const isFollowing = targetFollowers.includes(me._id.toString());\n\n    if (isFollowing) {\n      targetUser.followers = (targetUser.followers || []).filter(\n        (id) => id.toString() !== me._id.toString()\n      );\n      me.following = (me.following || []).filter((id) => id.toString() !== targetUser._id.toString());\n    } else {\n      if (!targetUser.followers) targetUser.followers = [];\n      targetUser.followers.push(me._id);\n      if (!me.following) me.following = [];\n      me.following.push(targetUser._id);\n    }\n\n    await targetUser.save();\n    await me.save();\n\n    res.status(200).json({\n      success: true,\n      isFollowing: !isFollowing,\n      followersCount: targetUser.followers.length,\n    });\n  } catch (error) {\n    console.error('Toggle follow error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error',\n      error: error.message,\n    });\n  }\n};\n\nmodule.exports = {\n  getProfileByUsername,\n  getPostsByUserId,\n  toggleFollow,\n};\n"
        }
    ]
}