{
    "sourceFile": "backend/src/controllers/postController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1769701818712,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1769701901999,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -556,12 +556,9 @@\n     })\n   }\n }\n \n-/**\n- * ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¿Ð¾ÑÑ‚Ð° Ñ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÑÐ¼Ð¸\n- * GET /api/posts/:id\n- */\n+\n const getPostById = async (req, res) => {\n   try {\n     const { id } = req.params\n \n@@ -589,9 +586,9 @@\n     const formatted = {\n       id: post._id,\n       image: post.image,\n       images:\n-        post.images && post.images.length > 0 ? post.images : [post.image], // ÐœÐ°ÑÑÐ¸Ð² Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹\n+        post.images && post.images.length > 0 ? post.images : [post.image], \n       isVideo: post.isVideo || false,\n       title: post.title != null ? String(post.title) : '',\n       caption: post.caption || '',\n       createdAt: post.createdAt,\n@@ -639,13 +636,9 @@\n     })\n   }\n }\n \n-/**\n- * Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ñ Ðº Ð¿Ð¾ÑÑ‚Ñƒ\n- * POST /api/posts/:id/comments\n- * body: { text: string, parentCommentId?: string }\n- */\n+\n const addComment = async (req, res) => {\n   try {\n     const { id } = req.params\n     const { text, parentCommentId } = req.body || {}\n@@ -672,9 +665,9 @@\n         message: 'Post not found',\n       })\n     }\n \n-    // Ð•ÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½ parentCommentId, ÑÑ‚Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚ Ð½Ð° ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹\n+    \n     if (parentCommentId) {\n       const parentComment = post.comments.id(parentCommentId)\n       if (!parentComment) {\n         return res.status(404).json({\n@@ -689,9 +682,9 @@\n       })\n \n       await post.save()\n \n-      // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾ÑÑ‚ Ñ populate\n+      \n       const updatedPost = await Post.findById(id).populate(\n         'comments.replies.user',\n         'username fullName avatar'\n       )\n@@ -715,17 +708,17 @@\n         },\n         isReply: true,\n       })\n     } else {\n-      // ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹\n+      \n       post.comments.push({\n         user: req.user._id,\n         text: text.trim(),\n       })\n \n       await post.save()\n \n-      // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾ÑÑ‚ Ñ populate\n+      \n       const updatedPost = await Post.findById(id)\n         .populate('comments.user', 'username fullName avatar')\n         .lean()\n \n@@ -756,12 +749,9 @@\n     })\n   }\n }\n \n-/**\n- * Ð£Ð²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð¸Ðµ ÑÑ‡ÐµÑ‚Ñ‡Ð¸ÐºÐ° Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¾Ð² Ð¿Ð¾ÑÑ‚Ð°\n- * POST /api/posts/:id/views\n- */\n+\n const incrementViews = async (req, res) => {\n   try {\n     const { id } = req.params\n \n@@ -791,12 +781,9 @@\n     })\n   }\n }\n \n-/**\n- * ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð»Ð°Ð¹ÐºÐ° Ð¿Ð¾ÑÑ‚Ð°\n- * POST /api/posts/:id/like\n- */\n+\n const toggleLike = async (req, res) => {\n   try {\n     const { id } = req.params\n     const post = await Post.findById(id)\n"
                },
                {
                    "date": 1769786711449,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -937,8 +937,16 @@\n       liked = false\n     } else {\n       post.likes.push(userId)\n       liked = true\n+\n+      // Create notification\n+      await createNotification({\n+        recipient: post.user,\n+        sender: userId,\n+        type: 'like',\n+        post: post._id,\n+      })\n     }\n     await post.save()\n     return res.status(200).json({\n       success: true,\n"
                }
            ],
            "date": 1769701818712,
            "name": "Commit-0",
            "content": "const Post = require('../models/postModel');\n\n\nconst createPost = async (req, res) => {\n  try {\n    \n    if (!req.user || !req.user._id) {\n      console.error('âŒ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² req.user Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð¿Ð¾ÑÑ‚Ð°');\n      return res.status(401).json({\n        success: false,\n        message: 'User not authenticated',\n      });\n    }\n\n    const { image, images, caption = '', title = '', profileId } = req.body || {};\n\n    \n    let imageArray = [];\n    \n    if (images && Array.isArray(images) && images.length > 0) {\n      \n      imageArray = images;\n    } else if (image && typeof image === 'string') {\n     \n      imageArray = [image];\n    } else {\n      return res.status(400).json({\n        success: false,\n        message: 'Image(s) (base64 string or array) is required',\n      });\n    }\n\n   \n    if (imageArray.length > 5) {\n      return res.status(400).json({\n        success: false,\n        message: 'Maximum 5 images allowed per post',\n      });\n    }\n\n    \n    const invalidImages = [];\n    const MAX_SINGLE_IMAGE_SIZE = 1024 * 1024 * 1024 * 1024; \n    \n    imageArray.forEach((img, index) => {\n      if (typeof img !== 'string' || img.trim().length === 0) {\n        invalidImages.push(`Image ${index + 1} is not a valid string`);\n      } else if (!img.startsWith('data:image/') && !img.startsWith('data:video/')) {\n        invalidImages.push(`Image ${index + 1} is not a valid base64 data URL`);\n      } else if (img.length > MAX_SINGLE_IMAGE_SIZE) {\n        const sizeMB = (img.length * 3) / 4 / 1024 / 1024;\n        invalidImages.push(`Image ${index + 1} is too large (${sizeMB.toFixed(2)} MB). Maximum is 1 TB per image.`);\n      }\n    });\n\n    if (invalidImages.length > 0) {\n      return res.status(400).json({\n        success: false,\n        message: 'Invalid images detected',\n        errors: invalidImages,\n      });\n    }\n\n    if (caption && caption.length > 2200) {\n      return res.status(400).json({\n        success: false,\n        message: 'Caption must be less than 2200 characters',\n      });\n    }\n    if (title && title.length > 300) {\n      return res.status(400).json({\n        success: false,\n        message: 'Title must be less than 300 characters',\n      });\n    }\n\n    \n    const hasVideo = imageArray.some(img => img.startsWith('data:video'));\n    const isVideo = hasVideo;\n\n    \n    const postData = {\n      user: req.user._id,\n      profileId: profileId && String(profileId).trim() ? String(profileId).trim() : null,\n      image: imageArray[0], \n      images: imageArray.length > 0 ? imageArray : [imageArray[0]], \n      title: title && String(title).trim() ? String(title).trim() : '',\n      caption: caption || '',\n      isVideo,\n    };\n\n    \n    if (!postData.images || postData.images.length === 0) {\n      return res.status(400).json({\n        success: false,\n        message: 'Images array cannot be empty',\n      });\n    }\n\n    \n    const totalSize = imageArray.reduce((sum, img) => sum + (img ? img.length : 0), 0);\n    const totalSizeMB = (totalSize * 3) / 4 / 1024 / 1024; \n    \n    \n    const MAX_DOCUMENT_SIZE_MB = 1024 * 1024; \n    \n    if (totalSizeMB > MAX_DOCUMENT_SIZE_MB) {\n      return res.status(400).json({\n        success: false,\n        message: `Post data is too large (${totalSizeMB.toFixed(2)} MB). Maximum allowed is ${MAX_DOCUMENT_SIZE_MB} MB. Try uploading fewer or smaller images.`,\n      });\n    }\n    \n    console.log('ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾ÑÑ‚Ð°:', {\n      userId: req.user._id,\n      imagesCount: imageArray.length,\n      captionLength: caption.length,\n      isVideo: isVideo,\n      totalSizeMB: totalSizeMB.toFixed(2),\n      firstImagePreview: imageArray[0]?.substring(0, 50) || 'Ð½ÐµÑ‚',\n      postDataKeys: Object.keys(postData),\n      imagesArrayLength: postData.images?.length || 0\n    });\n\n    \n    const MONGODB_MAX_DOCUMENT_SIZE_MB = 15; \n    \n    if (totalSizeMB > MONGODB_MAX_DOCUMENT_SIZE_MB) {\n      return res.status(400).json({\n        success: false,\n        message: `Ð Ð°Ð·Ð¼ÐµÑ€ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ÑÑ‚Ð° (${totalSizeMB.toFixed(2)} MB) Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°ÐµÑ‚ Ð»Ð¸Ð¼Ð¸Ñ‚ MongoDB (${MONGODB_MAX_DOCUMENT_SIZE_MB} MB). ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑƒÐ¼ÐµÐ½ÑŒÑˆÐ¸Ñ‚Ðµ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ð¸Ð»Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð¼ÐµÐ½ÑŒÑˆÐµ Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ð¹.`,\n        totalSizeMB: totalSizeMB.toFixed(2),\n        maxAllowedMB: MONGODB_MAX_DOCUMENT_SIZE_MB,\n      });\n    }\n\n    \n    if (totalSizeMB > 10) {\n      console.warn(' ÐŸÐ¾ÑÑ‚ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ:', totalSizeMB.toFixed(2), 'MB');\n    }\n\n    try {\n      console.log(' ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Post Ð² MongoDB...');\n      console.log('Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿Ð¾ÑÑ‚Ð°:', {\n        userId: req.user._id,\n        username: req.user.username,\n        imagesCount: imageArray.length,\n        captionLength: caption.length,\n        postDataKeys: Object.keys(postData)\n      });\n      \n      const post = await Post.create(postData);\n      \n      console.log('ÐŸÐ¾ÑÑ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…:', {\n        postId: post._id,\n        imagesCount: post.images?.length || 0\n      });\n    \n      \n      const createdPost = {\n        id: post._id,\n        image: post.image, \n        images: post.images && post.images.length > 0 ? post.images : [post.image], \n        isVideo: post.isVideo || false,\n        title: post.title || '',\n        caption: post.caption || '',\n        createdAt: post.createdAt,\n        updatedAt: post.updatedAt,\n        user: {\n          id: req.user._id,\n          username: req.user.username || 'Unknown',\n          fullName: req.user.fullName || 'Unknown User',\n          avatar: req.user.avatar || '',\n        },\n        likesCount: post.likes?.length || 0,\n        commentsCount: post.comments?.length || 0,\n        viewsCount: post.views || 0,\n      };\n\n      return res.status(201).json({\n        success: true,\n        post: createdPost,\n      });\n    } catch (createError) {\n      \n      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð° Post:', createError);\n      throw createError; // ÐŸÑ€Ð¾Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð´Ð°Ð»ÑŒÑˆÐµ Ð´Ð»Ñ Ð¾Ð±Ñ‰ÐµÐ¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸\n    }\n  } catch (error) {\n    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð¿Ð¾ÑÑ‚Ð°:', error);\n    console.error('Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸:', {\n      name: error.name,\n      message: error.message,\n      stack: error.stack,\n      errors: error.errors,\n      code: error.code\n    });\n    \n    \n    if (error.name === 'ValidationError') {\n      const validationErrors = Object.values(error.errors || {}).map(err => err.message);\n      return res.status(400).json({\n        success: false,\n        message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…',\n        errors: validationErrors,\n        error: error.message,\n      });\n    }\n    \n    \n    if (error.code === 10334 || \n        (error.message && (\n          error.message.includes('too large') || \n          error.message.includes('document is too large') ||\n          error.message.includes('exceeds maximum') ||\n          error.message.toLowerCase().includes('bson')\n        ))) {\n      return res.status(400).json({\n        success: false,\n        message: 'Ð Ð°Ð·Ð¼ÐµÑ€ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ÑÑ‚Ð° Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°ÐµÑ‚ Ð»Ð¸Ð¼Ð¸Ñ‚ MongoDB (16MB). ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑƒÐ¼ÐµÐ½ÑŒÑˆÐ¸Ñ‚Ðµ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ð¸Ð»Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð¼ÐµÐ½ÑŒÑˆÐµ Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ð¹. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð¾Ð¼ Ð½Ðµ Ð±Ð¾Ð»ÐµÐµ 10-12MB.',\n        error: error.message,\n        errorCode: error.code,\n      });\n    }\n    \n    \n    if (error.message && error.message.includes('BSON')) {\n      return res.status(400).json({\n        success: false,\n        message: 'Ð Ð°Ð·Ð¼ÐµÑ€ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ÑÑ‚Ð° ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð´Ð»Ñ MongoDB. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑƒÐ¼ÐµÐ½ÑŒÑˆÐ¸Ñ‚Ðµ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹.',\n        error: error.message,\n      });\n    }\n    \n    return res.status(500).json({\n      success: false,\n      message: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð¿Ð¾ÑÑ‚Ð°. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒ ÑÐµÑ€Ð²ÐµÑ€Ð° Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹.',\n      error: error.message,\n      errorName: error.name,\n      errorCode: error.code,\n    });\n  }\n};\n\n\nconst updatePost = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const { caption, title, image, images, isVideo, profileId } = req.body || {};\n\n    if (!req.user || !req.user._id) {\n      return res.status(401).json({\n        success: false,\n        message: 'User not authenticated',\n      });\n    }\n\n    const post = await Post.findById(id);\n\n    if (!post) {\n      return res.status(404).json({\n        success: false,\n        message: 'Post not found',\n      });\n    }\n\n    if (String(post.user) !== String(req.user._id)) {\n      return res.status(403).json({\n        success: false,\n        message: 'You are not allowed to edit this post',\n      });\n    }\n\n    if (typeof caption === 'string') {\n      const nextCaption = caption.trim();\n      if (nextCaption.length > 2200) {\n        return res.status(400).json({\n          success: false,\n          message: 'Caption must be less than 2200 characters',\n        });\n      }\n      post.caption = nextCaption;\n    }\n\n    if (title !== undefined && typeof title === 'string') {\n      const nextTitle = title.trim();\n      if (nextTitle.length > 300) {\n        return res.status(400).json({\n          success: false,\n          message: 'Title must be less than 300 characters',\n        });\n      }\n      post.title = nextTitle;\n    }\n\n    if (image && typeof image === 'string' && (image.startsWith('data:image/') || image.startsWith('data:video/'))) {\n      post.image = image;\n      const arr = Array.isArray(images) && images.length > 0 ? images : [image];\n      post.images = arr;\n      post.isVideo = typeof isVideo === 'boolean' ? isVideo : image.startsWith('data:video/');\n    }\n\n    if (profileId !== undefined) {\n      post.profileId = profileId && String(profileId).trim() ? String(profileId).trim() : null;\n    }\n\n    await post.save();\n\n    return res.status(200).json({\n      success: true,\n      post: {\n        id: post._id,\n        image: post.image,\n        images: post.images,\n        isVideo: post.isVideo,\n        title: post.title || '',\n        caption: post.caption || '',\n        updatedAt: post.updatedAt,\n      },\n    });\n  } catch (error) {\n    console.error('Update post error:', error);\n    return res.status(500).json({\n      success: false,\n      message: 'Server error during updating post',\n      error: error.message,\n    });\n  }\n};\n\n\nconst getMyPosts = async (req, res) => {\n  try {\n    if (!req.user || !req.user._id) {\n      console.error('ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² req.user');\n      return res.status(401).json({\n        success: false,\n        message: 'User not authenticated',\n      });\n    }\n\n    const rawProfileId = req.query && req.query.profileId;\n    const profileId =\n      typeof rawProfileId === 'string' && rawProfileId.trim()\n        ? rawProfileId.trim()\n        : null;\n\n    console.log('Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÑ‚Ð¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:', {\n      userId: req.user._id,\n      username: req.user.username,\n      profileId,\n    });\n\n    const filter = { user: req.user._id };\n    \n    if (profileId) {\n      filter.$or = [\n        { profileId },\n        { profileId: null },\n        { profileId: '' },\n        { profileId: { $exists: false } },\n      ];\n    }\n\n    let posts = [];\n    try {\n      posts = await Post.find(filter)\n        .sort({ createdAt: -1 })\n        .lean();\n    } catch (findError) {\n      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Post.find:', findError);\n      return res.status(500).json({\n        success: false,\n        message: 'Database error while fetching posts',\n        error: findError.message,\n      });\n    }\n\n    console.log('ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð¿Ð¾ÑÑ‚Ð¾Ð²:', posts.length);\n\n    const formatted = (posts || []).map((post) => {\n      if (!post) return null;\n      const liked = Array.isArray(post.likes) && post.likes.some(\n        (lid) => lid && String(lid) === String(req.user._id)\n      );\n      return {\n        id: post._id,\n        profileId: post.profileId != null ? String(post.profileId) : null,\n        image: post.image || '',\n        images: post.images && post.images.length > 0 ? post.images : [post.image].filter(Boolean),\n        isVideo: !!post.isVideo,\n        title: post.title != null ? String(post.title) : '',\n        caption: post.caption || '',\n        createdAt: post.createdAt,\n        updatedAt: post.updatedAt,\n        likesCount: (post.likes && post.likes.length) || 0,\n        commentsCount: (post.comments && post.comments.length) || 0,\n        viewsCount: post.views || 0,\n        liked: !!liked,\n      };\n    }).filter(Boolean);\n\n    return res.status(200).json({\n      success: true,\n      posts: formatted,\n      count: formatted.length,\n    });\n  } catch (error) {\n    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð¿Ð¾ÑÑ‚Ð¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:', error);\n    console.error('Ð¡Ñ‚ÐµÐº Ð¾ÑˆÐ¸Ð±ÐºÐ¸:', error.stack);\n    return res.status(500).json({\n      success: false,\n      message: 'Server error during fetching user posts',\n      error: error.message,\n    });\n  }\n};\n\n\nfunction getPostAuthorUser(post) {\n  const u = post.user;\n  if (!u) return { id: null, username: 'Unknown', fullName: 'Unknown User', avatar: '', avatarType: 'image' };\n  const profileId = post.profileId && String(post.profileId).trim();\n  const profile = profileId && Array.isArray(u.profiles)\n    ? u.profiles.find((p) => p && String(p.id) === profileId)\n    : null;\n  return {\n    id: u._id,\n    username: profile && profile.username ? String(profile.username) : (u.username || 'Unknown'),\n    fullName: u.fullName || 'Unknown User',\n    avatar: profile && profile.avatar ? String(profile.avatar) : (u.avatar || ''),\n    avatarType: profile && profile.avatarType ? String(profile.avatarType) : (u.avatarType || 'image'),\n  };\n}\n\nconst getFeed = async (req, res) => {\n  try {\n    const limit = parseInt(req.query.limit, 10) || 20;\n    const maxLimit = 50;\n    const safeLimit = Math.min(limit, maxLimit);\n    const skip = parseInt(req.query.skip, 10) || 0;\n\n    const posts = await Post.find()\n      .sort({ createdAt: -1 })\n      .skip(skip)\n      .limit(safeLimit)\n      .populate('user', 'username fullName avatar avatarType profiles')\n      .lean();\n\n    const userId = req.user?._id;\n    const formatted = posts.map((post) => {\n      const liked = userId && Array.isArray(post.likes) && post.likes.some((lid) => lid && String(lid) === String(userId));\n      return {\n        id: post._id,\n        profileId: post.profileId != null ? String(post.profileId) : null,\n        image: post.image,\n        images: post.images && post.images.length > 0 ? post.images : [post.image], \n        isVideo: post.isVideo || false,\n        title: post.title != null ? String(post.title) : '',\n        caption: post.caption || '',\n        createdAt: post.createdAt,\n        updatedAt: post.updatedAt,\n        user: getPostAuthorUser(post),\n        likesCount: post.likes?.length || 0,\n        commentsCount: post.comments?.length || 0,\n        viewsCount: post.views || 0,\n        liked: !!liked,\n      };\n    });\n\n    return res.status(200).json({\n      success: true,\n      posts: formatted,\n      count: formatted.length,\n    });\n  } catch (error) {\n    console.error('Get feed error:', error);\n    return res.status(500).json({\n      success: false,\n      message: 'Server error during feed fetch',\n      error: error.message,\n    });\n  }\n};\n\n\nconst deletePost = async (req, res) => {\n  try {\n    const { id } = req.params;\n\n    const post = await Post.findById(id);\n\n    if (!post) {\n      return res.status(404).json({\n        success: false,\n        message: 'Post not found',\n      });\n    }\n\n    \n    if (String(post.user) !== String(req.user._id)) {\n      return res.status(403).json({\n        success: false,\n        message: 'You can delete only your own posts',\n      });\n    }\n\n    await post.deleteOne();\n\n    return res.status(200).json({\n      success: true,\n      message: 'Post deleted successfully',\n      id,\n    });\n  } catch (error) {\n    console.error('Delete post error:', error);\n    return res.status(500).json({\n      success: false,\n      message: 'Server error during post deletion',\n      error: error.message,\n    });\n  }\n};\n\n/**\n * ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¿Ð¾ÑÑ‚Ð° Ñ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÑÐ¼Ð¸\n * GET /api/posts/:id\n */\nconst getPostById = async (req, res) => {\n  try {\n    const { id } = req.params;\n\n    const post = await Post.findById(id)\n      .populate('user', 'username fullName avatar avatarType profiles')\n      .populate('comments.user', 'username fullName avatar avatarType profiles')\n      .populate('comments.replies.user', 'username fullName avatar avatarType profiles')\n      .lean();\n\n    if (!post) {\n      return res.status(404).json({\n        success: false,\n        message: 'Post not found',\n      });\n    }\n\n    const userId = req.user?._id;\n    const liked = userId && Array.isArray(post.likes) && post.likes.some((lid) => lid && String(lid) === String(userId));\n    const formatted = {\n      id: post._id,\n      image: post.image,\n      images: post.images && post.images.length > 0 ? post.images : [post.image], // ÐœÐ°ÑÑÐ¸Ð² Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹\n      isVideo: post.isVideo || false,\n      title: post.title != null ? String(post.title) : '',\n      caption: post.caption || '',\n      createdAt: post.createdAt,\n      updatedAt: post.updatedAt,\n      user: getPostAuthorUser(post),\n      likesCount: post.likes?.length || 0,\n      commentsCount: post.comments?.length || 0,\n      viewsCount: post.views || 0,\n      liked: !!liked,\n      comments: (post.comments || []).map((comment) => ({\n        id: comment._id,\n        user: {\n          id: comment.user?._id,\n          username: comment.user?.username || 'Unknown',\n          fullName: comment.user?.fullName || 'Unknown User',\n          avatar: comment.user?.avatar || '',\n        },\n        text: comment.text,\n        createdAt: comment.createdAt,\n        repliesCount: (comment.replies || []).length,\n        replies: (comment.replies || []).map((reply) => ({\n          id: reply._id,\n          user: {\n            id: reply.user?._id,\n            username: reply.user?.username || 'Unknown',\n            fullName: reply.user?.fullName || 'Unknown User',\n            avatar: reply.user?.avatar || '',\n          },\n          text: reply.text,\n          createdAt: reply.createdAt,\n        })),\n      })),\n    };\n\n    return res.status(200).json({\n      success: true,\n      post: formatted,\n    });\n  } catch (error) {\n    console.error('Get post by id error:', error);\n    return res.status(500).json({\n      success: false,\n      message: 'Server error during fetching post',\n      error: error.message,\n    });\n  }\n};\n\n/**\n * Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ñ Ðº Ð¿Ð¾ÑÑ‚Ñƒ\n * POST /api/posts/:id/comments\n * body: { text: string, parentCommentId?: string }\n */\nconst addComment = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const { text, parentCommentId } = req.body || {};\n\n    if (!text || typeof text !== 'string' || text.trim().length === 0) {\n      return res.status(400).json({\n        success: false,\n        message: 'Comment text is required',\n      });\n    }\n\n    if (text.length > 500) {\n      return res.status(400).json({\n        success: false,\n        message: 'Comment must be less than 500 characters',\n      });\n    }\n\n    const post = await Post.findById(id);\n\n    if (!post) {\n      return res.status(404).json({\n        success: false,\n        message: 'Post not found',\n      });\n    }\n\n    // Ð•ÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½ parentCommentId, ÑÑ‚Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚ Ð½Ð° ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹\n    if (parentCommentId) {\n      const parentComment = post.comments.id(parentCommentId);\n      if (!parentComment) {\n        return res.status(404).json({\n          success: false,\n          message: 'Parent comment not found',\n        });\n      }\n\n      parentComment.replies.push({\n        user: req.user._id,\n        text: text.trim(),\n      });\n\n      await post.save();\n\n      // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾ÑÑ‚ Ñ populate\n      const updatedPost = await Post.findById(id)\n        .populate('comments.replies.user', 'username fullName avatar');\n\n      const updatedParentComment = updatedPost.comments.id(parentCommentId);\n      const newReply = updatedParentComment.replies[updatedParentComment.replies.length - 1];\n\n      return res.status(201).json({\n        success: true,\n        comment: {\n          id: newReply._id,\n          user: {\n            id: newReply.user?._id,\n            username: newReply.user?.username || 'Unknown',\n            fullName: newReply.user?.fullName || 'Unknown User',\n            avatar: newReply.user?.avatar || '',\n          },\n          text: newReply.text,\n          createdAt: newReply.createdAt,\n        },\n        isReply: true,\n      });\n    } else {\n      // ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹\n      post.comments.push({\n        user: req.user._id,\n        text: text.trim(),\n      });\n\n      await post.save();\n\n      // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾ÑÑ‚ Ñ populate\n      const updatedPost = await Post.findById(id)\n        .populate('comments.user', 'username fullName avatar')\n        .lean();\n\n      const newComment = updatedPost.comments[updatedPost.comments.length - 1];\n\n      return res.status(201).json({\n        success: true,\n        comment: {\n          id: newComment._id,\n          user: {\n            id: newComment.user?._id,\n            username: newComment.user?.username || 'Unknown',\n            fullName: newComment.user?.fullName || 'Unknown User',\n            avatar: newComment.user?.avatar || '',\n          },\n          text: newComment.text,\n          createdAt: newComment.createdAt,\n        },\n        isReply: false,\n      });\n    }\n  } catch (error) {\n    console.error('Add comment error:', error);\n    return res.status(500).json({\n      success: false,\n      message: 'Server error during adding comment',\n      error: error.message,\n    });\n  }\n};\n\n/**\n * Ð£Ð²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð¸Ðµ ÑÑ‡ÐµÑ‚Ñ‡Ð¸ÐºÐ° Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¾Ð² Ð¿Ð¾ÑÑ‚Ð°\n * POST /api/posts/:id/views\n */\nconst incrementViews = async (req, res) => {\n  try {\n    const { id } = req.params;\n\n    const post = await Post.findByIdAndUpdate(\n      id,\n      { $inc: { views: 1 } },\n      { new: true }\n    );\n\n    if (!post) {\n      return res.status(404).json({\n        success: false,\n        message: 'Post not found',\n      });\n    }\n\n    return res.status(200).json({\n      success: true,\n      viewsCount: post.views,\n    });\n  } catch (error) {\n    console.error('Increment views error:', error);\n    return res.status(500).json({\n      success: false,\n      message: 'Server error during incrementing views',\n      error: error.message,\n    });\n  }\n};\n\n/**\n * ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð»Ð°Ð¹ÐºÐ° Ð¿Ð¾ÑÑ‚Ð°\n * POST /api/posts/:id/like\n */\nconst toggleLike = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const post = await Post.findById(id);\n    if (!post) {\n      return res.status(404).json({ success: false, message: 'Post not found' });\n    }\n    const userId = req.user._id;\n    const likes = post.likes || [];\n    const index = likes.findIndex((lid) => lid && lid.toString() === userId.toString());\n    let liked;\n    if (index >= 0) {\n      post.likes.splice(index, 1);\n      liked = false;\n    } else {\n      post.likes.push(userId);\n      liked = true;\n    }\n    await post.save();\n    return res.status(200).json({\n      success: true,\n      liked,\n      likesCount: post.likes.length,\n    });\n  } catch (error) {\n    console.error('Toggle like error:', error);\n    return res.status(500).json({\n      success: false,\n      message: 'Server error',\n      error: error.message,\n    });\n  }\n};\n\nmodule.exports = {\n  createPost,\n  getMyPosts,\n  getFeed,\n  deletePost,\n  getPostById,\n  addComment,\n  incrementViews,\n  toggleLike,\n  updatePost,\n};\n\n"
        }
    ]
}